# 五大 AWS 安全错误:S3 漏桶

> 原文：<https://devops.com/top-5-aws-security-mistakes-leaky-s3-buckets/>

当我们准备在即将到来的 DevOps.com 网络研讨会上讨论我们的[五大 AWS 安全错误列表](https://webinars.devops.com/top-5-aws-security-mistakes-and-how-to-stop-them-before-you-lose-data)时，我们希望提供我们将讨论的信息的类型和深度的预览。由于人们谈论最多，也可能是最容易受到攻击的 AWS 安全方面不可避免地是那些泄漏的 S3 桶，所以假定我们将首先解决 S3。

在本文中，我们将深入研究 S3 数据桶，解释它们是如何变得易受攻击的，涵盖它们本来就对公众开放的八种不同方式，以及如何查找和保护任何面向公众的 S3 数据。

## S3 桶

S3 是 AWS 中最古老的服务之一——如此古老，以至于它的某些部分仍然支持基于 XML 的策略，而不是你在其他地方看到的 JSON。S3 还有很多不太为人所知或不再常用的特性，比如允许其他人托管 put 对象到您的桶中，但仍然保持对它们的所有权。

可以把 S3 存储桶想象成一个拥有子目录和文件的服务器。因为 S3 存储桶可以有不同的根 url(例如“dops.s3.amazonaws.com”)并有自己的生命周期和设置，所以我们倾向于将存储桶视为服务器，而不是目录。此外，S3 的目录允许你组织对象，但是除了名字之外，没有任何自己独特的设置。

AWS 需要支持广泛的用例，这就是我们拥有所有这些机制的原因。在一个账户内、账户之间、托管网站等等公开分享，会产生复杂性。好消息是 S3 总是默认安全和隐私。坏消息是 AWS 允许人类使用它(因此削弱了安全性),并且管理起来会很混乱。例如，S3 支持读和写权限(对于桶，还支持列表)。有可能没有公共读取权限，但有公共写入权限，这可能会导致人们将坏文件放在您的目录中。

## AWS 数据公开的 8 种方式

至少有八种不同的方式可以让 AWS S3 桶无意中向公众公开，并暴露于数据泄露。

*   **Bucket ACL(访问控制列表):**这是一个定义了第一层访问的 XML 文档。默认情况下，只有帐户所有者可以访问，但这可以对其他 AWS 帐户或公众开放。亚马逊建议根本不要使用这些，但这也是快速公开一些东西的最简单的方法，所以我们一直都在看到它。
*   **Bucket Policies:** 这些是超级灵活的 JSON 策略，允许您在 Bucket 上设置基于 IP 和其他条件的权限。虽然这应该是管理公共访问的主要方式，但 ACL 是第一个选项卡，只需点击三次就可以公开。正是这种灵活性导致了一些错误，比如向比预期更大范围的 IP 地址开放，或者使用否定来阻止对某些 IP 地址的访问，但却无意中向其他所有人授予了访问权限。
*   **IAM 策略:**这些是您用来控制整个 AWS 帐户访问权限的常规 IAM 权限。您不能向他们公开 bucket，因为他们只管理 AWS 用户，但是您可以通过授权另一个 AWS 服务访问来开放对 bucket 的访问，然后该服务公开内容。
*   **对象 ACL:**这些是主要的对象级控件。它就像一个 bucket ACL，使用 XML 允许来自其他帐户或公众的访问。对象不一定继承 bucket ACLs。即使桶是私有的，你也完全可以把一个对象变成公共的。
*   **显式 IAM 或存储桶策略语句:** IAM 策略和存储桶策略可以有引用对象的显式语句，这些语句将覆盖对象 ACL(如果您拥有该对象)，因为它们首先被评估。
*   **预签名的 URL:**这些对象级策略必须使用代码(而不是控制台)创建，并为拥有该 URL 的任何人提供临时访问权限。例如，它用于共享文件几分钟或一小时，供使用你的应用程序下载媒体文件的人使用。
*   **CloudFront Origin 访问身份:** CloudFront 是 AWS 内容交付网络，可以作为 S3 的前端。您可以创建一个名为 CloudFront origin access identity 的东西来编写一个 IAM 策略，允许 CloudFront 访问 S3 内容。如果 CloudFront 允许公共访问，它可以访问 S3 内容，这不会显示在存储桶策略或 ACL 中。
*   **跨来源资源共享(CORS)策略:**如果您在网站中使用 S3，并且不希望浏览器因相同的站点安全设置而中断，则需要 CORS。S3 的 CORS 不会覆盖 ACL 或 bucket 策略，但可以在有限的情况下屏蔽公共访问，在这些情况下，数据通过授权的网站暴露在 web 代码中。

综上所述，AWS 首先评估 IAM 权限。其中，唯一在 web 上公开 bucket 的是 CloudFront Origin Access 身份。然后，AWS 转向 bucket ACLs 和策略，查找任何显式的 deny 语句。然后，它查看公共访问的对象 ACL。如果您将一个对象设为公共的，而 bucket 策略没有显式的 deny，那么它仍然是公共的，但除此之外，一个好的 bucket 策略将会阻止一切。此外，很多问题是开放桶 ACL，而不是对象 ACL。

## 找到您的公共 S3 存储桶并保护您的数据的 4 种方法

找公桶最好的方法是什么？相对容易。

1.  登录到控制台，点击 S3，并寻找公共标签。AWS 使用一些高级的后端数学来评估所有的 bucket 策略，以确定某个东西是否是公共的，这捕捉到了大多数边缘情况，但是它没有显示 bucket 是否是私有的以及其中的对象是否是公共的。
2.  检查 CloudFront 以查看您是否使用了任何原始访问身份。在这里看比在你所有的桶政策中更容易(通常)。这也省去了您查看对象 ACL 的时间。
3.  检查任何 CORS 政策，如果你使用它们。这是最不常见的情况，我甚至不愿意在这篇文章中提及它们。
4.  坏消息是……没有简单的方法找到公共对象。如果您有大量的数据，那么即使以编程方式找到它们也会很困难。此外，更改 bucket ACL 不会级联到 object ACLs，因此您需要逐个运行并修复它们。但是，如果 bucket 被锁定，攻击者需要知道对象的完整 URL/名称才能找到它。虽然不完美，但总比没有强。

就是这样。但是，如果你知道任何其他边缘案件，请不要犹豫[让我们知道](https://disruptops.com/)。在进行评估时，我们发现超过 90%的问题只是基本的 bucket ACL 和策略错误。对象 ACL 也是一个问题，但风险稍低，因为如果您的 bucket 受到适当保护，您需要确切的 URL 来找到它们。

如果你对 AWS 的其他 4 大安全错误感兴趣，[报名参加 8 月 14 日的网络研讨会](https://webinars.devops.com/top-5-aws-security-mistakes-and-how-to-stop-them-before-you-lose-data)。

— [迈克·罗斯曼](https://devops.com/author/mike-rothman/)