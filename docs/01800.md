# DevOps 聊天:Airbnb 的持续交付

> 原文:[https://devo PS . com/devo PS-chat-continuous-delivery-at-Airbnb/](https://devops.com/devops-chat-continuous-delivery-at-airbnb/)

Spinnaker Summit 2019 预览:Airbnb 正在迅速从 monolith Ruby on Rails 应用程序转向 Kubernetes 中的分布式 SOA/Kubernetes 架构。新架构使用自助式编码管道和简单的 webhook 集成、规模采用和全公司协作。尽管持续集成对 Airbnb 来说并不新鲜，但现在每个团队都需要能够在 AWS EC2 中跨 100 个容器化服务扩展 CI。

软件工程师 Brian Wolfe 共同领导了迁移到 Spinnaker 并构建更多自动化的决定。在项目进行一年的时候，Airbnb 已经有 40 项服务投入生产，接下来还会有更多。

这一集的 DevOps 聊天主要是 Brian 的演讲“扩展迁移到持续交付(Airbnb)”的预览。布莱恩的演讲将于 11 月 16 日星期六上午 11 点在圣地亚哥举行的 2019 年 Spinnaker 峰会上进行。

像往常一样，下面是流媒体音频，然后是我们的谈话记录。

[https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/697825345&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true](https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/697825345&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true)

## 副本

米奇·阿什利:大家好。我是 DevOps.com 的米奇·阿什利，您正在收听的是另一个 DevOps 聊天播客。今天我邀请到了布莱恩·沃尔夫，他是 Airbnb 的一名软件工程师。我们的主题是他将在圣地亚哥举行的 2019 年 Spinnaker 峰会上发表的演讲。演讲的主题是从迁移到持续交付的扩展。持续交付是现在的热门话题。这将发生在 11 月 16 日星期六上午 11 点

布莱恩，欢迎来到 DevOps 聊天。

布莱恩·沃尔夫:非常感谢你，米奇。今天很荣幸能和你谈话，所以。

阿什莉:我很荣幸你能来。感谢你抽出时间。告诉我们一些关于你的事情。介绍一下你自己，告诉我们你是做什么的，我想我们知道 Airbnb，但请告诉我们你在 Airbnb 的哪个部门工作。

**沃尔夫:**爽。是的，所以我假设大多数听播客的人都知道 Airbnb 是什么，但我们是一个由主人和客人组成的全球社区。我们把人们聚集在一起，体验真正的本地生活。我要跳过剩下的那些小故事。

**阿什利:** *【笑】*

**Wolfe:** 但我已经在 Airbnb 工作了大约三年半，大部分时间我都在运营工具方面，所以很多工作都是可观察性工作，所以查看你的指标、跟踪和日志，然后是性能工作，就像弄清楚如何让 Airbnb——监控 Airbnb 的性能，让它更快等等。去年，我一直是我们持续交付团队的技术负责人，这是一个有着雄心壮志的团队。我们还没到那一步。但这个团队的目标是真正提升我们在 Airbnb 交付软件的水平。

因此，我的经验主要是看我们如何从过去两年用 Ruby on Rails 编写的 monolith 过渡到 SOA，并延续到 2020 年。其中一部分是我们如何扩展我们交付软件的方式。它曾经是一个更核心的团队，知道如何扩展我们的整体。现在，每个团队都需要知道如何交付软件，如何扩展软件，以及如何保持软件正常工作。

Ashley: 现在，我们转向 SOA，也就是说面向服务的架构，对吗？你指的是这个吗？

沃尔夫:是啊。

**Ashley:** 是向这种架构的转变促使你——或命令 Airbnb 在这种自动化的持续交付上投入如此之多吗？或者这种情况是同时发生的？给了我们一点这种结合的背景。

**Wolfe:** 是的，所以这肯定是因为迁移到 SOA 而发生的。如果你看看我们以前的流程，它非常整合。大多数人都在应用相同的代码库。所以你可以有一些实践来为那个代码库工作。但是，随着我们转向 SOA，我们现在有数百个正在部署的服务，您需要能够在所有这些服务中扩展这些最佳实践。因此，这需要你添加这些自动化部分，以便人类可以犯更少的错误。

阿什莉:这很有道理。我想你有一种持续的集成发生在前端，对吗，导致你的持续交付？

**沃尔夫:**绝对是。所以我们已经持续整合了很长时间。所以我们所有的单元测试，诸如此类的事情，我们所有的构建都是在持续集成中进行的。这种情况至少持续了三四年。我们在这方面有相当成熟的工具。事实上，我们最近迁移到了我们的新平台，将我们所有的构建和 MCI 封装在一起，因此它可以以更统一的方式运行。

阿什利:嗯。是要搬到库伯内特吗？你指的是变化还是别的什么？

Wolfe: 所以即使是没有在 Kubernetes 上运行的东西，你可以想象 Airbnb 已经有 10 年的历史了，所以我们有很多技术历史。因此，有些东西将在裸露的 EC2 实例上运行，有些则在 Kubernetes 内部运行。因此，随着向 SOA 的迁移，我们也在向 Kubernetes 迁移。这种迁移正在快速进行。但是仍然会有很多东西需要在 EC2 上构建和运行。但是构建本身可以发生在容器内部。

阿什利:我知道我们不认为 Airbnb 是 10 年前建立的，并随着时间的推移而发展，对吗？我们认为它是*【相声】*—*【笑】*。

沃尔夫:对，对。你知道，对于这样一家 ____ 公司来说，它有着惊人的历史。

阿什利:这是一个有趣的情况，你知道，这是一个有趣的情况，因为你不是在谈论一个 30 年前或 20 年前构建的整体应用程序。这是最近的事，Ruby on Rails，你知道吗？所以它仍然是一种当代编程语言，大家都很熟悉。但是，即使是你也必须经历你自己的架构，以及该技术的持续交付发展。

**沃尔夫:**绝对是。我认为这有点令人惊讶，即使在一家成立 10 年的公司，你也有我们认为的遗留部分。我认为，在一个像我们这样发展迅速的领域，这种情况会很快发生。如果你看看连续交付在过去十年中是如何发展的，这是一个相当大的转变。

我们已经看到的一件大事是，如果你看看 2013-2014 年我们的系统和部署板，你会发现我们有一个非常好的部署解决方案。但如果你现在看看它，它看起来很像一个真正好的 CI 系统，像一个真正好的持续集成系统。实际上，我们有一个有组织的管道来自动完成部署，但我们内部还没有。这就是我们采用 Spinnaker 作为解决方案的真正原因。

**阿什利:**有意思。请告诉我们一些关于您是否参与了引进 Spinnaker 的选择？这是在你加入 Airbnb 的时候还是之前发生的？

**沃尔夫:**嗯嗯。所以去年决定采用 Spinnaker。所以这是我和我的经理以及车队里的晶晶和延斯之间的讨论。这主要是关于我们是否希望继续投资部署板，这是我们现有的解决方案。它与 Airbnb stack 的所有部分深度集成。里面有很多关于我们如何部署 MonoRail 的内容，这是我们的大型 Ruby on Rails 应用程序。

现在，我们是想在其中建立自动化，还是想引入一些新的东西？因此，我们做了一个大的研究项目，看看有哪些可用的选择，这些选择会给我们带来什么，以及我们如何在 Airbnb 实现这些选择。最后，我们决定不应该在我们的内部解决方案上投入更多，而是应该引入 Spinnaker 并对其进行定制，以便通过扩展将 Airbnb 的意见编码到其中，然后使用它作为我们向前发展的部署平台。

所以我们在这方面还处于早期。我们进行了大约一年。我们现在有大约 40 种服务。这些都是生产服务，是 Airbnb 的一些真正关键的服务。但是考虑到我们在 Airbnb 有成千上万的服务，要让它成为一个标准还有很多工作要做。

阿什利:嗯。非常好。很有趣。请告诉我们更多关于我所知道的内容。在您的演讲描述中，您谈到您将讨论自助服务编码管道和简单的 web hook 集成如何帮助您在整个公司范围内扩大采用和协作。告诉我们更多关于那是什么的信息。

是的，所以在一家像 Airbnb 一样快速发展的公司工作，最困难的事情之一就是很难满足每个人的需求。因此，如果可以的话，您希望实现一切自助服务，因此，您知道，我正在创建一个标准管道，您知道，我部署一个东西，进行一些 AB 比较，将其推广到我的下一个环境，再进行一次 canary analysis 推广，等等。

所以我可以想出人们可以使用的标准组件。但是你也有人们随着时间的推移建立起来的东西。因此，我们的研究团队有专门针对他们的回归检测。他们认为，如果发生了一些功能退化，这将提供非常重要的信号，因为您在响应包中有搜索排名和结果的实际布局等内容，如果您不希望它们发生变化，您需要确保这些内容不会发生变化。

因此，他们构建了一个服务来实际执行回归检测，并希望将其集成到他们部署的管道中。他们希望这只是每次运行部署时自动发生的事情。你部署到 staging，你用一些参数调用这个服务，你等待回归测试通过，然后如果它失败了，你提供一些自定义 UI 说，“好吧，这就是失败的地方。这就是为什么。这就是你可以进一步了解它的方法。”然后你进入下一个阶段，或者你失败了，弄清楚发生了什么。

我们想做的是让团队很容易插入这样的服务，因为它们确实提供了最大的价值。我们这样做的方式是，实际上，与我们内部使用的接口定义语言相集成。因此，我们实际上扩展了 Spinnaker，只提供了一个小的 web hook stage，人们可以重用它并调用它们的服务。但是除此之外，他们还有一个很好的用户界面。因此，它们可以在 Spinnaker 中提供基本的功能。对于我们来说，安装一个新的舞台是一件很简单的事情。这有意义吗？

阿什莉:是的。我正要问你这个。有时引入这样一个基础工具可能是一个真正的挑战，就像这是你的软件开发和交付过程的基础，你可以做什么来最小化中断，降低团队进入的门槛。这在很大程度上也取决于你的组织在多大程度上进行类似的软件处理，或者它是非常分散的，每个人都做自己的事情。这是一个应用程序，如果它处于一个整体的状态。我想人们在 Airbnb 的工作方式有很多相似之处。但你还是得想办法让这变得简单，对吧？

沃尔夫:是啊。因此，我认为我们很幸运，因为现在真的有一种人们使用的部署工具，那就是 deploy board。现在我们引入了第二个部署工具。我们在这里的策略实际上是让您第一次入职时的体验看起来更像部署板。

因此，Spinnaker 允许您定制用户界面。因此，我们在 Spinnaker 中实际上有一个面板，它显示的视图实际上看起来非常类似于您在我们的旧工具中获得的视图。但是，当您真正开始部署时，它会在幕后提供所有这些功能。这对于我们的入职来说非常有价值，因为它看起来没有什么不同，老实说，我会说有点粗糙。

你知道，我们花了很多时间来优化部署板流程。人们有时会有点困惑。但仅仅是让最初的体验看起来相似就让入职变得容易多了。当我们第一次提出使用 Spinnaker 时，人们就像这样，“我不知道 UI 中发生了什么。我不知道我在这里做什么。你们在想什么？”但是仅仅通过提供相似的观点，人们就会说，“哦，我知道该怎么做了。我只需单击这个按钮，它看起来与我们之前看到的一样，这应该会让我的部署开始做正确的事情。”

阿什利:你知道，永远不要低估易于使用的用户界面或流程的价值。

**Wolfe:** 特别是有了这种熟悉感，我认为——我的团队中的 Jens 一直在提倡真正推动，比如，使从我们的旧工具到我们的新工具的过渡变得容易。我要说的是，我们不得不面对一些可用性差距。但我要说，他们正在变得更好。

Ashley: 你们在这个项目的推广过程中进展如何？你是否仍处于第三阶段，与一些早期采用的团队一起工作？您现在是否正在更广泛地采用它？在这个成熟的过程中，你处于什么样的阶段？

**Wolfe:** 是的，所以我们正处于测试阶段。因此，在 alpha 阶段，我们确实遇到了一些早期采用者，那些愿意承担一些风险的人。现在，我们正在接纳一些大客户，他们要求很高，并确保这确实适合他们。因此，我们要做的是衡量我们预防了多少，预防了多少回退，预防了多少事故，并确保 Spinnaker 作为我们当前提供的平台，确实在提供业务价值。

我们将 2019 年的入职人数限制在大约 50 个团队。到 2019 年底，我们将对哪些可行、哪些不可行有一个真正的好主意。2020 年，我们将向整个公司开放领养。与此同时，我们正在进行大量的扩展练习，以确保我们实际上能够扩展到整个公司。

阿什利:让我们了解一下 50 个团队，这些团队的规模通常是多少？它们的范围是什么？

**Wolfe:** 是的，所以最小的团队可能是部署一项服务的六七名开发人员。我们最大的团队有大约 45 名开发人员。然后，我们的目标是我们的前端服务之一，它更加单一，因此将有数百名开发人员在其上工作。但是有一个运营专家团队来管理部署的情况。

阿什利:嗯。在不同规模的团队中，这是一个相当不错的范围。因此，我确信——以及应用程序的某些部分——它们会带来不同的挑战。你如何从你的决定中衡量成功，无论是走上实现连续交付的道路还是 Spinnaker？你谈到了商业价值。您还谈到了防止发生多少回退和事故。但是你如何向那些说我们要花这笔钱让你去实现它的人证明，并告诉他们这是值得的？

**沃尔夫:**共。这是一个很好的问题。所以对我们来说，最大的动力之一实际上是防止退化。裁谈会有两个方面。其中之一是提高开发人员的生产力。另一个是推出更有力的流程。我们绝对专注于积极的推广流程，并在默认情况下对每项服务进行自动金丝雀分析。这就是我们在 2019 年追求的路线，实际上是为了证明商业价值。

阿什利:嗯。

**Wolfe:** 到 2020 年，我们将有更多的指标和更大的能力来谈论我们的工程师有多高效，或者至少我们没有让故事变得更难。但是现在已经证明量化这一点有点困难。所以我们听到人们说，“是的，我们很喜欢。我们喜欢现在可以忽略部署过程。”但是，除了有一个 CSAT 式的分数，你只是说，你知道，在一到十的范围内评价你的生产力，很难量化我们看到的 Spinnaker 的生产力增长。

**Ashley:** 嗯，这通常是一个挑战，对我们在软件世界中实施技术来说，正如你已经谈到的一些回归测试问题，甚至可能是新旧流程中的事件，希望有一些你也可以从旧方法到新方法使用的度量标准，并给你一些开始的地方，至少，对那些东西进行基准测试。

**Wolfe:** 当然对于回归检测我们有。我们有强有力的证据表明，自动化这一管道——因此，我真正认为 Spinnaker 是自动化您的运行手册的一种方式。事实上，现在自动化已经减少了生产中的回归数量。在这一点上，我们有非常有力的证据。

**Ashley:** 好吧，希望你能唱一些赞美的歌，那些团队到目前为止从采用它的人们那里学到的好东西，因为你像大型团队一样接受了一些更大的挑战。

好了，现在，我很感谢你来参加播客。了解你将要谈论的话题是非常有趣的。我祝你在 Spinnaker 峰会上的演讲一切顺利。

非常感谢你，米奇。这是我的荣幸。我希望能很快见到你。

阿什莉:那太棒了。我会非常喜欢的。我要感谢今天的嘉宾 Brian Wolfe，他是 Airbnb 的软件工程师，他与我们分享了他使用 Spinnaker 的经验，以及他们如何迁移到连续交付模式并在组织中扩大规模。布莱恩将在 11 月 15 日至 19 日在圣地亚哥举行的 2019 年 Spinnaker 峰会上发表演讲。他的演讲是在 16 号周六上午 11 点，我相信你会和延斯·范德黑格一起做？对吗？

**Wolfe:** 对，没错。

**阿什利:**牛逼。很高兴你们两个都在上面。感谢大家今天的参与。我想感谢我们的听众花时间来看看播客，听听这个演讲。我是 DevOps.com[的米奇·阿什利。你听到了另一个 DevOps 和我的客人的谈话。在外面要小心。](https://devops.com/)

— [米切尔·阿什利](https://devops.com/author/mitchellashley/)