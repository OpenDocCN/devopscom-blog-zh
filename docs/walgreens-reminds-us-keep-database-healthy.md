# 沃尔格林提醒我们保持数据库健康

> 原文：<https://devops.com/walgreens-reminds-us-keep-database-healthy/>

很明显，你和你的团队开发的超级应用真的很棒，它很有可能成为“面包和黄油 3.0”，但是你做好最坏的打算了吗？很有可能一些超出你控制的数据、事件和环境的组合最终会与你作对，导致失败或软件缺陷。你可以试着预测和推理你的应用程序准备过程中可能出错的所有事情，但是在一个复杂的系统中，不可能预测所有的事情。

即使是大型组织，如沃尔格林或国务院，都有巨大的 IT 预算和大量的技术人员，也无法避免软件灾难。

几天前，由于数据库故障，沃尔格林一半的商店几个小时都无法按处方配药。公司发言人迈克尔·波尔津暗示，问题出现在一次数据库更新出错时，导致整个系统被关闭。这一事件显示了持续交付方法的风险，频繁地更新它所运行的软件，特别是如果发布包括数据库模式的变更。他们还能做得更好吗？这本来是可以避免的。更重要的是，本着 DevOps 的精神，可以更快地恢复到以前的版本吗？

对于这些类型的问题，后果甚至可能更严重，例如，美国国务院签发旅行证件的全球数据库——世界上最大的基于 Oracle 的数据仓库之一——上个月崩溃，导致可能数百万人在等待护照和签证时出现重大延误。

组织有哪些方法可以避免数据库更新影响哪怕是微不足道的前端软件更新？

1.  对系统进行全天候监控，以便尽早发现问题，并发现可能意味着潜在问题的异常模式。缓慢的数据库响应时间、数据库负载问题、不可预测的性能峰值和锁定问题预示着可能导致崩溃的严重并发症。要持续监视系统，您需要一款软件的帮助，如 [AppDynamics 的数据库监控](https://www.appdynamics.com/solutions/database-monitoring/)，它可以显示趋势关键性能指标，并在违反数据库阈值时发送警报，或者[日志条目异常检测](https://logentries.com/logentries-announces-machine-learning-analytics-for-ops-monitoring-real-time-alerting/)，它使您能够通过对异常活动或系统事件的实时警报，主动识别并解决性能问题。
2.  从规划开始，并准备好在系统崩溃后恢复数据库。
3.  通常，当数据库服务器停机时，当用户尝试连接时，会执行一个过程，通过自动执行崩溃恢复来尝试将数据库恢复到一致状态。使用保存在事务日志中的信息，所有已提交事务的所有效果都应该保存在数据库中，所有未提交的事务都应该回滚。如果成功，数据库在事务上是一致的，可以使用，但如果没有，我希望你有备份。正如我们的例子沃尔格林崩溃所表明的，你甚至需要一个更好的安全网:一个回滚策略，当你实施一个改变时，它是强制性准备的，因此从灾难中恢复变得快速、简单和可验证。
4.  覆盖或不匹配的修改可能会导致问题，例如，当开发人员处理应用程序的数据库映射对象，而 DBA 同时处理成批的更改时。强大的数据库变更管理系统是克服这些挑战的最有效方法。通过数据库版本控制(不仅是脚本或模型的版本控制，还包括发生在每个数据库实例中的第二级版本控制)、持续集成和自动化等特性，使所有数据库更改在不同部门和个人之间使用相同的工具和流程来执行，将使 DBA 和开发人员能够更好地相互交流和协作。
5.  用“它会崩溃”的理念来设计你的系统，所以要相信服务器会死，路由器或网络链接会随时崩溃。如果您有“无单点故障”数据库，其中数据被复制到几个节点，以避免节点故障期间的数据丢失，并且新的机器可以补充现有的机器，以增加集群的容量和数据保护，即使一个机器停机也没有关系。Amazon Dynamo 和 Apache Cassandra 就是这种类型的数据库，如果一个节点出现故障或变得不可访问，它们的故障转移过程允许自动尝试集群中的其他节点，并在后台安排与失效节点的重新连接。
6.  尽早评估目标环境的冲突和依赖性，例如使用 Forecast(来自 Datical)这样的模拟器。该软件在内存中创建目标环境的模型，在该模型的基础上模拟建议的更改，并在发生错误情况或发生数据丢失和性能问题时发出警报，而无需实际接触目标数据库。正因为如此，DB 管理员可以在开发周期中进行多次更改，以解决通常只有在预发布阶段才能发现的问题。

《今日美国》报道称，“至少有 55 个主要承包商参与了创建、管理或支持 HealthCare.gov，”福布斯进一步推测，该网站的部分数据故障源于需求阶段。如果是这样的话，这表明在一个涉及数百人的大型项目中，分析师和开发人员是分离的，可能是因为开发过程与收集需求的过程是分开监督的。

新的方法，比如看板，为开发运维提供了更好的选择，包括整个流程，最终交付，而不仅仅是开发过程，所以考虑改变你的方法。将 Scrum 转储为看板，改变了工作流，允许添加自动化数据库部署和发布到 DevOps 管道，这可能是一个更好的选择。

但是这并不简单，因为有几个挑战使得数据库难以部署:它们的复杂性、庞大的规模(数据量)、特定于生产的工具和配置，等等。这些问题本身都不是必须解决的问题，但是，综合起来，它们会对成功部署造成严重威胁。

如何提高数据库的可部署性？

1.  进行性能调优是很诱人的，但只应在预运行环境中进行，因为在生产中应尽量减少更改，理想情况下，生产中应进行的唯一数据库更改是对实时数据的更改。
2.  正确地设计它，并通过将非核心数据和逻辑移出主表，它将降低数据库的复杂性，并使其更易于理解。
3.  数据库归档应该是您的企业战略的一个强制性部分。归档不常请求的数据可以提高性能，并从根本上减小数据库的大小。
4.  将一个数据库分成几个部分。考虑信息架构并分析您的数据系统，将理应属于大型中央数据库的数据与出于惯性或方便而添加的数据分开，并分别存储它们。事件源、命令查询责任分离和基于消息队列的发布/订阅异步等模式可以处理多个数据存储的情况，并可以帮助您进行设计。
5.  通过在同一个事务数据库上结合报告和生产查询来获得 BI(商业智能)并不是一个好主意。生产查询很短，除了读取、更新和插入之外还执行其他操作，而报告查询是只读的，但运行时间较长，可能涉及多个表中的许多记录，以产生聚合结果。问题是，运行时间较长的报告查询可能会妨碍生产查询，妨碍它们的及时执行，并造成性能问题，因此可以通过使用单独的报告数据库来避免这一问题。
6.  创建一个实验室。这是关键。它不仅包括软件层，还包括后端以及与您的生产环境相匹配的所有基础架构。起初会有很多初始开销，但像 AWS、Azure、 [CloudShare](http://www.cloudshare.com) 这样的 IaaS 工具可以帮助加快设置和维护的速度。一旦使用 ScriptRock 等工具设置了实验室以确保一致性，或者使用一致的 Chef 和 Puppet 脚本定期编写实验室脚本将确保一致性。
7.  如果开发中的数据库技术、配置和特性与生产中的不同，那么在部署之前很难预测行为。如果某个许可的成本高得令人望而却步，以至于它只能在一种环境中使用，那么最好避免它，因为未经测试的系统的不可预测性是不可接受的。不要使用仅用于生产的数据库技术、工具和配置。
8.  DBA 通常喜欢使数据库尽可能易于管理，尤其是当它非常复杂时，但是尽管为了易于管理而优化数据听起来很有吸引力，但这可能会造成部署上的麻烦。例如，将数据聚集在同一个事务数据库中以使审计变得容易，这对于 DBA 来说很容易，但是这不利于可部署性。因此，不要为了便于管理而优化数据。

开发运维组织中的新型数据库角色是开发和运营团队中的应用型数据库管理员，而不是 IT 人员，他们不仅应该是开发环境中的数据专家，还应该熟悉扩展和灾难场景，能够预见这些中断并降低其影响。

您不仅可以帮助减少部署期间数据库问题的影响，还可以使应用程序稳定地恢复到以前的版本变得更加容易。让你像沃尔格林一样远离新闻。