# 主动监控

> 原文:[https://devops.com/proactive-monitoring/](https://devops.com/proactive-monitoring/)

我认为，大多数 DevOps 讨论都集中在测试代码变更，以自动化的方式将它打包并部署到生产中。然而，棘手的站点关闭问题最终会迫使任何新生的生产工程团队将监控作为未来的重中之重。

在我看来，如果在将代码部署到生产环境之前，运行功能、集成和验收测试来验证代码更改，那么类似的检查应该是监控的一部分，以确保应用程序在生产环境中也能按照设计正常工作。在生产中，代码更改不仅仅是影响应用程序的因素。操作系统更新、网络配置更改、第三方工具的自动升级、系统资源的可用性等。也会影响生产中的应用。但是，我还没有遇到任何集成测试和监控工作的框架。

在传统的以系统管理员为中心的环境中，监控范围没有超出基础设施层。负责监控的运营团队可能不了解基础架构之外需要监控的内容。对于后者，现成的解决方案在 Nagios 等流行的监控平台上很容易获得。

这里尝试对生产中的监控要求进行分类。这些要求是通用的，适用于任何托管在内部、数据中心或云中的系统。测试代码变更和监控生产的系统化和前瞻性计划将有助于防止生产中的事故。测试分类和实现它们的工具已经存在了一段时间，几乎不需要任何额外的关注。本文试图对监控类型进行分类，并记录它们的实现方法。

**监控基础设施**

承载应用程序环境的基础设施将由多个组件组成:服务器、存储设备、负载平衡器等。检查这些设备的健康状况是监控的最基本要求。流行的监控平台支持开箱即用的特性。除了为这些指标设置正确的警报阈值之外，几乎不需要定制。

**监控平台**

一个应用程序通常会使用多个第三方工具来构建，如数据库、RDBMS (MySQL、Postgres)和 NoSQL (MongoDB、Couchbase、Cassandra)数据仓库；全文搜索引擎(elastic search)；大数据平台(Hadoop、Spark)；信息系统(rabbit MQ)；内存对象缓存系统(Memcache，Redis)；以及 BI 和报告工具(Microstrategy、Tableau)。检查这些应用程序组件的健康状况也很重要。这些工具中的大多数都提供了一些接口，主要是通过 REST API，这些接口可以用来在主监控平台上实现插件。

**监控应用**

一个健康的基础设施和平台不足以让应用程序正常运行。最近部署的错误代码、第三方组件问题或与外部系统不兼容的更改都可能导致应用程序失败。可以实现应用程序级检查来检测此类问题。如前所述，功能测试或集成测试会在测试/试运行环境中发现此类问题，并且还应该在生产环境中实施等效的测试。

通过在应用程序中构建钩子或 API 端点，可以简化应用程序级监控的实现。监控通常是事后才想到的，在应用程序的设计阶段，这种仪器的要求被忽略了。DevOps 团队参与设计评审提高了系统的可操作性。在生产中规划应用级监控是 DevOps 可以提供意见的一个领域。

**监控业务**

应用程序在生产环境中运行，以满足特定的业务目标。您可以拥有一个在健康的基础设施上完美运行的应用程序，但业务仍然可能达不到其目标。尽早向业务部门提供反馈以采取纠正措施非常重要，这些措施可能会触发应用程序功能的增强和/或要求使用该应用程序的业务运营方式。这些工作应该只是对更复杂的基于 BI 的数据分析方法的补充，这些方法可以提供对业务状态的更深入的见解。业务级监控可以基于数据存储库中容易获得的交易数据和由 BI 系统生成的数据集合。

应用程序和业务级别的监控都是特定于公司的，并且，必须为这种监控需求开发插件。实现一些框架来访问来自监控平台的标准信息源，如数据库和 REST APIs，可以最大限度地减少每次从头构建插件的需求。

**最后一英里监控**

部署在应用程序也在其中运行的相同云或数据中心环境中的监控平台无法检查终端用户体验。为了弥补这一差距，市场上有几种 SaaS 产品，如 Catchpoint 和 Apica。这些服务由实际的基础设施支持，以监控特定地理位置的应用程序。例如，如果你很想知道你的移动应用在芝加哥的 iPhones 上表现如何，可以使用服务提供商在芝加哥的测试基础设施进行跟踪。

如果应用程序无法从外部访问，或者应用程序存在性能问题，这些工具上会设置警报来通知站点可靠性团队。

**日志聚合**

在生产环境中，操作系统、平台组件和应用程序会在各种日志文件中记录大量信息。当问题发生时，他们会得到一些关注，否则通常会被忽略。传统的监控工具如 Nagios 无法处理不断变化的日志文件，只能对某些模式发出警报。

Logstash、Loggly 和 Splunk 等日志聚合工具的出现改变了这种情况。使用聚合日志和索引日志，有可能检测到以前没有注意到的问题。可以根据索引日志数据中的可用信息设置警报。例如，Splunk 提供了一种自定义查询语言来搜索索引以获得运营见解。使用这些工具提供的 API，警报实际上可以与主监控平台集成。

为了利用这些工具的聚合和索引功能，可以由应用程序或脚本生成结构化数据输出，这些输出稍后将由日志聚合工具进行索引。这种数据聚合可用于为报告应用程序生成数据。例如，如果必须跟踪一组计算节点上的存储使用情况，则可以在聚集工具可以跟踪的相关节点上生成每日存储使用情况报告。一旦每日总量可用，也可以计算每周和每月总量。

**监控监控**

确保监控基础设施本身正常运行是很重要的。在部署期间禁用警报并忘记稍后启用它是我在操作中看到的常见疏忽之一。此类失误很难监控，只有改进部署流程才能解决此类问题。

Pinging 主机

如果有多个监控应用程序实例正在运行，或者有一个备用节点，则可以实施交叉检查来验证用于监控的主机的可用性。

在 AWS 中，CloudWatch 可用于监控 EC2 节点的可用性。

用于监控的运行状况检查

检查监控 UI 的可用性和监控应用程序日志文件中的活动将确保监控系统本身完全正常工作，并继续监视生产环境中的问题。如果使用日志聚合工具，跟踪监控应用程序的日志文件将是检查日志文件中是否有活动的最有效方法。通过使用标准关键字，如“Error”和“Exception ”,可以查询同一索引中的任何潜在问题。

**结论**

监控工作通常是为了应对生产中出现的问题。开展监测的系统方法可以最大限度地减少通常与之相关的被动方式。主动监控增加了更好的用户体验，并且避免了生产中成本高昂的数据重新处理和回滚。