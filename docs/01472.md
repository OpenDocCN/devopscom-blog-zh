# 规划 Cassandra 备份时需要了解的事项

> 原文：<https://devops.com/things-know-planning-cassandra-backup/>

企业正在采用 Apache Cassandra、MongoDB、Amazon DynamoDB、Azure DocumentDB 等 NoSQL 数据库来满足下一代应用程序的数据需求。具体来说，Apache Cassandra 数据库提供了线性可伸缩性、灵活的一致性模型和无共享架构，使企业能够根据性能需求扩展其数据库占用空间。

随着任务关键型应用程序部署在 Cassandra 数据库上，还存在企业数据管理需求，如备份和恢复。如今，有各种选项可用于 Cassandra 的备份和恢复。这些选择各有利弊，我将在这篇博文中详细阐述。对于 Cassandra 数据库管理员(DBA)来说，在选择任何选项并验证可用于实现企业备份和恢复目标的产品和解决方案之前，了解这些选项的利弊非常重要。

让我首先指出数据库管理员在规划备份时应该注意的重要特性:

1.  **辅助存储空间:**高效的存储利用率是任何备份和恢复设计和计划的关键。备份数据集可能比主数据集大得多，具体取决于备份数据的保留期。因此，如果存储管理效率低下，客户的存储资本支出可能会成倍增加，从而与数据保护的目的背道而驰。
2.  **RPO 和 RTO:** 恢复点目标(RPO)是一个最大的目标时间段，在此时间段内，由于重大事故，IT 服务中的[数据](https://en.wikipedia.org/wiki/Data)可能会丢失。恢复时间目标(RTO)是灾难后必须恢复[业务流程](https://en.wikipedia.org/wiki/Business_process)的目标持续时间和服务级别。通常，这些新一代应用程序的企业要求规定非常小的 RPO 和 RTO。
3.  **备份性能:**这是备份所需数据集所花费的时间。通常，备份性能应该具有足够的可扩展性，以匹配主群集的数据更改率。此外，对主群集进行初始完整备份所花费的时间也很重要，因此定期备份不会受到影响。

## Cassandra 备份选项

现在，我们来看一下可用于执行 Cassandra 备份的四个选项:

### 基于快照的备份

Cassandra 通过 nodetool 命令提供了本地节点级快照选项。Snapshot 创建了到现有 Cassandra 数据文件的硬链接，并希望用户在备份文件后删除它。这样，尽管 Cassandra 数据发生了变化，备份仍从快照文件中执行。

**优点:**

*   ***管理更简单* :** 它需要在每个节点上执行周期性的快照命令，触发快照文件的备份，并在备份后删除快照文件。

**缺点:**

*   ***不是真正的备份:*** 节点级快照并不意味着集群一致的备份，这种过于简单的策略会导致恢复时需要大量的修复工作。
*   ***潜在的大 RPO* :** 快照操作并不简单，因为它需要刷新磁盘上的所有内存数据，因此，频繁调用快照会严重影响生产群集的性能。
*   ***主集群数据压缩导致的大存储空间:*** 作为数据压缩的一部分，Cassandra 将一个节点上的多个数据文件合并成一个新文件，从而将一个记录的多个版本减少为一个最新版本。压缩不仅有助于减少主集群中的数据，还能提高读取性能，因为它减少了要查找记录的文件数量。压缩的一个副作用是，相同的记录可能会出现在多个版本中，因为它们被合并到一个新的压缩文件中。从压缩文件中过滤出已经捕获的记录不是一件简单的事情。根据工作负载类型、压缩策略或版本控制间隔等不同方面，压缩可能会导致多倍的数据需要备份，从而对资本支出规划造成严重影响。
*   ***主集群上的快照存储管理:*** Cassandra 希望用户或管理员在不再需要快照文件后将其清理掉。清理快照文件夹需要可靠的作业；否则，它们可能会因存储不足而影响主群集的可用性。
*   ***孤岛式解决方案:*** 企业需要多平台备份和恢复产品，而本机工具是专门为特定数据库构建的，无法针对多个数据库进行扩展。

### 增量备份

Cassandra 支持增量备份功能。如果启用，每次 Cassandra 将内存内容刷新为新文件时，都会在增量备份文件夹中创建新文件的硬链接。一旦这些文件的备份完成，管理员应该删除这些硬链接。增量备份的最大好处是，由于内存中数据内容的刷新，只为新创建的文件创建硬链接。由于压缩而创建的文件不是硬链接的。

**优点:**

*   ***更好的存储利用率:*** 备份中没有重复记录，因为压缩文件没有备份。
*   ***时间点备份:*** 公司可以实现更好的 RPO，因为从增量备份文件夹进行备份是一个连续的过程，因此可以更精细地进行版本控制。

**缺点:**

*   ***主集群上的空间管理:*** 使用此选项，公司需要主集群上可靠的空间管理流程。备份后，增量备份文件夹必须清空。否则，可能会导致主集群上出现严重的空间问题。
*   ***在备份中创建大量小文件:*** 由于增量备份便于备份因从 Cassandra 刷新内存数据而创建的新文件，因此文件通常很小。这会产生许多小文件，使得文件管理和恢复不是一项简单的任务(与客户想要和期望的 RTO 保证相比，这相当昂贵)。

### 增量备份与快照相结合

增量备份结合快照是进行 Cassandra 时间点备份的另一种基本方法。定期从快照备份数据，而基于增量备份的文件用于时间点需求。这意味着必须定期删除基于快照的备份已经覆盖的基于增量备份的文件。

**优点:**

*   ***相当大的备份文件:*** 只有周期性快照之间的数据来自增量备份。
*   ***时间点:*** 提供时间点备份和恢复。

**缺点:**

*   ***备份中的空间管理:*** 每次快照后，需要清理增量备份的数据。此外，对于来自快照的备份文件，由于在主节点压缩而导致的大量备份存储占用空间始终是一个问题。
*   ***运营非常繁重:*** 这种方法需要 DBA 管理员编写解决方案脚本；这对于企业规模来说是不可扩展的。

### 提交-日志备份与快照相结合

这种方法类似于增量备份。DBA 管理员将提交日志归档，而不是备份新添加的表。基于快照的定期备份提供大量备份数据，而归档的提交日志用于时间点备份。

**优点:**

*   ***时间点:*** 基于快照的备份结合提交日志归档提供了时间点备份选项。

**缺点:**

*   ***空间管理:*** 同样，提交日志归档空间管理是管理员的职责；这种方法会导致操作繁重的解决方案(OpEx)。
*   ***恢复复杂性:*** 恢复要复杂得多，因为部分恢复将从提交日志重放开始。
*   ***存储开销:*** 基于快照的备份会出现存储过度使用的问题，因为压缩会导致数据重复。这导致大量使用辅助存储，从而导致非常高的资本支出。

## 摘要

总的来说，Cassandra 提供了多种备份选项。通常，如果需要时间点恢复，则使用提交日志归档/增量备份相结合的基于快照的备份。如果不需要时间点恢复，简单的基于快照的备份更容易实施，尽管它不是真正的备份，并且会导致大量的修复工作。

这些选项中的大多数都需要大量的手动工作，并且容易出错。它们适用于规模较小、可以承受数据丢失和高 RTO 的试运行或预生产以及测试/开发环境。但是，对于大型企业客户和生产部署，有一些关键要求，如通过新颖的压缩/重复数据消除技术减少数据量、各种故障处理和具有所需一致性的更快恢复。

对于最大限度地减少数据丢失和操作弹性是重要因素的任务关键型、永不停机的应用程序，管理员应考虑利用专门从事该领域工作的公司提供的新一代数据保护产品。