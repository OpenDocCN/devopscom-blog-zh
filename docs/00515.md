# 持续交付的可组合环境

> 原文:[https://devo PS . com/composable-environments-continuous-delivery/](https://devops.com/composable-environments-continuous-delivery/)

*下面讨论的持续部署模型需要其平台基础的一些非常具体的属性。目前，AWS 是唯一支持实现这一功能所需的所有特性的环境。因此，当我们在本文和以后的文章中开始讨论实现细节时，我们将把目标对准 AWS。* 

这篇文章的标题实际上是本末倒置的。与其说本文是关于使用可再生的可组合环境进行连续交付(CD ),不如说是关于使用连续交付来构建可再生的可组合环境。可组合环境是重要的一部分。为什么？要理解这一点，我们需要了解这样一个环境是什么。环境是一个自包含的完整软件堆栈，包括支持该堆栈所需的每个组件以及该堆栈的版本可控描述。例如，一个网站的环境可能是所有运行 HTTP 服务器的机器，其他运行 RESTful Web 服务器的机器，数据库，AMQP 提供者等等。它还包括自动扩展、故障恢复等所需的任何基础架构。这种环境将由一个或多个受版本控制的文件以声明的方式完整地描述。该描述包含了每一个虚拟机映像、数据库模式、DNS 服务器、DNS 条目等等，这些都是以一种自包含的、可复制的形式建立一个系统所需要的，并且可以被置于版本控制之下。这个描述以一种合理的方式被[版本化](http://semver.org),并且可以通过执行单个命令来再现。这个概念的一个很好的例子是[云形成](https://aws.amazon.com/cloudformation) [堆栈](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-whatis-concepts.html)。堆栈以声明的方式描述了完整的环境，云形成基础架构接收这些堆栈，并根据请求将它们激活到完整的运行系统中。我们的环境概念更进一步，围绕环境的隔离和通过 DNS 的可访问性，但是这些例子为我们描述的概念提供了一个很好的种子。

可再生的可组合环境是一个简单的概念，却有着深刻的含义。一些最重要的是:

*   一个完全可复制的环境是独立的。该环境的多个实例不会相互干扰。
*   可以在算法上改变声明性描述的环境。也就是说，它可以很容易地通过一些自动化的过程来改变。
*   环境可以通过算法部署，也可以通过算法取消部署。

一旦我们创造了一个具有这些特性的环境，我们就可以用它来完成以前不可能完成的事情。它通过可测试性、可组合性和可部署性的结合开辟了新的机会。你可能会注意到，这听起来像是 20 世纪 60 年代在编程社区发生的向结构化编程的转变。这种转变对我们创建软件系统的方式产生了深远而持续的影响，我认为这种开发运维的方法将对我们创建和管理环境的方式产生类似的影响。

**为什么环境很重要**

这些环境在整个软件开发过程中都很有用。从单个开发人员编写和迭代测试系统开始。有了这样的环境，他可以通过建立一个完整的环境，包括所有参与的部分，并在上下文中测试该系统，来真正测试他所做的更改。使用这样一个系统的下一个大的地方是在持续集成期间，此后称为 CI。在构建周期的最后，CI 系统创建一个环境，将更改发布到该环境中，建立完整的系统，并为整个系统运行完整的测试套件。在上下文中支持整个系统的能力大大降低了推出变更的风险。能够在需要时，以特别或自动化的方式推出具有更新组件的环境，提高了我们系统的可测试性。

自动化过程是构建和修改环境的正确方法，并且是连续交付所必需的。

**连续交货**

我将连续交付定义为一个幂等的、自动化的过程，它主要被设计为用新的、经过良好测试的工件来更新可再生的可组合环境。

我们可以把连续交付看作是一个具有一组明确定义的输入和一组明确定义的输出的过程。流程本身由一系列阶段组成，每个阶段都有自己的输入和输出。这使我们能够将各个阶段甚至整个裁谈会进程组合成不同的进程，为新的目的服务。

对于最简单的 CD 过程，主要输入是源代码，主要输出是作为系统一部分的服务。更具体地说，输出是您或您的客户连接到的一组端点。在我将提供的例子中，这些将以 DNS 条目的形式出现。知道了输入和输出，我们现在可以开始考虑中间的过程。

**光盘的阶段**

标准 CI 管道由五部分组成:**开发、测试、发布、部署和推广**

**阶段:开发**

开发阶段本质上是单个开发人员的开发过程。它唯一的输入是 CD 过程的输出，该过程自动创建和提供开发盒以及相关的环境。这是 CD 输入作为另一个 CD 过程的输出的第一个例子。

开发盒是必要的，这样开发人员可以在与 CI 服务器完全匹配的环境中测试他的工作。它还应该与其他开发人员正在开发的系统完全匹配。这一点至关重要，但经常被忽视。目前，开发人员很少在彼此匹配的开发环境中编写代码，更不用说匹配 CI 服务器的开发环境了。

**阶段:测试**

测试阶段是我们获取开发阶段产生的工件并测试它们在上下文中的生存能力的地方。测试阶段的输出通常是发布到环境中的一组更完整的工件。

这些阶段通常采取的形式是获取开发人员的代码，对其进行编译，将其转换成某种类似包的结构，并将其发布到特定于环境的已知位置。该结构通常是一个实际的包:一个 LXC/监狱容器，比如 Docker 映像，一个虚拟机映像，比如 EC2 AMI，或者这三者的某种组合。

在测试阶段，目标环境用新的工件支撑起来，并运行一系列的集成/发布测试。测试揭示了整个环境中的变化的可行性。

**阶段:发布**

发布阶段获取测试阶段的输出，并以一种使它们可用于部署阶段的方式发布那些工件。这通常包括将包放在一个公共可访问的地方。

你可能已经注意到我们非常依赖某种包装模式。那是故意的。你需要把你的系统变成一个可管理的单元，以使它作为过程的一部分正确地工作。

**阶段:部署**

部署最后一个阶段。在这里，发布的包被用作更新环境的输入。这个阶段的输出是用新发布的工件更新和生动化的规范环境。正在运行的系统、预配的数据库、可访问的 URL 等都已更新到位。

**阶段:推广**

最后，我们还有可选的晋升步骤。这仅仅包括将从部署状态输出的工件移动到一个新的环境中。一个常见的例子是将测试环境提升到生产环境，其中已经运行了一些辅助流程，这些流程已经对环境进行了验证，使其可供消费者使用。

**克服技术限制**

我不想对你撒谎。开始这个过程并不简单。直到几年前，我还会说这是不可能的。但是，世界已经变了，现在这是可能的，甚至是可以接近的。我们必须具备一些先决条件才能让它发挥作用。您必须有能力以编程方式配置您的网络，配置您的 DNS，提供硬件等。我可以通过混合使用新技术来实现这一点，比如 [OpenStack](https://www.openstack.org) 、 [OpenFlow](https://www.opennetworking.org/Openflow) 和定制 DNS 等等。我们大多数人都没有能力在数据中心实施这些技术。好在我们有 [AWS](https://aws.amazon.com) 。在 [EC2](https://aws.amazon.com/ec2) 、 [Route 53](https://aws.amazon.com/route53) 之间，尤其是[云形成](https://aws.amazon.com/cloudformation)，我们几乎拥有了让这一切发生所需的一切。在接下来的几篇文章中，我们将把这里描述的模型应用到生产系统中。在本系列结束时，您将能够在您自己的基于 AWS 的环境中应用这个模型。您应该仍然能够在非 AWS 环境中适应和应用该模型的某些部分。

而且，我的团队将继续实现和改进我们的可组合环境的想法，以持续交付更完整的解决方案。敬请期待！