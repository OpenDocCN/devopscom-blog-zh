# 基准测试微服务的操作方法

> 原文：<https://devops.com/operational-approach-benchmarking-microservices/>

对微服务进行基准测试通常会落后于工程团队的任务清单。然而，那些没有的人错过了一个关键的组成部分。基准测试的基本目标是更好地理解软件，并测试各种微服务优化技术的效果。在这篇文章中，我将描述一种有效的微服务基准测试方法。

首先，创建一个电子表格来跟踪你的基准。记录一系列基准的一种便捷方式是使用 Google 电子表格。它允许协作，并提供必要的功能来分析和总结您的结果。按如下方式构建您的电子表格:

*   扉页
    *   目标
    *   方法学
    *   计划和完成的实验列表(随着您了解的更多而发展)
    *   洞察力
*   附加页面
    *   各种实验的详细基准测试结果

然后，在你进行基准测试之前，清楚地陈述(并记录)你的目标。目标的例子有:

*   *“我试图理解输入 X 如何影响度量 Y”*
*   *“我正在运行实验 A、B 和 C，以增加/减少指标 X”*

接下来，选择一个关键指标，清楚地说明您关注的是哪一个指标，以及该指标如何影响系统的用户。如果您选择为您的测试运行获取额外的指标，请确保关键指标突出出来。

现在，你必须像科学家一样思考，并进行一系列实验，以更好地了解哪些输入会影响你的关键指标，以及如何影响。考虑并记录你设计的变量，并创建一个标准控制集进行比较。以一种能以最少的时间和努力获得理解的方式来设计你的一系列实验。然后，您需要定义运行基准的方法。至关重要的是，您的基准是:

*   相当快(理想情况下，几分钟)
*   甚至几个月后也能以完全相同的方式重现
*   记录得足够好，这样另一个人可以重复它们并得到相同的结果

详细记录你的方法。还要记录如何重新创建您的环境。包括其他人需要知道的所有细节:

*   使用的版本
*   功能标志和其他配置
*   实例类型和任何其他环境细节

在大多数情况下，为了完成可重复的快速实验，您需要一个合成的负载生成工具。找出一个是否已经存在。如果没有，你可能需要写一个。了解负载生成工具充其量只是生产中正在发生的事情的近似。近似值越好，你得到的结果就越相关。如果您发现自己从没有转化为生产的基准中获得了洞察力，请重新审视您的负载生成工具。

然后，验证您的基准测试方法是很重要的，至少重复基准测试 10 次，并计算结果的标准偏差。您可以使用以下电子表格公式:

```
=标准偏差(<range>)/平均值(<range>)
```

将这个数字格式化为一个百分比，您将会看到结果集中的相对方差有多大。理想情况下，您希望该值小于 10%。如果您的基准有较大的差异，重新审视您的方法。您可能需要调整以下因素:

*   增加测试的持续时间。
*   消除环境差异。
    *   确保所有基准在相同的状态下开始(即冷缓存、新启动的 JVM 等)。
    *   考虑热点/JIT 的影响。
*   简化/剔除组件和对其他微服务的依赖，这些组件和依赖会增加差异，但对您的基准测试并不重要。
    *   不要羞于修改代码，不要羞于推出你永远不会发布到产品中的二进制文件。

**重要的**:确定你需要多少个结果才能让标准差低于一个好的阈值。至少运行你实际的基准测试那么多次。否则，你的结果可能太随机了。

既然您已经开发了一个可靠的方法，那么是时候收集数据了。一些提示包括:

*   一次只能改变一个输入/旋钮/配置设置。
*   对于基准的每次运行，捕获开始和结束时间。这将有助于您稍后将其与日志和指标相关联。
*   如果你不确定输入是否会真正影响你的指标，尝试极限值来确认是否值得运行一系列。
*   编写执行基准和收集指标的脚本。
*   交错您的基准，以确保您观察到的不是测试环境中的缓慢变化。运行 ABCABCABC，而不是运行 AAAABBBBCCCC。

现在，您需要创建足够的负载来测量差异。生成负载有两种不同的策略:

1.  红线！在大多数情况下，您希望确保创建足够的负载来使您的组件饱和。如果您无法做到这一点，您将如何看到您增加了它的吞吐量？如果您的组件在红线处崩溃(即 OOMs、吞吐量下降或失控)，了解原因并解决问题。
2.  测量机器资源。如果您无法标记组件，或者您有理由相信它在低于 100%负载的情况下会有很大的不同，您可能需要求助于操作系统指标，如 CPU 利用率和 IOPS，来确定您是否做出了更改。确保您的负载足够大，以使更改可见。如果您的负载导致 3%的 CPU 占用率，那么 50%的性能提升将会消失在噪音中。尝试不同的负载量，找到一个最佳点，在这个点上，您的操作系统指标测量足够敏感。

当您执行基准测试并对系统有了更好的理解时，您可能会发现影响您的关键指标的新因素。在你的清单上添加新的实验，如果需要的话，优先于之前的实验。

在某些情况下，代码可能没有您想要改变的输入的配置或控制旋钮。找到改变输入的最快方法，即使这意味着修改代码、注释掉某些部分或者以其他不适合合并到 master 中的方式操作代码。记住:这里的目标是尽可能快地得到答案，而不是编写生产质量的代码——一旦我们有了答案，生产质量的代码就会出现。

一旦你完成了一系列的基准测试，后退一步，想想这些数据告诉了你什么关于你正在进行基准测试的系统。记录你的见解以及数据是如何支持它们的。这可能有助于:

*   计算您运行的每个基准系列的平均值，并使用它来计算系列之间的差异(百分比)，即“当我将线程数量增加一倍时，QPS 平均增加了 23%。”
*   绘制您的结果—您的输入和绩效指标之间的关系是线性的吗？对数？钟形曲线？

最后，你需要展示你的见解。以下是向管理层和/或其他工程团队展示的一些最终提示:

*   应用金字塔原理。工程师们经常会犯这样的错误:解释方法、结果，并以洞见作为结论。最好颠倒顺序，从洞察力开始。然后，如果需要/要求，解释方法和数据如何支持你的见解。
*   省略任何不能带来有趣见解的实验的本质细节。
*   避免行话，如果不能，解释一下。不要假设你的听众知道行话。
*   确保你的图表有有意义的，人类可读的单位。
*   确保您的图表在投影到屏幕或电视上时可以阅读。

— [斯蒂芬·齐尔](https://devops.com/author/szier/)