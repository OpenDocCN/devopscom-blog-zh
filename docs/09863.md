# 最大值和最小值:当性能工程计划出错时

> 原文:[https://devo PS . com/of-max-and-min-when-performance-engineering-plans-go-awry/](https://devops.com/of-max-and-min-when-performance-engineering-plans-go-awry/)

现代软件开发人员可以使用强大的工具和服务，快速开发、演示和部署功能齐全的应用程序。但是当单用户原型满足了所有需要的功能，但是用户说系统看起来很慢时会发生什么呢？或者，如果最初的实现对一个用户来说很好，但是多个用户开始经历延迟？或者，如果用户很高兴，但自动扩展的成本越来越高，令人望而却步？

### 性能工程的问题是

对计算系统非功能方面的关注——响应时间、资源利用和成本——属于计算机系统性能工程(CSPE)的范畴。不幸的是，CSPE 的实践已经演变成一种更像艺术而不是工程的东西——几乎没有标准化的原则和实践。因为软件不断地发展它的语言和抽象，CSPE 的从业者似乎也有义务发展和改变他们的抽象和语言。因此，作为[性能工程师](https://en.wikipedia.org/wiki/Performance_engineering)的一部分工作就是理解其他性能工程师真正的意图或意思。

造成这种状况的原因有很多，但归根结底，CSPE 缺乏通用语言和工程标准是软件工程师教育和培训的缺陷。在典型的大学软件工程课程中，很少有为软件工程师做 CSPE 做准备的内容。这有时会导致没有科学或工程原则支持的实践。结果，从业者被迫“即兴发挥”——创造自己的艺术或搭上别人的马车，通过试错来学习(或不学习)。

* * *

| PMWG——性能的象征？性能管理工作组(PMWG)成立于 20 世纪 80 年代末的“UNIX 战争”期间，当时计算机供应商为争夺 UNIX 领导地位而争斗，并形成了两个派别:UNIX 国际和开放软件基金会。该组织的独特之处在于其成员包括“战争”双方的计算机系统供应商。它的成员将这些差异放在一边，试图提出性能管理标准和实践，使 UNIX 与大型机上的性能管理工具不相上下。回想起来，PMWG 可能是 UNIX 建立、推广和体现一些基本性能工程原则的最好机会——一种性能的 POSIX。不幸的是，该小组失败了——在我看来，很大程度上是因为它过于重视性能管理数据管道的后期阶段，而没有在建立关键原语上花费足够的精力。今天，在缺乏绩效工程的既定规则和实践的情况下，历史正在重演。目前在可观察性方面的努力主要集中在数据表示、数据传输和存储上，而没有太多关注基于基本性能工程原则的正确指标和数据质量。表示、传输和存储很重要，但是围绕度量、日志记录和跟踪覆盖范围以及数据质量的工作充其量只是零星的。 |

* * *

### 惰性、权宜和迷信

为什么 CSPE 需要更正式的、基于工程的实践？考虑使用 CPU 利用率作为系统性能的关键性能指标(KPI)。我是彭博交易解决方案 SRE 团队的成员，该团队管理着数百台运行该公司交易解决方案软件的机器。我们经常看到或听到类似“该主机的 CPU 太忙”或“该主机的 CPU 资源不足”的语句我发现这些观察实际上没什么帮助，有时会转移我们对真正问题的注意力。当被误用为系统 KPI 时，只关注 CPU 利用率可能会将我们引向错误的道路并得出错误的结论。为了理解为什么，让我们首先看看我们如何评估现实世界中非计算系统的性能。

以快餐店为例。快餐店最重要的特征之一(除了它们的健康检查评级)是它们的*快*。但是我们都去过一点也不快的快餐店。在没有真正排队和*等待*的情况下，我们经常可以说，如果快餐店里有*长队*，我们就会有*慢*的体验。*线长度*给了我们很多信息。我们对情况的评估是不同的，不管是 100 个顾客，还是 10 个顾客，还是只有一个顾客在排队。

在现实世界中，这种*排队长度*(或队列长度)的评估几乎是通用的。超市收银台、自动取款机、机场安检、收费站、电梯和新冠肺炎测试都是我们应用这种半意识评估的领域。相比之下，我们几乎从不使用“收银台使用率”或“自助冷饮店使用率”来评估快餐店的速度有多慢。我们总是说“队伍很长”，或者，如果我们真的选择排队，我们会更直接地说“服务很慢”

这让我们回到了我们的计算系统。为什么当计算系统运行缓慢时，我们会本能地关注 CPU 利用率，而在现实世界中，我们依赖于队列长度？当我们考虑到今天 CPU 的概念还没有很好的定义时，这个问题就更有意义了。我们是在测量 CPU、它的内核还是硬件线程？我认为造成这种误用的因素包括*惯性*、*权宜*和*迷信*。

在计算的早期，CPU 可能是当时大型单片计算机系统中最昂贵的组件。测量这些昂贵组件的使用量是最大化这些大型机器的财务投资的重要部分。幸运的是，CPU 利用率的测量相对容易估计。易于实现意味着 CPU 利用率指标几乎普遍可用。

这一简单指标的普遍可用性，结合高 CPU 利用率和系统缓慢之间的*某种相关性(有时很弱)*，使其成为系统性能的默认指标。当一种信仰变得根深蒂固到了迷信的地步，即使是微弱的相关性也足以*验证*并使其延续下去。更好的指标——例如，CPU 的运行队列长度³——可以帮助我们摆脱迷信，更好地了解我们的系统，并在识别和纠正问题时引导我们走向正确的方向。

### 破除迷信和其他不合理的做法

这就引出了本系列的标题和目的。作为一个标题，“最大和最小”是为了唤起约翰·斯坦贝克的经典中篇小说“人鼠之间”，这反过来又从罗伯特·彭斯的诗“ [到一只老鼠](https://en.wikipedia.org/wiki/To_a_Mouse)”:*T**他精心制定的人鼠之间的计划经常出错*。《人鼠之间》中的两个主要角色在大萧条时期改善生活的努力失败了，因为他们不幸没有能力做到这一点。类似地，当软件工程师在没有经过性能工程原则的适当培训的情况下承担性能工程的任务时，如果计划出了差错，我们也不应该感到惊讶。

“最大值和最小值”也强调了数据分析和统计在理解系统行为中的重要性。有效的 CSPE 要求我们熟悉统计学、数值分析、甚至运筹学中的概念——除了算法复杂性和计算机体系结构这些更标准的计算机科学领域。

在 Max 和 Min 的**、**中，除了指出迷信之外，我还会指出一些我们常犯的错误和盲点。通过案例研究，我将说明我们的盲点如何导致持续多年的错误。我还将尝试涵盖一些基本的 CSPE 原则，我认为这些原则在大多数软件工程培训中都被忽略了。像其他人一样，我已经即兴表演了 40 多年。我还在学习。如果你不同意我的任何观点，或者对我提出的主题有进一步的见解，请告诉我。

* * *

但是，正如在算法复杂性背后的原则的应用中一样，无论当前的系统和语言是什么，都有一些性能工程原则可以而且应该遵守。

² 事实上“CPU 利用率”有一些离奇的实现方式。[这里有一个例子](https://ardentperf.com/2016/07/01/understanding-cpu-on-aix-power-smt-systems/)，它说明了 AIX 是如何在以超线程模式运行的多处理器系统上“打破”CPU 利用率的含义的。

³ UNIX 和 Linux 实际上有可以用作 CPU 队列长度指示器的指标。在下一期文章中，我将深入探讨一些 CPU 队列长度实现的古怪之处，并进一步论证队列长度度量实现更一致的数学基础。

⁴ 例如，您是否曾想过，为什么在日志记录、malloc、DNS 和其他低级服务导致如此多的中断之后，我们仍然没有对这些和其他低级组件的良好、开箱即用的可见性？当我们真的不应该接受的时候，我们正在接受关键盲点作为生活的事实。

### 关于我

像许多软件工程师一样，我开始研究一个不同的领域(物理学)。与大多数软件工程师不同，我一直想成为一名性能工程师。当我在哥伦比亚大学的物理项目中开始学习计算机课程时，我并不希望以用 Fortran 编写程序为职业(是的，那是很久以前的事了)。但我确实设想过让系统运行得更好更快。

为此，当我在本科学习中增加了一个计算机科学专业时，我还增加了一个工业工程和运筹学辅修专业。对于那些不熟悉 IEOR 的人来说，它是一个多学科的工程领域，利用数学和分析方法来解决复杂的系统问题，如资源分配、供应链、等待时间、公平性等。IEOR 的工具和方法对 CSPE 来说是非常宝贵的。

在我职业生涯的开始，我作为一名计算机系统性能工程师加入了贝尔实验室计算机中心，在那里我做了一个有点与众不同的决定(1980 年),去支持他们内部低调的 UNIX 系统的小组工作(而不是他们在商业上受欢迎的 MVS 大型机)。我当时并没有意识到这一点，但是能够接触到你所支持/研究的系统的源代码对理解是有好处的。在贝尔实验室，我有机会为 UNIX System V 内核做出贡献，在那里我参与开发了第一个用于 UNIX 的通用内核和用户土地跟踪系统，对虚拟内存子系统进行了显著的性能增强，并参加了 PMWG。

从那以后，我职业生涯的大部分时间都在从事金融软件系统方面的工作——从市场数据到信息传递再到交易管理。我从事过企业级的监控系统。我犯了并目睹了许多 CSPE 的错误。我目前在彭博的交易解决方案团队中担任 [SRE](https://devops.com/?s=SRE) 的角色，我看到并帮助解决了许多源于我们运行时规模的操作系统问题。

* * *

***感谢***

*感谢审阅本文档并提供建设性反馈的所有人。特别感谢 Nate McNamara 和 Peter Wainwright 提出的实质性组织和结构改进建议。彼得也控制了我默认的意识流，持续风格。他们中没有一个人参与了这一段的写作。*

T3】