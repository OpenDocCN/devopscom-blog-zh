# C/C++项目中的开发运维挑战

> 原文:[https://devops.com/devops-challenges-c-c-projects/](https://devops.com/devops-challenges-c-c-projects/)

> ***c++不仅在性能方面是最强大的语言，而且还是一门伟大的语言！它有真正的泛型，具有表现力，是程序员最喜欢的语言之一。***

******—** Diego Rodriguez-Losada， [JFrog](https://www.jfrog.com/) 的软件工程师，[柯南 io](https://conan.io/) 的创作者****

****这种具有无与伦比的性能的非常强大的语言继续在所有行业中使用和受到青睐。然而，尽管 DevOps 已经在 Java 等软件开发的其他主要领域变得普及，但实现现代 C 和 C++ DevOps 并不容易，尽管有一些解决方案可以提供实际帮助。****

 ****让我们看看 C/C++开发人员面临的挑战，然后看看如何解决它们。

# TL；博士；医生

C 和 C++受到许多开发人员的青睐有很多原因。然而，在 C 和 C++项目中实现现代 DevOps 和持续集成并不容易。由于 C/C++编程语言和生态系统的性质，这仍然是一个挑战。今天，我们有知识和经验来确定我们需要满足今天的 C 和 C++的 DevOps 需求。我将通过下面的案例研究来证明这是可能的。

# 构建 C 和 C++项目

理想情况下，我们希望从开发人员变更到生产的 CI/CD 流程尽可能的顺畅和快速。然而，与其他开发语言相比，C/C++开发人员面临着更大的挑战:

*   **构建时间长:**这并不是因为 C 和 C++编译器慢。事实上，它们速度极快，是整个 IT 世界中一些最先进、最出色的技术。但是，C/C++有头文件的问题，预处理器基本上在每个翻译单元中一次又一次地复制每个包含的文件，增加了他们必须编译的代码行。有一些机制作为预编译头，可以部分缓解第二次和后续重建的问题。此外，与其他语言相比，C/C++语言被多次用于大型项目，有数百万行代码(MLoc)——一个典型的 AAA 游戏有 20 MLoc。
*   **多样的平台和生态系统，不同的构建系统:** C 和 C++无处不在。它们用于计算机、嵌入式设备、移动设备等等。但在每一个平台上，他们将使用不同的编译器(如 Windows 上的 MSVC·cl.exe，Linux 上的 GCC，OSX 上的 apple-clang)和许多不同的构建系统。CMake、MSBuild 和 Makefiles 或自动工具被广泛使用，但公司也在使用许多其他构建系统，甚至开发他们自己的定制解决方案。
*   **二进制兼容性:** C 和 C++都是针对原生/二进制代码构建的，但用某个编译器版本编译的二进制文件与其他编译器不兼容，甚至与不同版本的同一编译器也不兼容。这个问题被称为 ABI(应用程序二进制接口)不兼容，其他语言不必处理这个问题。ABI 不兼容会导致链接错误，这在构建时很容易发现，但经常会产生运行时错误。
*   **代码内联和嵌入:**共享库直接嵌入它们所链接的静态库的本机代码。不仅如此，甚至静态库也可能嵌入在另一个库的头文件中声明的代码。这意味着可能有必要从根本没有修改过的源代码库中重建二进制工件，仅仅是因为它的一些依赖关系发生了变化。
*   **OSS 缺乏标准:** OSS 库可以在 GitHub、GitLab 或 Bitbucket 中托管它们的源代码，但这并不能让它们随时可用。用户需要从源代码中构建二进制文件(这可能很痛苦)，从系统包管理器(可能已经过时，并且在任何情况下对于每个平台都是不同的)中检索预构建的二进制文件，或者使用其他安装程序或预编译模块(必须从网站上下载)。之后，他们通常还需要对消费者构建系统进行不同的调整，这对于每个平台来说也是不同的。

# 现代 DevOps 对 C 和 C++的要求

鉴于上面列出的挑战，C 和 C++项目的现代 DevOps 实践和工具需求是什么？

*   **管理和重用二进制文件:**每次从源代码构建都非常昂贵，容易出错，并且无法扩展到大型项目。重用二进制文件对于不同的平台应该是一致的，并处理 ABI 兼容性问题。
*   **在单个存储库或服务器中管理所有二进制文件:**在几个系统中创建和维护包(比如 Debian 中的 apt、RH 中的 rpm、Windows 中的 nuget/choco 和 OSX 中的 pkg)对于开发人员或 DevOps 工程师来说成本非常高。能够从同一个位置存储、管理和检索二进制文件极大地简化了基础设施和流程，从而节省了大量时间。
*   **适应任何构建系统、平台和工具，从旧的到最新的:**如果每个人都使用单一的构建系统，创建良好的 CI 和包管理将会简单得多。但是认为项目可以迁移到构建系统显然是天真的。将一些库或项目迁移到新的构建系统的成本是一项巨大的投资，可能需要几个月的时间。过程和工具必须能够适应处理任何构建系统和现有遗留工具。
*   **与其他工具良好集成:**不仅构建系统，而且工具必须尽可能简单地与其他类型的工具集成。例如，持续集成平台，如针对 Linux/OSX 和 Windows 的 Travis 和 Appveyor 云服务，因对 OSS 项目免费而受欢迎，以及 Jenkins，这是专有代码行业事实上的标准。此外，工具必须与流行的 ide 很好地集成，如 Visual Studio 或 XCode 以及测试、覆盖、静态分析、多控制版本系统等。

# Conan C/C++包管理器案例研究

[柯南](http://conan.io/)是一个免费的 OSS C/C++包管理器。它是去中心化的、可移植的、多平台的，运行在许多操作系统上，如 Windows、Linux、Mac、BSD 和 Solaris，但目标是 C/C++应用程序的任何可能的目标。

柯南是如何满足上述要求的:

*   柯南能够为任何数量的不同配置构建、上传和共享二进制文件。它管理二进制文件，根据需要为每个相应的平台检索正确的二进制文件，并且还能够在必要时从源代码进行构建，从而最大限度地减少 ABI 不兼容问题。
*   使用 [OSS conan_server](https://conanio.readthedocs.io/en/latest/server.html) 或 [JFrog Artifactory Pro](https://www.jfrog.com/artifactory/versions/) ，柯南包和预构建的二进制文件可以上传到服务器并在其中共享，它们可以在团队或公司范围内私下共享。如果需要的话，柯南包可以使用 [JFrog Bintray](https://www.jfrog.com/bintray/) 在全球范围内分发，无论是私人的还是公共的仓库，对 OSS 项目都是完全免费的。所有支持平台的所有不同二进制文件都可以在同一台服务器上通过完全相同的界面上传和管理。
*   柯南适用于任何构建系统。它包括与 CMake、Visual Studio、Makefiles、SCons、QMake 等的内置集成。它还具有良好的客户端可扩展性，支持任何其他构建系统，使用“[生成器](http://docs.conan.io/en/latest/reference/generators.html)”这意味着可以开发扩展来将柯南依赖模型翻译成任何构建系统格式，并生成那些构建系统可以读取的文件。
*   柯南与不同的 CI 系统很好地集成，为 Travis、Appveyor 和 GitLab 提供了特定的工具和助手，还在 [Jenkins Artifactory 插件](https://www.jfrog.com/confluence/display/RTF/Jenkins+Artifactory+Plug-in)中提供了自定义 DSL。

Conan package recipes 是用 Python 编写的，因此可以使用它们通过标准的 Python 语法在很大程度上轻松地定制行为，允许用户轻松地插入本文前面提到的许多不同的工具:静态分析、测试、代码覆盖等等。

让我们从 DevOps 的角度来看一个典型的流程，来说明柯南是如何工作的。首先，开发人员对特定库(LibB)进行一些源代码更改，将这些更改提交并推送到共享版本控制系统服务器(Git Repo)。

*![](../Images/8fb3657fb39a03f758ce6b2102514698.png)图:C/C++与 Conan、Artifactory 和 Jenkins 的 CI 周期示例(构建系统:CMake、VS、MakeFile)*

然后，CI 系统将监听 Git 存储库，最好使用 Git 挂钩，因为不推荐轮询，并为它启动一个作业(Jenkins)。下面是一个如何用 Jenkins 管道定义的示例:

![](../Images/a8263bcb71da3cff2a3247d0608e96ec.png)

上例中的第一阶段很简单。第二个阶段调用包创建，包创建在内部分成两个子任务:

1.  LibB 依赖项以二进制形式检索，以避免从源代码中重新构建它们并浪费时间。
2.  构建所有传递依赖关系的依赖关系图，并编写一个或多个文件。在此示例中，LibB 使用 CMake 作为构建系统，而 Conan 生成一个“conanbuildinfo.cmake”文件，该文件包含所有依赖项信息，使 LibB 能够找到并正确链接到它们。柯南然后会调用 LibB 构建系统为其生成二进制包。最后，在最后一个 Jenkinsfile 阶段“上传包”，生成的二进制文件被上传到 Conan 包服务器(JFrog Artifactory)。LibB 二进制包立即可供开发人员或其他 CI 工作使用。

此示例说明了一个 32 位体系结构的构建配置，它是在带有“-s arch=x86”参数的“conan create”命令中指定的。请注意，许多额外的配置可以使用不同编译器、操作系统、架构等的并行任务和作业来并行构建。

# 结论

与开发中的其他编程语言相比，C 和 C++面临着额外的挑战。这也使得在尝试实现现代 DevOps 时更具挑战性，但并非不可能。C/C++一直被忽视，现在是我们更新工具以满足开发人员需求的时候了。你在你的 C/C++项目中实现了哪些 DevOps 原则和实践？

## 关于作者/ Baruch Sadogursky

Baruch Sadogursky 是 JFrog 的开发者代言人。为了谋生，他与 JFrog 的技术领导者们一起，围绕 JFrog 平台及其生态系统编写代码，然后发表演讲并撰写博客。他已经这样做了十几年了，并且享受其中的每一分钟。他还是 DevOps、Java 和 Groovy 主题的专业会议发言人，并且是业界最负盛名的活动的常客，包括 JavaOne(在那里他被授予摇滚明星奖)、DockerCon、Devoxx、DevOps Days、OSCON、Qcon 和许多其他活动。他完整的演讲历史可以在 T2 的 Lanyrd 网站上找到。在 Twitter 上关注他 [@jbaruch](https://www.twitter.com/jbaruch) 在 Twitter 上关注他，或者在这里阅读他的博客[和在这里](https://www.jfrog.com/blog/)[阅读他的博客](http://blog.bintray.com)。****