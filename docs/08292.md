# Shopify 漏洞:为什么 Authz 利用了大多数安全防御措施

> 原文:[https://devo PS . com/the-shopify-breach-why-authz-exploits-slip-by-most-security-defenses/](https://devops.com/the-shopify-breach-why-authz-exploits-slip-by-most-security-defenses/)

## 发生了什么

作为 bug 赏金的一部分，安全研究员 Uzsunny 在 Shopify 平台上发现了一个严重的漏洞。该漏洞允许攻击者在未经商店经理批准的情况下，将自己指定为 Shopify 上任何商店的“合作者”。合作者拥有对商店执行任何操作的完全访问权限，包括读取客户数据、更改库存等。

## 技术细节

Shopify 合作伙伴计划允许专家与 Shopify 商店经理联系，并为他们提供设计和网页开发等服务。一个专家可以是不同商店的合作者。

请求“合作者”访问现有商店的过程包含三个步骤:

#### 1.专家输入商店 URL。

![](../Images/24fab3ddad05b0209ee5a59fe7cb9937.png)

#### 2.商店经理收到一封关于访问请求的电子邮件。

![](../Images/bef5441581582c5065a953d50b659d06.png)

#### 3.一旦商店经理批准了请求，他们的浏览器就会发送一个 API 调用给:

![](../Images/b59ca7e94f3b08b140ccf2de442e9623.png)

这个 API 调用批准专家的访问请求，并将他转换为“合作者”

问题:代码没有验证 API 调用是由商店经理触发的。事实上，任何用户都可以调用 API 端点并批准访问请求，即使他们没有适当的权限。

使用这种技术，Uzsunny 设法“以完全权限登录任何商店。”由于他的麻烦，Uzsunny 从 Shopify 获得了 2 万美元的奖金，据[报道](https://hackerone.com/reports/270981):“我们在一段代码中追踪到错误的逻辑，该代码旨在自动将现有的普通用户帐户转换为合作者帐户。”

## 为什么目前的安全解决方案检测不出来？

步骤 3 中的[漏洞利用](https://devops.com/?s=breach)看起来很简单，只需要一个 HTTP 请求:“POST/admin/settings/account/approve/<id>”从 WAF/RASP 的角度来看，授权利用通常是合法的；它们不包含可疑的负载或字符，奇怪的 HTTP 头或异常的结构。事实上，如果相同的 HTTP 调用是由不同的商店经理用户发送的，这将是完全合法的。

![](../Images/0ccdbdac9184c2ea50cc7c54c768bc34.png)

为了理解授权利用，需要更广泛的背景。只看一个 HTTP 请求是远远不够的。

## 可追溯性如何解决问题

我们检测 API 攻击的方法非常不同。简单来说，我们观察的是通过 API 和 app 的微服务传递的数据。然后，我们使用我们的机器学习算法来发现应用程序的业务逻辑。我们可以全面了解用户及其角色、他们与之通信的 API 端点以及端点在幕后交互的资源。现在，我们可以对合法用户在系统中的流动有一个基本的了解。

对用户的可见性有助于我们理解客户机实际上是一个来宾用户，对 API 的可见性有助于我们认识到端点是一个管理端点，只应由商店经理使用。然后，我们可以简单地阻止恶意的异常活动。

使用[这种方法](https://www.traceable.ai/product#technology)，我们可以检测最复杂和最微妙的 API 攻击，包括破坏功能级授权(BFLA)。

![](../Images/b2c6651887c2402d2c17b33eaf152c49.png)

## 有兴趣了解更多吗？

观看我们录制的演示和[看到可追溯的国防人工智能在行动](https://www.traceable.ai/view-traceable-demo)！