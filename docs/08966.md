# 2021 年最佳——如何撤销 JSON Web 令牌(jwt)

> 原文:[https://devops.com/how-to-revoke-json-web-tokens-jwts/](https://devops.com/how-to-revoke-json-web-tokens-jwts/)

随着 2021 年的临近，我们 DevOps.com 想要突出今年最受欢迎的文章。以下是我们 2021 年最佳系列的第十七期。

关于 [JSON Web 令牌](https://devops.com/?s=JSON+web+tokens) (JWTs)最常见的一个问题是:一旦它们被发布，如何撤销它们？

## 什么是 jwt？

JSON Web 令牌是可移植的、符合行业标准的身份令牌。它们是在中央身份服务器发出登录请求后颁发的，用于识别和认证用户并授予对资源的访问权限。它们可以由客户端(如浏览器和外部程序)呈现。应用程序和 API 可以检查它们，以确保调用者得到正确的身份验证和授权。

## 涉及的挑战

最常见的问题之一是如何撤销它们。问题是，一旦它们被发布，就不需要与身份服务器进行进一步的通信。这是 JWTs 去中心化的一个主要好处。

假设您使用 RSA 公钥/私钥签名进行安全数据传输。IdP 使用私钥签署 JWT 后，任何拥有公钥的服务都可以验证令牌的完整性。

让我们以 Todo-Backend API 为例。该架构可能看起来像这样:

![Todo API](../Images/e21f25a837e2435302164f62ec35a8ad.png)

现在，Todo-Backend 可以使用 JWT 和公钥来验证用户的 ID 和其他属性，然后使用该 ID 对该用户的数据执行操作。一旦发布了 JWT，Todo-Backend 根本不与身份提供者通信。因此，如果管理员在身份提供者中锁定或删除了该用户的帐户，Todo-Backend 不会知道。

## 使用分布式事件系统管理重定位

撤销对受 JWT 保护的资源的访问的最常见方法是将其持续时间设置为一个较短的时间段，并撤销刷新令牌，以便用户无法生成新令牌。这并不能撤销 JWT *本身*；它确实解决了根本问题，即限制访问。

换句话说，您可以将 JWT 的到期持续时间设置为较短的时间段(例如，从几秒钟到十分钟)，并将刷新令牌的到期持续时间设置为较长的时间段(例如，两周或两个月的窗口)。

在正常流程中，Todo API 将接受 JWT，直到它过期，届时访问将被拒绝。此时，客户端可以向身份提供者提供刷新令牌，身份提供者会向客户端发送新的 JWT。新 JWT 的有效期还有十分钟。

管理员可以在身份提供者处随时撤销刷新令牌。持有该刷新令牌的客户端对新 JWT 的任何后续请求都将失败，并且对 Todo API 的访问将丢失。

然而，虽然 10 分钟并不算长，但这个时间框架仍然存在风险。

应对这一挑战的一个战略方法是建立一个分布式事件系统，当刷新令牌被撤销时通知服务。一旦接收到该事件广播，后端/服务将更新列出具有被撤销的刷新令牌的用户的本地缓存。在验证了 JWT 之后，将检查该缓存以确定是否应该撤销访问。

这种分布式事件方法真正撤销了 JWT，而不是简单地等待它过期，如上所述。

## 撤销 jwt 的示例

这里有一个示例解决方案，它提供了对事件和 webhooks 的支持，可以用来实现这个撤销策略。在本例中，当用户注销或撤销其刷新令牌时，会发出一个 **jwt.refresh-token.revoke** 事件。这包括用户 ID 和发生撤销的应用程序。它还包括该应用程序的 JWT 寿命(在下面的例子中，为 600 秒)。因此，从接收到该事件的时间点起 600 秒之前为该用户颁发的任何 JWT 都将被撤销。

例如:

*   用户登录，JWT“ABC”在下午 1:11 发布。JWT 直到 1:21 都是好的
*   用户在 1:15 退出。添加了一个条目，声明此应用程序和用户在 1:25 之前到期的任何 JWT 都将被撤销。
*   应用程序在 1:16 尝试使用 JWT“ABC”。Todo-Backend 不传送数据，因为此 JWT 在 denylist 上。
*   用户登录，新的 JWT“def”在 1:18 发布。JWT 在 1 点 28 分之前有效。
*   应用程序试图在 1:19 使用 JWT“def”。Todo-Backend 传递数据，因为这个 JWT 在 1:28 之前有效，因此不在 denylist 上。

![JWT Revoke](../Images/6c8be8e3ece790d683f6ae480149e132.png)

您需要做的是编写一个简单的 webhook 来接收这个事件，并通知 JWTManager 这个用户的 applicationId 的刷新令牌已经被撤销。

![JWT webhook](../Images/51c720a22fd798104e79b41fc9264025.png)

JWTManager 维护一个 JWTs 被撤销的用户 id 列表。你也可以使用 JWT 身份证(` jti '索赔),这在某些情况下可能更简单。JWTManager 还启动一个线程来清理缓存，以删除过期用户并避免耗尽内存。

![Is valid](../Images/0efdade4754d135df97ee9b1a70df0b7.png)

对于每个 API 调用，除了应该对 JWT 执行的所有其他检查(验证签名、过期、发布者等等)，后端需要用 JWTManager 检查有效性。

![configure webhook](../Images/8488221f287bce974fbc25da0e6f33e0.png)

最后一步，配置 webhook:

![JWT webhook](../Images/f60d2ef27878d46cffd149b87844abf7.png)

## 简化的撤销过程

使用上述过程，您可以撤销用户的刷新令牌，并使用 webhook 广播事件。然后，webhook 接收者更新 JWTManager，这将使该用户的 JWTs 不可用。

好消息是，您可以使用 webhook 和事件系统将这个特性快速构建到您的应用程序中。您还可以将 JWTManager 实现编写到 Java、Node 和其他客户端库中以备将来使用。其他语言，比如 Ruby，已经编写了 denylist 实现。

最终，所有需要的是刷新令牌的使用、支持刷新令牌撤销的 API 和分发撤销事件的系统。这种解决方案应该适用于大多数系统，甚至是具有大量后端的大型系统。