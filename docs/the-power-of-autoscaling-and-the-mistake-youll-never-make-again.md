# 自动缩放的力量和你永远不会再犯的错误

> 原文：<https://devops.com/the-power-of-autoscaling-and-the-mistake-youll-never-make-again/>

许多年前，当我作为一名软件工程师实习时，我犯了一个错误，这个错误可能会结束我刚刚开始的职业生涯…

那天是我的生日，我被分配了向数据库加载查询的任务。任务很简单——即使在那时，我还只是一个学习手艺的实习生。我用一个程序来自动上传查询。看起来程序运行得很好，所以我决定回家让程序通宵运行。

第二天在办公室，我遇到了所有实习生最可怕的噩梦:一切都停止了。这都是我的错。这些查询的加载效率低得令人瘫痪。事实上，它占用了我们公司服务器的所有处理能力，使它崩溃了。所有的操作都嘎然而止…只是为了我那微不足道的查询项目。

运营团队花了几个小时才让一切恢复正常。幸运的是，我没有失业。事实上，该公司最终优雅地处理了这一情况，这对我来说是一个很好的学习机会。

如今，这样的事情是完全可以避免的，这都要感谢自动缩放的魔力。就在 10 年前，获得更多的服务器空间是一个缓慢而僵化的过程，由少数几个看门人负责。现在，任何人只需点击几下鼠标就可以获得更多的服务器空间。

处理服务器的民主化彻底改变了互联网。它给了任何组织几乎无限的处理能力。从战略角度来看，自动缩放可以实现更加灵活敏捷的处理基础设施。如果以临时或仓促的方式实施，您的组织将会在看不到自动伸缩的全部潜力的情况下花费过多的资金。

要制定成功的自动扩展部署策略，您需要回答以下三个问题。

## 您应该自动缩放什么？

在自动缩放出现之前，预测服务器需求需要大量的猜测。想象一下，例如，一个及时有效的广告突然给一家销售太阳镜的公司带来了 1000 倍的流量。如果公司没有为这种流量高峰做好准备，一切都会嘎然而止。订单得不到满足，有些订单甚至无法完成，因为服务器空间没有准备好处理意外激增的数量。

通过自动扩展，可以根据系统管理员设置的条件，自动将处理能力转移到新的服务器上。这不仅在流量峰值的情况下有价值，而且在滞后期也有价值。这是一种避免为不使用的处理能力付费的方法。

在任何组织的计算架构中，都有许多组件可以自动扩展，无论是中央处理器(CPU)、随机存取存储器(RAM)还是带宽。第一步是收集尽可能多的数据，以了解每个项目的当前运行负载。任何使用 Amazon Web Services (AWS)的组织都可以访问一些数据监控服务，但它们往往非常基础。总比什么都没有好，但是还有其他的选择。

一种选择是[黑盒测试](http://softwaretestingfundamentals.com/black-box-testing/)，它允许您通过监控来测量基础设施中的各种组件。在许多事情中，它可以帮助您确定哪里出现了瓶颈。[elastic search](https://www.elastic.co/)是另一个在文档或数字框架中进行单词搜索和元数据收集的优秀资源。

评估自动伸缩需求的另一个有效工具是一种叫做“代理”的东西。它通过发送脉冲来测量整个系统的处理数据。像这样收集数据将为您提供关于处理基础设施状态的重要见解。

一旦你收集了所有这些数据，一个彻底的分析是有序的。目前，分析这些数据必须手动完成，但过不了多久，机器学习将负责这部分过程。考虑应用程序的所有层(前端、后端、数据库)来有效地自动伸缩是很重要的。考虑到扩展的容易程度，随意扩展是很有诱惑力的。警惕滥用这种能力。否则，用不了多久，你就会花一大笔钱买你不需要的东西。

## 您应该如何自动缩放？

在决定使用自动伸缩方法之前，需要理解的一个重要概念是[容器](https://aws.amazon.com/what-are-containers/)。容器是用来执行特定功能的小段代码。通过这种方式，一台机器可以包含几个用于执行各种功能的应用程序:CPU、RAM、带宽、磁盘空间等。

容器是一种复杂的方式，可以让您在使用服务器空间时变得更有创意，甚至在您开始构建垂直或水平自动伸缩策略之前就应该考虑容器。现有硬件中更好的算法可以帮助您避免购买新的硬件。在任何情况下，一旦您决定自动伸缩，容器应该是您制定策略和构建时最应该考虑的。

然而，尽管容器可以很好地进行伸缩，但是应该考虑到它们有可能给服务器增加大量的复杂性。例如，如果您的服务器可以运行 20 个容器，但是突然您需要另外三个容器，那么购买一个具有更多容器的新服务器是一个昂贵的解决方案，因为服务器大部分是空的。

原则上，自动缩放有两种方式:垂直或水平。纵向扩展意味着增加更多的物理机，以获得更大的处理能力。目前可用的最大的 AWS 机器服务器(至少据我所知)是 128 个 CPU。这是增加一台服务器所能带来的最大处理增长。像这样一台新机器的价格会有所不同:从每小时 80 美分到 7 美元不等。

另一种方法是水平扩展，这将涉及基于云的解决方案。对于不准备承诺添加新物理服务器的组织来说，这是一种值得考虑的方法。此外，使用水平自动缩放方法，可以动态调整处理需求。

理解并非应用程序的所有部分都可以以相同的方式扩展是很重要的。例如，数据库可以轻松扩展。但是(水平地)放大会花费很多时间。如果您的数据存储在 30 个前端容器中，而您想要扩展到 15 个容器，您无法一步完成。您首先需要从 30 个容器扩展到 28 个，等待数据复制，然后从 28 个容器扩展到 26 个，再次等待数据复制，然后从 26 个容器扩展到 24 个，依此类推。否则，您将面临丢失所有数据的风险。

## 何时应该自动缩放？

考虑上述太阳镜供应商的例子。虽然准确预测您的业务或客户群何时会达到临界点是不可能的，但像发布一个覆盖范围广泛的广告这样的事情肯定是您的组织应该为流量的突然激增做好准备的实例。您的业务决策应该是深思熟虑的，以便提前了解像这样的行动的潜在影响，以及它们对您的组织架构造成的压力。

预测需求的高峰和低谷是企业几个世纪以来一直在做的事情。比如，在哥伦比亚，公用事业公司早就明白了“阿雷帕小时”的力量:这是哥伦比亚人在家吃早餐的时候(具体来说就是阿雷帕，哥伦比亚的一种传统早餐食品)。知道全国大多数人可能在早上 7:30 到 9:30 之间的某个时间在家中消耗电力，这是一个关键的数据点，可以让公用事业公司为这种不成比例的高需求水平做好准备。

决定企业自动扩展需求的“平均时间”的难题通常归结于 CPU 和内存。当您的站点超过预定的 CPU 负载时，您是否应该准备好自动伸缩？还是应该基于服务器上运行的内存？

答案真的都不是。没有“黄金标准”可以为您的自动扩展策略指明方向，您永远不应该孤立地根据单个数据点来决定扩展。例如，当处理能力达到 90%时，将处理数据卸载到新的服务器上可能是有意义的，但是在这种处理负载下，您的应用程序继续完全正常地运行而不出现任何问题也是完全可能的。

你的目标应该是在效率和不损害那些访问你的网站或使用你的应用程序的用户体验之间取得平衡。做到这一点的唯一方法是从整体上考虑所有的数据点，以及它们之间的交互方式，而不是孤立地考虑。

## 结论

我们已经过了这样一个时代，一个加载失礼信息的查询，比如我在实习时犯下的错误，可以完全关闭一家公司的处理活动。考虑到处理服务器变得如此容易访问，一些人可能会发现“暴力”解决每个问题的诱惑:点击几下鼠标，随意支付更多的服务器空间。不要受刺激而走捷径。通过回答这些看似基本的问题，从战略上考虑自动扩展，从长远来看，您实际上会使您的组织变得更容易(并且更具成本效益)。

亚历杭德罗·卡尔德龙