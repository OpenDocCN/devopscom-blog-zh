# DevOps 聊天:与 Miles Matthias 一起监控 GKE 上的三角帆

> 原文:[https://devo PS . com/devo PS-chat-monitoring-spinnaker-on-gke-with-miles-Matthias/](https://devops.com/devops-chat-monitoring-spinnaker-on-gke-with-miles-matthias/)

在一个将谷歌的财富 500 强客户之一转移到谷歌云、谷歌 Kubernetes 引擎(GKE)和 Spinnaker 开源的项目中，我们的 DevOps 聊天嘉宾遇到了一条消息“坚持住”没有脚本或文档。Container Heroes 的谷歌云顾问 Miles Matthias 毫不迟疑地填补了这一空白，并将其工作回馈给了 Spinnaker 社区。

DevOps Chats 的这一集预告了 Mile 的演讲，“用 GKE 的普罗米修斯操作员监控 Spinnaker”，他将于 11 月 16 日星期六下午 3:45 在 2019 年 Spinnaker 峰会上发表演讲。在这一集里，迈尔斯也谈到了很多关于金丝雀测试的事情。

像往常一样，下面是流媒体音频，然后是我们的谈话记录。

[https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/693083446&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true](https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/693083446&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true)

## 副本

米奇·阿什利:大家好。我是 DevOps.com 的米奇·阿什利，您正在收听的是另一个 DevOps 聊天播客。今天，Miles Matthias 加入了我的讨论，他是 Google Cloud 的顾问，也是 Container Heroes 的成员，这是一家很棒的公司。我们今天的话题实际上是他在 2019 年 Spinnaker 峰会上讲话的预览。他的主题是在 GKE 环境中用 Prometheus 操作器监控 Spinnaker，Google Kubernetes 引擎。他的演讲是在 11 月 16 日周六下午 3:45。迈尔斯，欢迎来到 DevOps 聊天。

嘿，米奇。很高兴来到这里。我对大三角帆峰会感到非常兴奋。

阿什利:好吧，告诉我们一些关于你的事情，你做什么，以及一些关于集装箱英雄的事情。

马提亚斯:是的，当然。正如你所说，在 Crowd Consultant，我在职业生涯中完成了大量的软件开发、基础架构设置和架构设计，现在我正在帮助其他公司设置云基础架构、进行迁移、实现应用程序开发的现代化，以及诸如此类的事情。我是 ContainerHeroes.com 的一名合伙人，我们是一群像我一样的人，他们曾在以前的初创公司担任 CTO，他们完成了整个 PC 路线，我们在整个职业生涯中为客户构建了一系列定制应用程序，现在我们喜欢咨询使用云的人。

在过去一年左右的时间里，特别是我想是过去的九个月左右，我们的一个大客户，我们一直在帮助 Google 的一个新客户完成从 prem 到 cloud、到 Kubernetes 的容器化迁移，他们利用了 Spinnaker。所以，我作为 Spinnaker 的专家来帮助他们启动并运行它，帮助定制他们环境中需要的东西，并尽可能地为开源做出贡献，包括一些我为使用 Prometheus Operator 构建的东西，我们可以稍微接触一下。以至于后来团队邀请我在大会上做演讲，所以我对此很兴奋。

Ashley: 听起来是一个非常相关的演讲，尤其是分享你与这位谷歌客户合作的经验。

马提亚斯:是啊。

**Ashley:** 那么，请告诉我们一些关于你何时参与这个项目，以及何时开始与客户合作的信息。你以前和 Spinnaker 一起工作过吗，那是一项新技术吗，或者是这些新技术中的任何一种，或者你以前做过这些？

**马蒂亚斯:**所以，我之前做过一堆 CI/CD。Spinnaker 还处于早期阶段，所以我对 Spinnaker 作为应用程序的经验非常有限。它仍然——是的，它在开发领域仍然处于萌芽状态。持续交付的整个概念在行业中仍然非常新，尽管它已经存在了一段时间。

因此，CI 已经得到了很好的发展，每个人都知道 Jenkins，每个人都有 ____，一百万个 CI 工具，持续交付的内容和经过深思熟虑的、复杂的交付策略可以帮助您进行更自动化的持续交付，如 canary 分析、不同的部署类型和自动回滚等，所有这些都是全新的，显然 Spinnaker 在这方面帮助很大。

是的，我有一些经验，但我真的很高兴能投身于这个行业中真正起飞的东西。

**Ashley:** 请告诉我们一些关于你面临挑战的应用程序的情况。我知道这已经是，已经开发了与詹金斯和 Spinnaker 之前，然后你把它转移到 GKE，还是什么？

**Matthias:** 没有。所以，客户有 50 个不同的工作申请，一堆不同的东西，都在本地运行。因此，大部分努力显然是将他们迁移到 Google Cloud 上，但也帮助他们开发 CI/CD 流程，允许他们在回购中提交，在 CI 中构建工件，运行测试，然后将这些传递到 Spinnaker 和 CD，然后部署到 GCP。

他们没有使用 Spinnaker 的经验，也没有任何类型的 CD 解决方案设置，特别是对于云。就像我说的，他们对云完全陌生，所以这对他们来说是全新的东西，所以我帮助他们设置、安装、配置我们想要的所有选项，管理它，然后随着项目越来越多地迁移到 GCP，引入越来越多的高级功能。

阿什利:嗯。因此，听起来更传统的 Java 应用程序环境可能还不是持续集成。他们也这样做了吗？

是的，他们让詹金斯在 prem。

阿什莉:他们真的这么做了？

马蒂亚斯:所以我们——你知道，是的。因此，该架构将一切都转移到了 Kubernetes，因此，GCP 的一个项目拥有专门用于 CI/CD 的 GKE 集群。所以，让詹金斯和大三角帆接手。因此，他们将 Jenkins 放在 prem 上，并将其转移到云上，托管在 Kubernetes 上，然后我们在同一个 GKE 集群上安装了 Spinnaker，对吗？

阿什利:嗯。

**Matthias:** 然后使用这些工具作为其 CI/CD 管道的基础，为他们部署到云中的其他集群。

Ashley: 应用程序的大小怎么样？你如何量化它有多大或多广？

**Matthias:** 如我所说，他们有一个——这是一个真正的微服务组织。所以，你知道，他们有 30 到 50 个不同的应用程序作为微服务，每个都单独部署。就流量而言，我的意思是，正如我所说，这些应用程序是微服务，因此它们本身非常小。

就流量和资源使用而言，它是一个非常非常大的客户端。比如，突破我们见过的一些最大事物的界限。

阿什莉:嗯。好吧。

马蒂亚斯:所以，这真的很令人兴奋，真的很酷。

阿什利:我知道这是一家财富 500 强公司。

马提亚斯:是啊。

阿什利:我们不是在谈论具体的公司，但是—

当然，是的，是的，是的。

阿什莉:嗯，很好。那么，你打算谈些什么呢？我的意思是，我知道这是关于它的监控方面，所以你知道，你是不是在谈论 Prometheus Operator，以及可能如何配置它或如何决定它，以及创建什么样的分组，什么样的规则和警报等诸如此类的事情？你会谈论更基础的建筑吗？你有什么想法？

**Matthias:** 对每件事都有一点了解，因为这是某种必需的设置，以便进行监控和金丝雀分析，即使你要使用普罗米修斯进行金丝雀分析指标。如果您在 Kubernetes 上运行 Spinnaker，这也是您希望如何设置的基础。

所以，关于 Spinnaker 作为一个项目的一点背景，我相信熟悉 Spinnaker 的其他人肯定知道，您自己可能也知道。大三角帆最初是由网飞创造的。网飞仍然是一个虚拟商店，对吗？所以，他们不使用 Kubernetes，一切都在单独的实例上运行。因此，Spinnaker 可以部署为在 Kubernetes 上运行，这种支持是存在的，它支持将应用程序部署到其他 Kubernetes 集群。

但仍有一些事情，比如监控，比如金丝雀分析，在 Kubernetes 世界中，我们做事情的方式略有不同，普罗米修斯就是其中一个例子，对吗？在 VM 世界中，你启动 Spinnaker，你启动一个 Prometheus 实例——Prometheus 显然是一个收集指标的指标存储库，然后通常与 Grafana 和 ____ 等类似的东西配对，以便——所有 CNCF 开源项目，以便给你这些指标的图表。

因此，以前在 Spinnaker 的虚拟机世界中，像网飞一样运行它，Spinnaker 的微服务进行监控，连接到 Spinnaker 的所有不同组件，监听它们的指标，然后将其报告给 Prometheus。酷毙了。就像，看起来很棒。他们甚至有一些仪表板。

所以，Grafana 仪表板，如果你曾经使用过，你可以上传一些 JSON 文件到你的仪表板，然后你点击那里，然后你会说，“嘿，看看这些仪表板！”您可以获得基于 Spinnaker 的普罗米修斯指标的实时仪表板。Spinnaker，它由所有不同的组件组成，并且基于它所做的事情有不同的指标，所以当它处理您的部署时，您可以在那里看到，这里有一些指标，对吗？

阿什利:嗯。

马蒂亚斯:所以，所有的支持都在那里。但是，当你想在 Kubernetes 上运行 Spinnaker 时，这种支持就有点…不那么多了。*【笑声】*

阿什利:嗯。

马蒂亚斯:这就是我们遇到的麻烦。因此，这里的概念是，“嘿，我们在 Spinnaker 中有这个监控组件，”如果您启用了监控，该监控组件将作为 sidecar 容器被启用到 Spinnaker 组成的每个单独的 pod、每个单独的微服务，并且它知道如何与该微服务对话并从中获取指标，然后在某处报告它。

酷——很好。好吧，我能理解。那么，监控服务如何获得从所有不同组件收集的指标，并将其放在某个地方呢？理想情况下，普罗米修斯，你也可以做 Stackdriver，或者，我相信现在可能有 Datadog 支持，但主要是，我们看到的两个使用很多，Stackdriver 和普罗米修斯。

阿什利:嗯。

**Matthias:** 然而，在 Kubernetes 世界中，尤其是当你有一堆不同的 Kubernetes 集群时，你最终使用的工具之一叫做 Prometheus Operator。这实际上是一个 Kubernetes 操作器，当您应用到您的群集时，它会自动为您安装 Prometheus Grafana，这是一个警报管理器，作为 pods，部署在您的群集上运行。这是一种配置基础设施的方式，这样当您在这些集群中部署一系列应用程序时，您就已经建立了一些监控基础设施，对吗？我可以部署，我基本上可以去我的组织说，“给我一个新的集群，然后我可以部署我的应用程序，并开始接受 Prometheus 指标，集群上已经有一个 Prometheus 实例，所以我准备好了。”

为了获得普罗米修斯，普罗米修斯操作员创建的普罗米修斯版本，然后从已经存在的 Spinnaker 监控组件获取指标，并且已经知道如何从 Spinnaker 不同的组件获取这些指标，您必须连接这两端，对吗？在 Prometheus 运营商 Kubernetes 的世界中，基本上，您只需应用 Kubernetes 清单，即称为服务监视器的 CRD，它基本上会告诉集群上的 Prometheus 实例，“嘿，去从这些地方获取指标”，对吗？这很简单，但是在 Spinnaker 中没有设置方法。因此，您可以阅读 Spinnaker 中的文档，这些文档非常详细、非常好——比如，如果您在虚拟机上运行 Spinnaker，并且想要进行监控，并且想要使用 Prometheus，只需使用这个漂亮、简单的设置脚本，对吗？

阿什利:嗯。

**马提亚:**超级好听。太好了。然后在文档中，它说，“如果你在 Kubernetes 上运行。挺住，支援来了。”*【笑声】*

**Ashley:** *【笑声】*“抓紧”文档功能。精彩！

马提亚斯:坚持住——对，没错。所以，这些都不复杂。有很多不同的组件，你必须小心如何设置它们，对吗？但是，非常好的安装脚本，可用于在虚拟机上运行普通的旧普罗米修斯非常好，就像我说的，它为您安装了一堆 Grafana 仪表板，并为您做了一堆好东西。库伯内特没有这种东西，对吗？

**阿什利:**嗯哼，嗯哼。有点从零开始。不完全是，但至少迈出了下一步。

**马提亚斯:**一点不错，一点不错，一点不错。因此，我所做的和我对这个项目所做的就是创建一个设置脚本，确切地说，“嘿，你有一个集群，你已经在那里安装了 Spinnaker，你已经在那里安装了 Prometheus Operator，你可能还在一堆其他集群上安装了 Prometheus Operator。这里有一个设置脚本，它将 Prometheus 实例连接到 Spinnaker，以便 Prometheus 可以获取有关 Spinnaker 如何运行以及 Spinnaker 如何处理您的部署的指标。”

阿什利:嗯。

**Matthias:** 安装了一堆 Grafana 仪表板，这些仪表板是开源项目已经为我们创建的，我们可以说，“这是关于每个微服务的 Grafana 仪表板——Clouddriver、Gate、Orca 等，它们在 Grafana 中都有自己的仪表板，你可以去看看，它们是预先配置的，非常好，非常整洁。”同样，这些只是必须被转换成你在普罗米修斯运营商世界中应用这些的方式，同样，应用你的 Kubernetes 清单来说，“嘿，它实际上只是一个上面有特定标签的配置图。”“嘿，这是一个仪表板，”当您应用它时，Prometheus 操作员知道如何连接到 Kubernetes 主程序，并说，“嘿，这是一个新的配置图，是一个 Grafana 仪表板。让我去把它拿来，然后帮你加到 Grafana 里，好吗？这就是普罗米修斯算子的全部目的。

这就是我刚才所说的，给你的东西——现在，然后我把它放到文档里。所以，现在，当你去看文档时，它说，“嘿，如果你在 Kubernetes 上运行 Spinnaker 和 Prometheus Operator，也有一个适合你的奇特的设置脚本！”*【笑声】*

阿什莉:给你。现在人们将不得不从你做的同样的地方开始。

马提亚斯:是啊，真的。

**Ashley:** 那么，你的计划，在你的演讲中，实际上是通过这个，你建立的脚本的过程，以及如何设置所有这些，让仪表板出现，等等，还是你已经采取了一种稍微不同的方法？

Matthias: 我不想激怒演示神，所以我不确定我是否真的会，你知道，输入它，运行实际的脚本，但我肯定可以设置一些东西，就像“嘿，这是最终结果。让我们一步一步地看脚本实际上在做什么，以帮助您理解哪些组件需要在哪里匹配，然后这是最终结果，“对吗？

我在演讲中可能会提到的另外几件事是——这就是为什么它很重要。因此，所有这些都是将 Spinnaker 作为一个应用程序来监控。因此，就像，你的开发人员或你的发布工程团队，参与这些事情的人将把 Spinnaker 作为一个应用程序来监控，他们会看到，“哦，Orca 不堪重负，它的队列中有一堆任务不能弹出，所以让我们添加一些 Orca 的副本”或类似的事情。

这个脚本帮助您设置了这个控制面板来查看性能和指标，对吗？

**阿什利:**嗯哼，嗯哼。

**Matthias:** 其他重要的原因是，我将谈到的其他事情是，首先，我可能会谈到的一件事是，目前正在努力工作，我希望到演讲时，可能会有更多的努力，但在 Spinnaker 社区中并没有太多的指导，“好的，这是我们发布的指标。这是它们的含义，如果它们超出正常范围，这是你应该采取的补救措施。”

阿什利:嗯。

对于如何应对 Spinnaker 实例在极端负载下或有点偏离配置之类的情况，没有任何操作手册。

**阿什利:**有意思。

Rob Zyner 领导着网飞的努力。他写了一篇很棒的博文，讲述了一些指标之类的东西，以及它们各自的含义。但这是唯一的资源。因此，社区中有这样的努力，“嘿，让我们把一些实际的操作手册放在一起，把我们在 Grafana 中的一些仪表板和一些指标匹配起来，并能够告诉人们，‘嘿，如果你遇到这种情况，这里是要检查的步骤 1、2、3，如果是这种情况，那么这里是缓解该问题或如何解决该问题的三个选项，”对吗？

阿什利:嗯。

**Matthias:** 因此，希望在 11 月的会议上，我们可以在机构群体中取得一些进展。

关于这个话题，我可能要说的另一件事，以及为什么普罗米修斯算子的概念在 Kubernetes 世界中如此重要，是为了 canarying。

**Ashley:** 简单介绍一下您的部署流程中的 canarying。

马提亚斯:是的，当然。当然，金丝雀测试是——它是一种评估你的一个候选版本的测试形式。它将它与—它所做的是，它实际上运行您的候选，它运行正在生产中运行的版本，启动它的新拷贝，并并排运行它。因此，它通常会分流少量流量，或者，你知道，在一个服务后面会有 100 个 pod，你可以添加 2 个 pod，这样它们就会获得相应的少量流量。你会运行它，你会看到它如何执行。你会听到这些指标，你会看到，“哦，这就是你想要推荐的候选人的表现。”在 canarying 中，在 Spinnaker 的配置中，你可以说，“这些是我在评估时关心的指标，当决定它是否表现良好时，如果它表现不佳。”

例如，假设您有一个新版本的应用程序，每个请求都会出现 500-500 个错误，对吗？你运行了一堆单元测试，你运行了一堆集成测试，理想情况下，在这一点上，在这些步骤中的一个或更早的时候，你会发现的，对吗？但是测试是由人编写的，有时人们不编写测试，或者有时一些依赖于实时流量和实时数据的情况实际上暴露了一些类型的问题，对吗？

所以，让我们假设你有一个新的版本出来，它只是到处都是 500。canarying 所说的，其背后的理论是——让我们实际上在少量流量上运行它，让我们看看它做了什么。然后金丝雀会说，“哦，嘿，你想推出的发行版？它只是执行一堆 500，您告诉我，在您的配置中，如果您看到如此多的 500，这是不好的，我们实际上不想将它部署到生产中运行的所有 100 个实例，“对吗？

那个 canarying 说，“嘿，这不是一个好东西推广，”对不对？比如，“我给了它一个机会，我在一些东西上运行了它，我将它与当前运行的版本或我们当前运行的版本的新实例进行了比较，它做得不好。所以，你知道吗？我要出错了，我要向你们展示这是如何表现的，你们去修复它，然后当我回来时，我会再次运行这些东西。如果它表现良好，那太好了，我们可以发布新版本。”

这是持续交付所需的主要组件之一。因为你可以想象一个世界，在那里开发者只是承诺，承诺，承诺，承诺。

阿什莉:嗯，是的。

Matthias: 他们做了一系列测试，他们进行了一些测试，对他们来说一切都很好。这里还有另一个自动组件，它正在进行金丝雀分析，可以对它进行测试，它实际上可以将它投入生产，给它一点流量，看看它的表现如何，如果它表现良好，就让它去吧，你知道吗？推广一下吧？

阿什莉:对，那非常有用。

Matthias: 周五部署，周六部署——谁在乎呢，对吧？它实际上是在观察它是如何运行的，很明显，在它达到那个点之前，所有其他测试都已经通过了，如果它运行良好，那么就运行。这就是为什么像谷歌、网飞和其他公司一天能部署数千次的原因，因为它有这个自动化系统，可以输入并说，“给它一些流量，看看它是如何运行的，如果它运行良好是因为我们配置的方式，我们告诉系统运行良好意味着什么，对吗？太好了——那就随它去吧。”

阿什莉:我们有点在和时间赛跑。我还有最后一个问题。

**马提亚斯:**当然。

阿什莉:什么样的人应该来听你的演讲？显然，这看起来像是开发人员，从事 CI/CD 管道工作的人，可能是 DevOps 工程师。你会推荐其他人吗，或者这些人是合适的吗？

马提亚斯:这些绝对都是合适的人选。我认为，如果您对 Spinnaker 感兴趣，或者您目前正在使用 Spinnaker，希望了解如何将它作为一个应用程序进行监控，并在它经历大量负载时将其作为一个应用程序进行管理，以及如果您在 Kubernetes 上运行它，并且您正在运行多个其他也使用 Prometheus Operator 的 Kubernetes 集群，您希望如何连接所有的点，这是一个非常值得一听的演讲。

阿什利:迈尔斯是 ContainerHeroes.com[的谷歌云顾问](https://www.containerheroes.com/)。他在圣地亚哥举行的 2019 年 Spinnaker 峰会上发表讲话。现在，会议是 11 月 15 日到 19 日。他的谈话，再次，是关于在 GKE 的普罗米修斯操作员在星期六 3:45 监视三角帆。感谢大家的参与。您已经听到了另一个 DevOps 聊天。这是 DevOps.com[的米奇·阿什利。在外面要小心。](https://devops.com/)

— [米切尔·阿什利](https://devops.com/author/mitchellashley/)