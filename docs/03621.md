# 使用 Inspec 验证基础架构

> 原文:[https://devops.com/infrastructure-validation-with-inspec/](https://devops.com/infrastructure-validation-with-inspec/)

所以，我们在新西兰一家较大的金融公司工作，在码头集装箱上建造一个复杂的基础设施。它有配置、SSL 证书、DNS 条目和所有其他调味所需的调味品，以增加美味的基础设施咖喱。虽然我们能够使用自动化配置管理工具从零开始建立完整的基础架构环境，但我们并不确定它是否真的正常工作，或者说它是否按照预期的方式工作。摆在我们面前的问题是，有没有一种方法可以声明我们的基础架构的理想状态，然后根据它来验证我们的基础架构？

## 检查救援

在过去的几年里，开源工具 [Inspec](https://www.inspec.io/) 在实现基础设施的安全合规性方面取得了相当大的成功。语法/结构非常简单。例如，让我们考虑下面的代码片段。理解它并不需要很多编程知识。不是吗？

![](../Images/165907c946a6022a0e82b8b9967421d7.png)

**这让我们想知道，如果我们使用 Inspec 来验证我们的基础架构设置会怎么样？如果我们用一种易读的声明性语法来映射我们的基础设施配置，会怎么样？如果这真的解决了我们的问题呢？**

**按照 DevOps 的最佳实践，我们从一个简单的实验开始；一个可以解决实际问题的实验。我们有一个 docker 主机，它应该有一个特定的 Docker 容器在里面运行，但由于某种原因，它经常失败。我们决定在 Inspec 中编写一个测试来检查这个容器是否在这个主机上运行:**

**![](../Images/1b71886cf2531dac265c4cb63f6db83f.png)**

****…并尝试执行测试。****

******![](../Images/7b352a3631477de880a5d2a3c79d46df.png)******

******这正是我们想要的！******

******这一成功让我们兴奋不已，我们开始编写一组测试来验证我们基础架构的每一个组件。一天之内，我们就完成了 192 项测试。测试的数量没有测试覆盖的范围和广度重要。一旦测试完成，我们将它们插入到我们的基础设施管道(使用 [Jenkins](https://jenkins.io/) 构建)中，以确保组件与期望的状态保持一致。我们称之为“组件就绪”测试。******

******![](../Images/fb89294265517edb0ed81c9a4f9ac9cd.png)******

******到目前为止一切顺利。******

******既然我们的组件符合期望的状态，我们是否仍然有信心我们的平台会按照我们预期的方式工作？也许我们还需要一些“平台准备测试”。我们也可以用 Inspec 来做吗？答案是:是的！******

******![](../Images/8bbe64f199d5bd2f6ad055a4e9832b01.png)******

******既然平台就绪测试已经准备好了，我们扩展了我们的基础设施管道，将它们也纳入进来。******

******![](../Images/3ca52bb4b71148f0cb978f6985b2adcd.png)******

******使用 Inspec 设置我们的组件和平台就绪性测试还有一个更好的功能:基础设施的实时文档。Inspec 允许以多种报告格式显示审计结果，包括 JUnit、JSON、HTML 等。我们使用 JUnit 报告格式，并使用 [Jenkins JUnit 插件](https://plugins.jenkins.io/junit)显示它们。有了它，我们就能够拥有人类可读的 JUnit 报告，并将其作为我们基础设施的实时文档。******

******![](../Images/98af131b69386a12a7cb9aa2de1dec8a.png)******

******不用说，使用 Inspec 进行的基础设施测试为我们的设置和就绪性提供了(非常需要的)信心。我们的管道以这样一种方式设计，即每当我们的生态系统中的任何基础架构组件发生变化时，管道都会被触发，从而重新配置和(如果需要)重建生态系统。这些 Inspec 测试由这个基础设施管道触发，并验证新配置的基础设施设置。由于这一点，我们从来没有遇到过运行在这个基础设施上的客户端应用程序因为不正确的配置而抱怨或中止的情况。此外，如上所述，动态文档有助于记录环境的预期配置。******

******到目前为止，我提到的 Inspec 实现使用免费提供的 Inspec 工具和 Jenkins 平台。Inspec 还可以与 [Chef Compliance](https://www.chef.io/solutions/compliance/) 结合使用，以生成更具描述性的报告和图表。Chef Compliance 还附带了现成的 CIS 配置文件，可用于启动针对安全合规性和审计的 Inspec 实施。******

******Inspec 是一个易于掌握的工具，具有简单直观的结构，可以很容易地开始工作。然而，这种简单有一个缺点。很容易加速前进并掩盖文档，同时错过以更好的方式实现解决方案的最佳实践和技巧/技术。掌握这一点的一个方法是尝试新发布的带有 Inspec 认证的[审计，这为在准备认证时详细浏览文档提供了动力。此外，你还可以展示一个闪亮的徽章来奖励你的努力！](https://blog.chef.io/2018/03/12/auditing-with-inspec-new-chef-certification-exam/)******

## ******概括起来******

******在任何 DevOps 实施中，基础设施验证都是非常重要的一步。除了对安全性符合性测试非常有用之外，Inspec 还可以使用简单且易于理解的声明性语法来验证基础设施。此外，它占地面积小，有一个充满活力的社区在照看它，并且有最新的清晰的文档。这绝对是一个有潜力提供快速有效结果的工具。******

******— [米纳尔·慕克吉](https://devops.com/author/mrinal-mukherjee/)******