# DevOps 聊天:与 Salesforce 一起揭开 Spinnaker VM 烘焙的神秘面纱

> 原文：<https://devops.com/devops-chat-demystifying-spinnaker-vm-baking-with-salesforce/>

Spinnaker Summit 2019 预览:随着您使用像 Spinnaker 这样的开源工具，您开发的最佳实践和知识越多。这些对于与企业内部的其他人和其他开源用户共享非常有用。

Jing Vergara， [Salesforce](https://www.salesforce.com/) 的首席软件工程师，加入了 DevOps 聊天室，分享了她即将发表的演讲“揭开 Spinnaker 虚拟机映像烘焙和部署的神秘面纱”的预览 Jing 与我们分享了在烘焙虚拟机映像时应该包括什么，不应该包括什么，如何避免配置漂移以及如何使用 Cloud-init 文件部署到多个云提供商。Jing 还分享了如何使用 Ansible、Chef 和 Docker 的开源打包器模板，以及如何构建自己的打包器模板。

Jing Vergara 的演讲将于太平洋时间 11 月 17 日周日上午 10:45 举行。2019 年 Spinnaker 峰会将于 11 月 15 日至 17 日在圣地亚哥举行。

[https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/708930157&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true](https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/708930157&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true)

## 副本

米奇·阿什利:大家好。我是 DevOps.com 的米奇·阿什利，您正在收听的是另一个 DevOps 聊天播客。今天，Salesforce 的首席软件工程师 Jing Vergara 加入了我的讨论。Jing 将于 11 月在圣地亚哥举行的 Spinnaker 峰会上发表演讲，她将谈论一个非常有趣的话题，“揭开 Spinnaker 虚拟机映像烘焙和部署的神秘面纱”现在，不要认为我们已经变成了一个烘焙秀。我们正在烘焙虚拟机映像，这就是 Jing 将要向我们介绍的整个流程——流水线操作、创建虚拟机并烘焙它们。*【笑声】*所以，她的演讲是在 11 月 17 日，周日，上午 10:45

静，欢迎来到 DevOps 聊天室。

谢谢你，米奇。

阿什莉:很高兴你能来。

谢谢你给我这个机会在这里演讲。

阿什莉:嗯，我很荣幸你能来。谢谢你在这里。给我们介绍一下你自己。请向我们简单介绍一下您的工作，以及您从事的 Salesforce 产品或代码的哪些部分。

**Vergara:** 当然。所以，我是公司持续部署团队的一员。我们为公司内的所有组织提供 Spinnaker 服务。我帮助团队将他们的运输管道运送到 Spinnaker。

阿什利:哦，有意思。

是的，作为我工作的一部分，我还对 Spinnaker 进行定制扩展，以支持他们的内部业务需求。

**Ashley:** 所以，你可以说是 Spinnaker 服务中心的专家，或者是每个人都去寻求 Spinnaker 实施帮助的团体。很近吗？

是的，非常非常接近，是的。所以，我在车队中的角色一直在改变，但是是的，它已经转变成了那个角色。我为 Salesforce 做的另一件事是，我代表 Salesforce 参加几个 Spinnaker 特殊利益集团的股份保险，这样我可以了解更多关于 Spinnaker 即将推出的功能，这样我们就可以在我们的路线图中利用这些功能，这样我们就知道我们可以向企业提供这些功能。

阿什利:嗯。

**Vergara:** 然后，我们也向 ________ 反馈，让他们知道哪些对我们这些 Spinnaker 用户有用，哪些没用。

阿什利:我注意到你在 Spinnaker 网站上的简历，你拥有伊利诺伊大学香槟分校的计算机科学硕士学位。我过去住在离那里不太远的地方，虽然我没有去那所学校。*【笑声】*

**维加拉:** *【笑声】*

**Ashley:** 这是一个很强的 C.S .学位，听起来你很好地利用了 Spinnaker 和 DevOps 风格的部署，创建了这些管道。

**Vergara:** 对，对。

阿什利:优秀。那么，告诉我们一点关于什么——我们正在谈论你的演讲。那么，请为我们描述一下，关于 Spinnaker 虚拟机映像烘焙和部署，有哪些可能有点神秘、需要揭开神秘面纱的事情。有哪些事情是人们不知道的，你通常需要帮助他们理解，“这是它的工作方式，这是我们的工作方式”？

**Vergara:** 当然。因此，对于传统上处于不使用虚拟机映像的裸机世界的公司来说，这无疑是思维方式的转变，对吗？

阿什利:嗯。

所以，我通常向他们解释的方式是用烘焙的比喻，对吗？所以，当你谈论烘焙时，你会想到把面粉、盐等配料放在一起，对吗？你做一个面团，定型，然后烹饪。你从一种基本的原料开始，比如面粉，然后把它混合起来。

因此，在虚拟机世界中，当您烘焙映像时，您从基础操作系统映像开始。您添加您的其他组件，这意味着安装您的应用程序或您的代理在该虚拟机上运行。然后你有你的标准或常见配置，可能还有一些数据，对不对？

阿什利:嗯。

**Vergara:** 您将它们全部添加到虚拟机中，创建一个快照。因此，这个快照现在可以称为虚拟机映像。因此，您可以将该映像保存到一个存储中，一旦您有了该映像，就可以将其用于部署。因此，部署基本上就是从同一个映像中构建或调配一个或多个虚拟机。

阿什莉:好的。现在，引入这一点，有点开始的事情是，我不确定它在 Salesforce 如何工作，但它是否类似于 Jenkins 流程，然后开始创建图像？这是怎么回事？

**Vergara:** 对。因此，我们有了持续集成系统。所以，我们有一些，我们也在 Salesforce 中标准化，对吗？所以，我们有那些 CI 系统制造的人工制品。我们有我们的 Docker 图像，所以它们被存储起来，我们把它们放到云中，然后我们有触发器。所以，我们倾听这些变化。因此，Spinnaker 支持触发管道的发布/订阅。所以，一旦我们有了这些建筑师，我们就可以开始烘烤过程。

阿什利:太好了。非常好。嗯，这很有道理。你可以把它想象成所有的软件，包括操作系统，这些都是组成部分，对吗？仅仅是图像中的一些元素。

现在，我想如果您正在进行大量部署，这种情况会经常发生，对吗？这种情况是在您每次进行部署时发生，还是仅作为集成过程的一部分发生，然后它可能也会经历一个部署过程，或者您会多频繁地看到这种情况发生？

是的，所以这是为了每一个被签入的代码变更，对吗？理想情况下，您会希望这种变化一直持续下去，因此对于连续交付和部署来说，这是理想的过程。签入，生成工件，并部署那个工件，从它创建一个烘焙映像，然后进行部署。

阿什利:好的，太好了。所以，这是—

是的，所以，但是——是的，是的，没错。但是就像，当我们说交付和部署时，当然，你知道，每个公司都有发布管理和变更管理政策，说“好的，这实际上对生产部署是好的”，对吗？因此，其中一些是持续部署到开发或测试环境，但对于生产，我们仍然希望有这样的门户系统。

阿什利:嗯，是的。

**Vergara:**Spinnaker 实际上非常支持它，你知道吗？它有人工判断阶段，您可以将这些阶段添加到管道中，以获得这些类型的批准。

阿什莉:是的。嗯，我们已经有一些其他人谈到了其中的一些阶段，如 Run Job 和 Webhook，以及一些内置的功能。

**Vergara:** 是的。

**Ashley:** 在 Spinnaker 中也很容易扩展。因此，我认为您计划在 Spinnaker Summit 的演讲中谈论的内容之一可能是您在 Salesforce 做了大量工作后总结出的一些经验教训或最佳实践。关于这一点，你有什么想法想和我们分享一下，你会在演讲中提到哪些最佳实践？

当然，是的。因此，我想与大家分享的一些最佳实践更多地是围绕着烘焙和部署。所以，举例来说，当你烘焙的时候，千万不要在烘焙时间烘焙秘密。*【笑声】*

阿什莉:是的。没有代币，没有钥匙，没有证书，没有—

**Vergara:** 正是。是的，是的。所以，这非常非常重要。因此，这些类型的敏感数据，您实际上可以在部署阶段执行。在部署过程中有一个陷阱阶段，你可以去那里，你知道，连接到一个秘密的商店，像保险库，哈希公司的保险库，对不对？因此，您可以提取这些秘密并将其安装在资源或虚拟机上，对吗？所以，这是更安全的做法，而不是在烘烤的时候烘烤。

另一件事就是尽可能避免配置漂移，对吧？因此，如果您有任何通用或标准配置，无论是您的应用程序配置还是您的操作系统配置，请在烘焙步骤中进行，对吗？因此，尽可能将这些虚拟机配置限制在它们的范围内。同样，您可以在部署期间进行。

阿什利:嗯。

**Vergara:** 然后，对于支持多个云提供商的公司，例如，您需要部署到亚马逊云或谷歌云或其他由 Spinnaker 提供和支持的云，您可以使用 Cloud-init 文件，这样它就不会绑定到某个特定的提供商，您也不必在同一时间重复您的引导步骤。所以，你写一次你的脚本，你的 Cloud-init 文件，然后你就可以在那些不同的云提供商中使用它，所以，我认为，这非常非常有帮助。

**Ashley:** 现在，如果您编写脚本，Spinnaker 是否内置了这种功能，我记得您说过每个脚本都有 init 文件——

**Vergara:** Cloud-init。

**Ashley:——**每一朵云，Cloud-init。

**Vergara:** 是的。

**Ashley:** 如果你知道这是一个特性，你可以提前使用它，并将其设计到你如何编写脚本中？

**Vergara:** 是的，所以，在 Spinnaker 部署阶段有一些字段，您可以将它放入其中。因此，我认为在 GCEVMs 中，您可以在部署阶段使用用户数据字段，然后在 AWS 中，还有元数据字段。

因此，字段因提供商而异，但概念是一样的，对吗？

阿什利:嗯。

所以，你把它放在那里，插上电源。然后，在这些虚拟机的引导过程中，我认为操作系统支持 Cloud-init，所以当他们选择操作系统时，请确保它有 Cloud-init，然后 Cloud-init 将获取这些文件，然后从这些 Cloud-init 脚本中启动步骤或命令。

阿什利:嗯，太好了。对于 Spinnaker 新手或创建虚拟机映像和烘焙新手来说，有哪些事情是他们可能会遇到的，有哪些典型的困难会对您的演讲有所帮助？

**Vergara:** 没错，所以我在开始使用 Spinnaker 时也经历了同样的事情。我想，“哦，这对我来说是全新的！我该怎么做呢？”*【笑声】*所以，我要在峰会上分享的一件事是，“嘿，你知道吗？Spinnaker 实际上使用 Packer，这是一个 HashiCorp 工具，它实际上在幕后执行烘焙。

现在，Spinnaker 提供了一组打包模板，对吗？这些是最基本的。实际上每个供应商都不一样。所以，一次只能用一个。所以，如果你是为，比如说，GCP 建造，那么就使用 GCP·帕克模板。如果你使用 AWS，你必须使用不同的 AWS 打包模板。

阿什利:嗯。

**Vergara:** 所以，如果您有更高级的用例，您可以定制和构建自己的打包模板，这也是 Spinnaker 的强大老师之一，对吗？所以，如果你最终——比如，你知道，所以在内部，你用 Chef 或 Ansible 或 Puppet。有一些打包模板可以使用这些类型的置备程序，但是您必须将它们部署到 Spinnaker 中。

因此，在这次演讲中，我将分享您如何部署这些自定义打包模板。因此，有几种方法可以做到这一点。所以，一种是更简单的方法，但它有一定的局限性。这些打包模板像 Kubernetes 的秘密一样存储在 Spinnaker 中，所以它的大小有限制。因此，如果您有复杂的脚本或打包模板，那么您必须将它部署为一个 sidecar 容器。

同样，我将在峰会上分享这些技巧，并提供更多相关细节。

阿什利:嗯。是的，人们可能也很熟悉 Packer，它本身是一个开源项目，用于创建图像和机器图像。

**Vergara:** 是的。

阿什利:太好了。你发现人们通常会遇到或刚开始接触时可能会遇到其他困难吗？

**Vergara:** 还有什么？因此，Spinnaker 本身主要侧重于发布软件变更，但它有一个非常灵活的管道管理系统。例如，在 Salesforce，我们实际上使用它来构建资源，如负载平衡器、DNS 记录、主题、队列。您实际上可以创建自定义的作业阶段来执行这些任务。

阿什利:嗯。

**Vergara:** 我们发现这真的很棒，因为我们可以重建一个完整的环境来承载所有这些现有资源，运行我们可以与这些基础架构资源设置一起部署的同一组管道。因此，我们可以立即构建它，这样它也满足了我们的扩展要求。因为，像 Salesforce 这样的大规模企业，我们必须构建所有这些资源和部署。我们谈论的是跨越不同地区和地理位置的数千台服务器。

阿什利:嗯。你知道，有时工具，开源，甚至商业工具非常灵活和强大，有时随之而来的是复杂性，所以它有助于一些指导，一些像你一样经历过这一过程的人的经验指导，可以帮助你度过这一过程，并了解如何使用它，如何完成事情，对不对？

**Vergara:** 对。因此，Spinnaker 有一个松弛的通道。所以，你知道，当像我这样的人或其他不熟悉 Spinnaker 的人有任何问题时，我们会去那个频道询问。有几个频道是特定于某些功能的。举例来说，如果你正在努力使用模板化管道，那么你就进入管道作为代码通道，对吗？或者，如果您对如何在 Spinnaker 中使用 Kubernetes 有疑问，那么您可以使用 Kubernetes Slack 通道。

这对我们非常非常有帮助，尤其是在开始的时候，我们试图弄清楚事情是如何运作的。

阿什利:嗯，我赌，我赌。那么，你在 Salesforce 使用 Spinnaker 多久了？

我们去年开始了我们的旅程。

阿什莉:好的。*【相声】*

去年底，到现在快一年了。*【笑声】*

阿什利:哇，好的。

**Vergara:** 是啊。

阿什利:哇。我打赌这一年发生了很多事。我知道你也计划谈论的事情之一是为那些可能想帮助 Spinnaker 变得更好的人提供一些贡献想法。我想，这些是您在实现 Spinnaker 时的想法或经验吧？

**Vergara:** 对。所以，我们的一些贡献想法是关于一个叫做 Kill 的新项目。我不确定你是否采访过演讲者。

阿什莉:我还没有，但我可能会。*【笑声】*

**Vergara:** 好的。是的，所以我会让他们——你知道，我不会抢他们的风头。

阿什利:不要抢了他们的风头——好吧，太好了。*【笑声】*

**Vergara:** *【笑声】*对，所以，这是其中之一，他们更关注管理下的交付，所以就在那时。另一个贡献的想法更多的是围绕着每个提供者。所以，再一次，如果你是为一个供应商建造，这是一个不同的，完全不同的阶段。比如说，GCEVM，对吧？因此，他们有自己的部署阶段。然后是 AWS，他们会有自己的部署阶段。他们现在有点不一样。就像，你知道，他们专注于某些事情。

我认为另一个贡献是尝试添加更多的选项或功能，以便它可以完全支持该提供商。因此，例如，对于 GCE，我认为其中缺少一个功能，如果我没记错的话，或者他们可能已经修复了它。但是，比方说，如果你有一个持久磁盘，你想要这个特定的持久磁盘，那么它不被支持。它总是创造一个新的。因此，它并没有给你一个选项来真正重用你之前已经构建好的一个现有的。诸如此类的事情。我认为这很重要。

AWS 也一样，对吧？因此，在部署期间，EC2 虚拟机还可以添加一些功能。

阿什利:太好了。想到您接下来的发言，我也很想知道，哪些人会最大限度地利用 it，来到您的面前——显然，有些人希望履行这一职能，但通常是 it 开发人员、DevOps 工程师还是 CI/CD 自动化专家？谁会从你的演讲中获益最大？

**Vergara:** 这将是他们公司的 Spinnaker 管理员。因此，如果他们想学习如何配置 Spinnaker 来启用烘焙和部署特性，那么他们将是从中获益最多的人。但是我想说，所有的 DevOps 工程师都想弄清楚他们实际上是如何使用 Spinnaker 进行烘焙和部署的。比如，他们是如何建立管道的？

我将从头到尾演示它实际上是如何工作的，以便他们可以有一个直观的印象。有时候，你需要那种视觉来说，“哦，耶！哦，原来是这么回事！”对吗？

**阿什利:** *【笑声】*嗯嗯。嗯，那个指导很有帮助。我也可以看到，你所说的那些在部署过程中管理 Spinnaker 的人是理想的参与者，当然，其他开发运维工程师自动化并想知道这部分是如何工作的也是不错的选择。

好吧，我祝你好运。我知道你会做得很好。你显然知道，从你在 Salesforce 的经历中学到了很多，知道了很多。所以，我祝福你。

**Vergara:** 嗯，谢谢。再次感谢你，米奇，让我有机会在这里演讲。

阿什莉:嗯，当然。感谢您的参与。我要感谢我今天的嘉宾，Jing Vergara，她是 princ——我说不出来*【笑声】*——sales force 的首席软件工程师。好了，我把它拿出来了。Spinnaker Summit 2019 将于 11 月 15 日至 19 日在圣地亚哥举行，Jing 的演讲将于 11 月 17 日周日 10:45 举行。它的标题是“揭开 Spinnaker 虚拟机映像烘焙和部署的神秘面纱”

所以，感谢你今天加入我们的 DevOps 聊天播客。我是 DevOps.com 的米奇·阿什利。祝你愉快，在外面要小心。

— [米切尔·阿什利](https://devops.com/author/mitchellashley/)