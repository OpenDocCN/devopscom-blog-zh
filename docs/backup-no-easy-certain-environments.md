# 备份:在某些环境中并不容易

> 原文：<https://devops.com/backup-no-easy-certain-environments/>

我们讨论了如何为新时代的云原生应用重新设计备份，以及[在现代数据库备份和恢复解决方案中应该寻找什么](http://datos.io/checklist-need-look-modern-database-backup-recovery/)。但是，即使您放弃备份和编写脚本来处理任务的传统方法，下一代应用程序和数据库(Apache Cassandra、MongoDB、Amazon DynamoDB、Microsoft DocumentDB、Apache HBase 等)的备份和恢复也会非常困难。但这是为什么呢？

简而言之，在最终一致的随处写入非关系数据库架构中，几乎不可能捕获一致的状态备份。数据恢复成功的可能性就更小了！

出现这种情况的原因不止一个。这归结于分布式体系结构的基本性质，该体系结构旨在在不停机的情况下扩展和承受节点故障。正如我们在下面强调的那样，从一开始就有几个挑战使备份分布式体系结构变得困难:

*   **数据被写入可用节点。**数据的第一个着陆点是不可预测的，因此没有办法在数据到达节点时捕捉数据。
*   然后，在验证之前，数据被复制到至少一个其他节点。这确保了有效的写入，但也立即创建了数据的拷贝。
*   …然后复制到一个或两个以上的节点以实现可用性。这种情况会在之后发生，并且相同的数据会在短时间内连续更新。
*   **…意味着任何时候都有三份或四份数据副本。**
*   **…和节点** **从不** **立刻一致**。
*   由于每个副本都被复制，备份效率非常低。
*   当一个节点出现故障时，拓扑结构会中途改变。

从理论上讲，一个优秀的 DevOps 团队可能能够编写 80%到 90%成功备份数据库的脚本(多节点故障、拓扑变化、数据库压缩等情况建模起来很复杂，因此很难编写正确的脚本)。

不幸的是，备份是等式中“容易”的部分。恢复备份才是真正具有挑战性的地方。成功的恢复比大多数人想象的要复杂得多。它包括以下步骤:

*   **重建正确的拓扑。**因为每个节点都是单独备份的，所以数据库必须恢复到相同的拓扑结构(6 个节点到 6 个节点，12 个节点到 12 个节点)，等等。这与跨云、测试/开发和 CI/CD 使用情形实现恢复有关。
*   **等待数据库自行修复和恢复。非关系数据库体系结构可以承受节点故障并保持运行，但带有数据协调的完全恢复将带回慢速驱动器上最糟糕的 RAID 重建的记忆。**
*   **对多个不一致的副本进行重复数据删除。**备份副本包含三份或更多份可能处于不一致状态的所有数据。需要先进行重复数据消除或协调。
*   但是数据历史并不总是可用的。在大多数分布式架构中，操作日志是一个循环缓冲区，它在运行过程中会自我吞噬！甚至可能无法恢复必要的日志数据来协调数据库。
*   没有可靠的方法可以回到某个时间点。即使有操作日志数据，也很难重建时间点数据。在最好的情况下，您会得到一个最新的、基本准确的数据库副本。

在现实世界中，恢复可能需要几天或几周时间—如果数据能够恢复的话。但是正如最近的 Gitlab 宕机事件所显示的，即使是精通技术的组织也很难把事情做好。如果没有一个可靠的备份和恢复流程，人为错误对数据库的影响可能会像自然灾难一样致命。

— [沙拉布·戈亚尔](https://devops.com/author/sgoyal/)