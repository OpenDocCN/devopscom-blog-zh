# ShellShock 漏洞:影响、分析和保护

> 原文:[https://devo PS . com/shell shock-vulnerability-impact-analysis-protection/](https://devops.com/shellshock-vulnerability-impact-analysis-protection/)

本周，Akamai 安全研究员夏羽·查泽拉斯在 Unix Bash (Bourne Again Shell)外壳中发现了一个有趣的 Bug——被称为“Shellshock”或“Bash Bug”。该漏洞影响广泛的操作系统(Unix、Linux、OS X)、路由器和其他技术，使得我们日常使用的许多系统容易受到攻击。GNU Bourne Again Shell (Bash，许多 Linux 和 Unix 操作系统中使用的命令行 Shell)中的系统漏洞可能会使运行这些操作系统的系统容易受到攻击。该 bug 利用了操作系统或应用程序传递的 Bash 进程变量。如果 Bash 被配置为默认的系统外壳，它可以通过 web 请求、安全外壳、telnet 会话或其他使用 Bash 执行脚本的程序来攻击设备。现在，所有主要的 Linux 发行版供应商都提供了针对此漏洞的修补程序。

**影响**
此漏洞引起众多关注的原因是攻击者可利用的威胁载体的广度。例如，如果处理您的网站请求的服务器使用 bash 命令访问您请求的信息，加载网站的简单任务就给了攻击者利用该漏洞的机会。因此，如果您仍然认为我们不再使用命令行，请三思。

事实上，有一些计算机程序使用 Bash 在其他计算机上执行命令。例如，网站如何知道您是通过移动设备还是计算机网络浏览器访问该网站？根据您的设备返回的响应，服务器将修改内容交付，以与相应的平台兼容。从技术角度来看，您的浏览器会发送一个代理来告诉 web 服务器您正在使用移动设备或计算机浏览器。然后，在使用 Bash 执行生成 web 页面的代码之前，web 服务器使用这些信息将代理字符串设置为一个变量。

攻击者正在利用这个漏洞。一些研究人员报告称，蜜罐基础设施正受到一个利用 Bash 漏洞的组织的主动攻击。该漏洞允许安装当前正在使用的零日 bash 注入 ELF 恶意软件。一名使用@yinettesys Twitter 帐户的系统管理员发布了一篇 [GitHub 帖子](https://gist.github.com/anonymous/929d622f3b36b00c0be1 "GitHub post")报告称，威胁参与者利用 Bash Bug 缺陷在计算机系统上启动内核漏洞。然后，恶意代码执行来自用户代理的 Web GET 请求，开始强力字典攻击来获取凭证。此攻击的恶意代码已被 [virustotal](https://www.virustotal.com/en/file/73b0d95541c84965fa42c3e257bb349957b3be626dec9d55efcc6ebcba6fa489/analysis/1411634118/ "virustotal") 分析，目前防病毒软件检测到的比率为 0/55。

**保护自己**
有几种检测方法可以用来降低这种风险。因为 Bash Bug 会影响 Bash shell 的 1.14 到 4.3 版本，所以升级到最新版本会降低风险。

从 web 应用程序的角度来看，通过 Bash 解释器的代码可以利用这个缺陷。CGI(公共网关接口)和 CGI 脚本受影响最大，但是传递给 Bash 解释器的任何东西都可能被利用。在易受攻击的系统上，可以通过 HTTP 头和 POST/GET 参数执行命令。因此，您可以使用 web 应用程序防火墙来监控标头中的漏洞。此外，签名将被添加到 POST/GET 字段。此签名将使用(){ command 和(){ command 和(){，监视通过多个空白绕过检测签名的尝试。

使用 IDS/IPS 检测任何类型的网络通信；IDS/IPS 会在建立连接和执行远程命令时通知您。

我们将继续关注这一情况，并将我们发现的任何新信息发布到 Alert Logic 博客上。

**看看你是否脆弱**

要查看您是否易受此攻击，请运行以下命令，响应将告诉您是否易受攻击

env x = '(){:；};echo vulnerable' bash -c "echo 这是一个测试"

**如果系统易受攻击，输出将是:**

脆弱这是一个考验

**未受影响的(或打了补丁的)系统将输出:**

bash:警告:x:忽略函数定义尝试 bash:导入“x”的函数定义时出错这是一个测试

 **学分**
[https://lists . debian . org/debian-security-announce/2014/msg 00220 . html](https://lists.debian.org/debian-security-announce/2014/msg00220.html "https://lists.debian.org/debian-security-announce/2014/msg00220.html")

[http://blog . erra tasec . com/2014/09/bash-shell shock-scan-of-internet . html #。VCRpVitdXKN](http://blog.erratasec.com/2014/09/bash-shellshock-scan-of-internet.html#.VCRpVitdXKN "http://blog.erratasec.com/2014/09/bash-shellshock-scan-of-internet.html#.VCRpVitdXKN")

[http://ars technica . com/security/2014/09/bug-in-bash-shell-creates-big-security-hole-on-any-with-nix-in-it/](https://arstechnica.com/security/2014/09/bug-in-bash-shell-creates-big-security-hole-on-anything-with-nix-in-it/ "http://arstechnica.com/security/2014/09/bug-in-bash-shell-creates-big-security-hole-on-anything-with-nix-in-it/")

[*https://cve.mitre.org/cgi-bin/cvename.cgi?name = CVE-2014-6271*T3】](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6271 "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6271")

——————————————————

**以下是警报逻辑提供的检测 id 的签名。**

这些规则是根据日常普通硬件的资源消耗(无 PCRE)创建的，以更全面地覆盖使用情况。

这里我们必须使用“any ”,因为许多服务在非标准的 http 端口上打开 web 服务器，例如 cups 和 devices any，因为本地攻击是这种情况的常见原因(cups、avahi 等)。)并且 http_header 可能只使用白名单，我们将会错过唯一的报头值。由于“within”修饰符，这也可以被绕过，但我们必须尝试缩小资源问题的范围。

外部网络是外部互联网的 IP 地址。家庭网络可以是来自内部 IP 空间的任何通信。

alert TCP $ EXTERNAL _ NET[1024:]--> $ HOME _ NET any(msg:" AL:HTTP Server
Headers Bash Environment Escape RCE "；flow:to_server，已建立；
内容:“(){”；http _ header 快速 _ 模式；内容:“} | 3b |”；以内:20；
http _ 表头；标签:session，5，packetsclasstype:已尝试-admin；
sid:1006236；rev:1；)

Uri 和方法现在是理论上的，但是检查一下以防另一个服务器这样做；任何对内部脚本函数(如 Popen)解析不当的输入都可能触发:

alert TCP $ EXTERNAL _ NET[1024:]--> $ HOME _ NET any(msg:" AL:HTTP Server
URI Bash 环境逃 RCE "；flow:to_server，已建立；
uricontent:"(){ "；快速 _ 模式；uri content:" } | 3b | "；以内:10；
classtype:未遂-admin；标签:session，5，packetssid:1006237；rev:1；
)
() {永远不应该出现在一个方法中，所以我们在这里不需要额外的检查:

alert TCP $ EXTERNAL _ NET[1024:]--> $ HOME _ NET any(msg:" AL:HTTP Server
Method Bash Environment Escape RCE "；flow:to_server，已建立；
内容:“(){”；http _ methodclasstype:已尝试-admin；
标签:会话，5，数据包；sid:1006238；rev:1；)

终端应用程序可能会将 POST 值解析成环境变量(解析器、解释器、格式等)。)做一个只是为了安全，这可能是错误的，虽然

alert TCP $ EXTERNAL _ NET[1024:]--> $ HOME _ NET any(msg:" AL:HTTP Server
POST Bash 环境逃离 RCE "；flow:to_server，已建立；
内容:“(){”；http _ client _ body 快速 _ 模式；内容:“} | 3b |”；
内:20；http _ client _ body 标签:session，5，packets
class type:attempted-admin；sid:1006239；rev:1；)

现在是大坏蛋。上传的文件可以将元数据解析并填充到 env 变量中(cups 在这方面臭名昭著。)对此的优化将会很困难，但我们必须这样做，这样我们就不会解析最大文件解析字节:

alert TCP $ EXTERNAL _ NET[1024:]--> $ HOME _ NET any(msg:" AL:File
Transfer Parsing Bash Environment Escape RCE "；
流量:to_server，已建立；file _ data 内容:“(){”；以内:100；
快速 _ 模式；内容:“} | 3b |”；以内:20；标签:session，5，packets
class type:attempted-admin；sid:1006240；rev:1；)

好了，现在可以使用 base64 & & unserialize/JSON _ decode 值的 cookie 值。这可能是错误的，因为这些字符在这些压缩数据格式中经常使用。这种尝试完全是随机的，因为我们不知道随机人的 base64 编码值+的大小和开始，所以规则甚至可能不起作用，但我们需要尝试禁用它，除非我们需要它，因为它起作用的未知和随机机会客户特定值(已知 cookie)可以很容易地在此规则中被替换:

# alert TCP $ EXTERNAL _ NET[1024:]--> $ HOME _ NET any(msg:" AL:HTTP
Cookie 值 Bash 环境逃 RCE "；flow:to_server，已建立；
内容:“=”；http _ cookiebase64_decode:相对；base64 _ data
内容:“(){”；标签:session，5，packetsclasstype:已尝试-admin；
sid:1006241；rev:1；)

DHCP 设置用户挂钩

alert udp $HOME_NET [67，68]-> $ HOME _ NET any(msg:" AL:DHCP Bash
环境逃离 RCE "；flow:from_server，已建立；内容:“(){”；
快速 _ 模式；内容:“} | 3b |”；以内:20；标签:session，3，packets
classtype:未遂-admin；sid:1006242；rev:1；)

这篇文章也发表在 Alert Logic 博客上

**关于作者**

[![Stephen-Coty-Alert-Logic-200x300](../Images/6206c90b6cb83f7f014774d70d696889.png)](https://devops.com/wp-content/uploads/2014/09/Stephen-Coty-Alert-Logic-200x300.png) 斯蒂芬·黄凤英于 2012 年加入 Alert Logic，担任威胁研究总监和[云安全报告](https://alertlogic.com/resources/cloud-security-report/)的作者，在安全领域拥有丰富的经验。在 Alert Logic 任职期间，Stephen 目前正在组建一个一流的威胁研究团队，该团队通过扎实的研究、恶意软件的逆向工程和对被盗数据的持续搜索，采取更加主动而非被动的安全方法，对行业进行创新，所有这些都可以用作补救的可操作数据。Stephen 在系统工程和安全咨询领域拥有超过 15 年的经验，涉及从医疗保健到金融和政府等多个行业。最近，他在 Rackspace Hosting 担任高级职位，担任网络安全经理，并担任安全运营中心和威胁研究团队的架构师。他也是国际社会保障协会、Infragard 和 HTCIA 的成员。