# 从 Pets 到 X-as-Code:实现大规模 ITOps 的控制和可预测性

> 原文：<https://devops.com/from-pets-to-x-as-code-enabling-control-and-predictability-for-itops-at-scale/>

at 的网络云副总裁 Amy Wheelus 最近在安特卫普的开放网络峰会上谈到了声明式可预测性。AT & T 是世界上最大的电信公司，提供关键任务通信服务，人们的工作—————随时待命。随着他们从劳动密集型 IT 运营转向云原生自动化，他们需要相信所声明的 IT 基础架构状态可以被可预测地控制和再现。这种在 IT 系统中建立可预测性、可再现性和信任的要求并不新鲜，但随着 IT 部门从地下室中几台闪烁的服务器发展到每项业务围绕其运转的核心，其规模和复杂性都在增长。

随着每一项客户互动和业务功能变得越来越数字化，如果公司希望继续跟上当今快速变化的世界，就必须能够依靠其 IT 部门。本文追溯了 IT 操作从 Pets 到 X-as-code 的演变，每一次改进都使公司更接近声明式可预测性。这些最佳实践使企业能够通过其 IT 部门可靠地交付核心业务价值，并与云原生时代保持同步。

## **昨天:宠物对抗牛和基础设施作为代码**

以前，IT 部门只是后台的服务器，一旦出现问题，所有人都会全力以赴，因为工作会陷入停顿。首席执行官无法收到他们的电子邮件，销售部门也无法预订新订单。从早期开始，人们就认识到，为了将关键业务服务托付给 it 部门，需要在系统中内置高可用性和可靠性。这导致了 [宠物与牛的类比](https://www.loodse.com/blog/2019-06-20-cloud-native-best-practies-2/) 的产生，其中每个基础设施组件都是可互换的，并且当出现问题时可以快速替换。这使得公司能够快速从停机中恢复，甚至避免停机。

正如任何一个牧场主可以告诉你的那样，虽然把服务员当成牛可以解决一些问题，但是处理一整只羊也会带来一系列挑战。随着托管基础架构规模的增长，很难跟踪其实际部署的位置、时间和方式。此外，为保持生产系统健康而对其进行的更改可能会导致配置漂移，从而创建出 [独特的雪花服务器](https://martinfowler.com/bliki/SnowflakeServer.html) ，它们是宠物而不是牛。当系统的实际状态未知时，预测系统在关键情况下将如何反应或依赖它将成为一项困难的任务。

为了帮助消除这一问题并控制基础设施的配置和部署方式，ITOps 团队转向了基础设施即代码。在这种工作方式下，应用程序和服务器一旦部署就不会被修改。如果有什么需要改变，就会创建一个新版本，旧版本就会退役。可以对每个部署进行版本控制，以创建生产中的内容及其部署方式的概述。

管理牲畜而不是宠物，以及使用基础设施即代码，帮助企业从使用长寿命机器的基于票证的运营转向更具可扩展性和动态的基础设施。这些实践将可重用性、可扩展性、自动化和版本控制构建到 IT 系统中，以创建更简单、更可预测的部署和管理流程。通过能够宣布其基础设施的状态，公司能够预测和信任结果。

## **今天:云原生基础设施**

从 [云原生计算基础](https://www.cncf.io/) 中查看云原生的 [定义](https://github.com/cncf/toc/blob/master/DEFINITION.md) ，很快就能明白为什么许多公司都转向这些最佳实践。他们帮助公司建立和运行弹性和可管理的基础设施，这些基础设施与强大的自动化结合起来，创造出动态的、可预测的系统。声明式 API 和不可变基础设施将作为两个例子来理解 cloud native 是如何构建和扩展上述技术的。

声明式 API 使得代码和自动化基础设施成为可能。例如，使用 [Kubernetes](https://devops.com/kubernetes-adoption-are-you-game-for-it/) ，运营团队能够声明系统的期望状态，并自动与实际状态进行协调，直到它们相匹配。它最初只是从容器编排开始，但后来已经扩展到涵盖许多其他类型的云资源，包括物理基础架构本身，分别通过 [自定义资源](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/) 和 [集群 API](https://github.com/kubernetes-sigs/cluster-api) 。声明式 API 通过自动化操作和消除生产中的错误，使基础设施管理变得更简单、更具可重复性。可以利用声明性 API 来创建不可变的基础设施。

[不可变的基础设施](https://www.digitalocean.com/community/tutorials/what-is-immutable-infrastructure) 超越了仅仅把服务器当成牛，仅仅把基础设施当成代码。不可变的基础设施覆盖了栈的每一个更高层，直到每一层都被编码并像牛一样被管理。仅部署精确副本，并且它们可以随时被完全替换。如果有任何需要更改的地方，就会进行新的部署，旧的部署就会被淘汰。不可变的基础架构适用于整个体系，可消除差异，从而减少部署失败、实现跨环境的一致性、轻松的水平扩展以及简单的回滚和恢复流程。

正如这两个例子所示，云原生使公司能够可靠地横向扩展动态 IT 服务，而不必同时横向扩展其运营团队。将声明性可预测性构建到系统中会产生对自动化流程的信任，即使关键服务正在其上运行。

## 明天:X-as-Code

虽然云原生最佳实践提供了许多好处，但应用程序和基础架构对于企业 IT 团队来说只是故事的开始。在当今世界，他们面临着艰巨的任务，既要管理不断变化的庞大环境，又要遵守国内政策以及国家和国际法律。这一挑战远远超出了单纯的服务器和将它们视为牲畜，而是跨越多个云和成百上千个开发人员的合规性和治理。考虑到这些挑战，问题仍然是如何在企业范围内最好地满足这些需求。

纵观架构、配置、蓝图、策略和治理，如果将其中的每一个都简单地视为应用之上的另一层堆栈，那么它们的操作就可以得到极大的简化。通过将不可变基础设施和牛的原则应用到堆栈的这一层，可以使用 X-as-code 模型来定义和管理每一层。已经可以看到这些类型的管理模式在云原生生态系统中生根发芽。

Kubernetes 通过使用 [准入控制器](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/) 创建蓝图代码，而策略代码可以在 [Pod 安全策略](https://kubernetes.io/docs/concepts/policy/pod-security-policy/) 和 [网络策略](https://kubernetes.io/docs/concepts/services-networking/network-policies/) 中定义。CNCF 甚至有一个策略引擎[OPA](https://www.openpolicyagent.org)，作为一个沙盒项目，为运营商的整个堆栈提供细粒度而灵活的策略控制。通过使用代码将策略和其他层从实际实现中分离出来，得到的堆栈更容易理解，足够灵活以处理未来的需求，并且维护成本更低。

在 Loodse，我们的客户正在努力管理其集群的配置、服务和策略。利用 [Kubernetes 控制器范例](https://docs.kubermatic.io/advanced/addons/) 在[Kubermatic](https://www.loodse.com/product/)中，我们能够自动化这些附加组件的部署和生命周期。这使用户能够声明、实施和自动化基础架构以及配置和策略的所需状态。Kubernetes 控制器为动态和可扩展的云原生 it 带来了可预测性和控制力，即使 IT 开始处理越来越多的任务关键型服务。

## **生产中的原生云:声明式可预测性**

随着 IT 成为每项业务的核心，将云原生最佳实践引入生产，运营商可以在企业范围内可预测地申报、运行和管理其基础设施。能够信任这些自动化操作释放了资源，并开辟了许多新的可能性。开发人员可以获得护栏，并有能力做他们的工作，而不是在排队买票。运营商可以轻松创建满足监管标准的高度可用的自我修复基础设施，从而专注于提供具有差异化商业价值的平台。

在现代 IT 实践发展的每一步，从牛到 X-as-code，运营流程都变得更加简化，允许开发人员和运营人员为底线创造更多价值。IT 基础设施和运营的未来将是一个值得信赖的平台，它可以自动化无差别的繁重工作，让整个企业专注于客户价值。

要了解更多关于集装箱化基础设施和云原生技术的信息，请考虑参加 11 月 18 日至 21 日在圣地亚哥举办的[kube con+CloudNativeCon NA](https://events.linuxfoundation.org/events/kubecon-cloudnativecon-north-america-2019/)。

— [比尔·穆里根](https://devops.com/author/bill-mulligan/)