# DevOps 弹性:对现有应用程序采取主动-主动方式

> 原文:[https://devo PS . com/devo PS-resilience-going-active-active-existing-application/](https://devops.com/devops-resilience-going-active-active-existing-application/)

运行主动-主动架构需要什么？归根结底是数据，以及你如何与它互动。我遇到的最常见的灾难恢复策略要么是在单一位置运行应用程序的“希望和祈祷”，要么是采用主动-被动配置的“我们有一个在灾难中可以切换到的备份设施”。这是一个遗憾，因为运行主动-主动架构不是科幻小说，虽然这需要一些工作，但对于许多业务用例来说，优点远远大于缺点。

**魔鬼在数据中**

如果您从外到内使用您的架构，主动-主动架构相对容易理解:您有多个运行应用程序的物理数据中心或云区域，您的应用程序在其中运行，并且您有流量管理来将用户负载平衡到最近、最快和最可用的位置。人们陷入困境的地方是数据库。如何确保在一个位置所做的更改传播到其他位置？如果用户从一个设施“跳到”另一个设施，并试图读回他们刚刚写入的数据，会发生什么？当位置 1 的用户 A 和位置 2 的用户 B 对应用程序的状态做出冲突性的更改时，如何避免竞争情况？

处理上述场景的关键是理解数据的业务需求，并针对主动-主动架构适当地处理每种类型的数据。如果你试图“让所有的数据在任何地方都可用”，你将很快遇到上限定理的限制或这种方法的高成本的财务限制。相反，让我们把更大的问题分解成更小、更容易处理的问题。

**三类数据**

对于您的应用程序访问或产生的每种类型的数据，让我们根据三种类型之一对其进行分类，为了简单起见(也为了更容易向您的业务同行解释)，使用银行业的比喻:

1)这个数据像是一个**银行账户余额**吗？它经常变化，确保两个冲突的变化不会“打破”平衡是非常重要的。我们不希望用户 A 和用户 B 同时从两个地点取款，从而可能透支账户。

2)这些数据类似于您的银行为您的账户保留的**地址和邮寄信息**吗？它会发生变化，但并不频繁，而且在变化过程中，如果有一小段时间，承载您的应用程序的多个位置对此数据不同步，这也是正常的。他们最终会获得一致性。

3)这些数据像你的**银行对账单**吗？一旦产生，就不会改变。它们可以被存档。

**账户余额。邮寄地址。历史性的声明。**三个类别，对于每一个类别，我们都有一个支持主动-主动的数据复制策略。通过对数据进行分类并用不同的复制策略对待每一种数据，我们完成了两件非常重要的事情:

1)我们正在考虑哪些数据真正需要接近实时的复制和竞争条件保护。通过这样做，我们减少了需要高优先级复制的总体数据量。要复制的数据越少，复制工作就越好、越高效。

2)我们愿意针对每种类型的数据使用工具箱中正确的工具，而不是尝试用相同的策略复制所有数据，这意味着我们将通过使用归档和最终一致的策略来节省成本。

对于每个类别，我们将使用适当的复制策略:

1)对于“帐户余额”信息，我们将尽可能快地复制更改，并确保我们的应用程序知道并能够解决更改冲突。这当然是最难解决的问题之一，但通过减少我们需要用这种策略处理的数据量，这个问题比试图将这种策略应用于所有三类数据要容易解决得多。

2)对于“邮寄地址”信息，我们将使用最终一致的复制策略。

3)对于“历史报表”信息，我们可以选择不将其复制到我们所有的工厂。我们可能会重新考虑一些旧的假设，哪些是重要的，哪些是不重要的，并决定丢弃一些信息。如果语句丢失，我们可以选择简单地重新生成语句。我们可以选择在一天中的特定时间批量复制这些数据。

**三大好处**

在我们将应用程序迁移到主动-主动模式后，我们有望获得三大好处:

1)发生灾难时，故障切换更快、更可靠。与主动-被动灾难恢复策略相反，主动-被动灾难恢复策略依赖于空闲的基础架构在发生灾难时达到最高生产速度，我们避免了“我们认为它已准备好处理生产，但在灾难恢复演习之间出现了问题”的风险。在主动-主动方案中，我们一直在向每个位置发送生产流量，因此我们不存在“从闲置到满负荷”的问题；相反，我们将面临“50%至 100%”(两个地点合二为一)或“33%至 50%”(三个地点合二为一)的容量挑战。我们需要确保在主动-主动配置中始终有备用容量来处理故障期间的额外负载。

2)更灵活地更改应用程序和基础架构。在站点维护活动期间，我们可以将所有流量转移出我们的设施，执行我们的维护，然后在不停机的情况下将流量拉回。

3)用户体验提升。通过将用户与他们所处位置附近的应用程序实例连接起来，他们将获得比将他们全部发送到一个位置更好、更快的用户体验。

还有其他的，但那是最大的三个。

**三大弊端**

当然也不全是阳光小猫，也不是没有工作没有投入:

1)您将需要可用的备用容量，并且要勤奋并确信为备用容量维护一个安全的缓冲区。如果您以 75%的负载运行两个设施，那么当其中一个出现故障时，您将面临一个大问题。知道你的极限，并坚持下去。不要在投资这种能力上落后。

2)你需要改变你的申请。如果您正在寻找主动-主动的“嵌入式解决方案”,这不是您想要的。你需要改变你的申请。最常见的场景是，您从基于单一数据库技术的单一数据库实例过渡到三个独立的数据服务，这三个服务使用适当的数据管理策略来处理每种类型的数据。最常见的问题是“我以前可以连接这两个表来得到一个结果，但一个是‘帐户余额’类型，另一个是‘邮寄地址’类型，现在它们是分开存储的”。在这种情况下，您的应用程序需要知道从每个适当的位置检索数据，并“加入”软件。

这听起来既困难又耗时，但是有一个很好的策略来实现这些改变。假设您的应用程序使用一组核心库(通常是对象关系映射或 ORM 方法)来访问数据。在这些库中，您将希望对“从哪里检索什么类型的数据”进行更改。这将有助于在检索数据的接口方面最小化对应用程序其余部分的影响，并将“数据负载平衡”功能保持在代码库中的一个位置。根据需要添加辅助函数，以实现您需要的连接功能，这些功能以前是在数据库中完成的。请记住，如果您有许多跨数据类别的连接，这种策略总体上可能不适合您。

强烈建议您对这些修改采用黑暗架构方法。在将数据迁移到新策略后的一段时间内，让您的应用程序对一个数据交互用例的遗留和新实现执行读写操作。比较值和结果，并在不同时记录/警告，同时返回遗留结果。这为您提供了使用新数据策略的操作经验，同时最大限度地降低了风险，因为应用程序仍在使用所有功能的遗留实现。在您确信这两种方法在功能上是等价的之后，您可以开始使用新实现的值，并拒绝旧实现。更多关于黑暗建筑的细节，请看这里:http://gigaom . com/2013/06/20/making-it-change-less-risky-using-dark-architecture/

3)您将运行多个数据库和数据存储实施。培训您的团队、许可、基础架构，以及拥有针对每种类型的数据运行专用策略所需的监控和相关运营基础架构，这些方面都有一定的成本。你必须明白，对你的企业来说，收益是否大于成本。

还有其他的，但那是最大的三个。

**你的下一步**

正常运行时间、基础架构灵活性和用户体验对您的企业有多重要？这些投资值得吗？只有你能为你的生意说话。一旦您量化了正常运行时间的价值(例如，在停机期间，您损失了多少钱，对您的品牌造成了多少损害？)、敏捷性的价值(例如，如果您的团队能够更灵活地随时对生产进行更改而不影响客户，那么您的应用程序会发展得多快？)，以及用户体验的价值(例如，通过将您的基础架构分成多个主动-主动位置，您的用户体验会快多少，您的用户会对这种改进的体验有多满意？).得出这些数字，并将它们与上面要求的技术投资进行比较，您将非常清楚地知道如何将您的应用程序发展为主动-主动模式。