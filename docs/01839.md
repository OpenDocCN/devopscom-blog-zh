# DevOps Chat:针对 Pinterest 的大型整体服务的 CI/CD Velocity

> 原文：<https://devops.com/devops-chat-ci-cd-velocity-for-large-monolithic-services-with-pinterest/>

Spinnaker Summit 2019 预览:软件工程师李在实施 Spinnaker 作为 Pinterest CI/CD 管道的一部分方面发挥了重要作用。结果，Pinterest 从每天两次的预定部署转变为连续部署，在工作时间内超过 15 次。

本期 DevOps 聊天的特色是水烟凉演讲的预览，“我们如何为 Pinterest 最大的整体服务(API 和 Web)引入 CI/CD，以提高开发者速度、质量和可靠性(Pinterest)。”主题包括 Spinnaker 是如何被选中的，重要的指标，Pinterest 未来的 CI/CD 平台 Hermez，金丝雀分析和从旅程中吸取的教训。

水烟凉的演讲是在太平洋时间 11 月 17 日周日下午 1:30，在圣地亚哥举行的 2019 年 Spinnaker 峰会上。Pinterest 的软件工程师 Jasmine Qin 和一起参加了这次谈话。

像往常一样，下面是流媒体音频，然后是我们的谈话记录。

[https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/697713919&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true](https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/697713919&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true)

## 副本

米奇·阿什利:大家好。我是 DevOps.com 的米奇·阿什利，您正在收听的是另一个 DevOps 聊天播客。今天，我请到了李，他是 Pinterest 的一名软件工程师。

现在，水烟凉将在 11 月 15 日至 19 日在圣地亚哥举行的 2019 年 Spinnaker 峰会上发言，她的主题是 Pinterest 如何为大型、整体或整体服务、API 和 web 实施 CI/CD 管道，重点是帮助他们提高开发速度、质量或责任等。所以，她打算分享一些实际经验。她还会有一位共同主持人，秦茉莉，她也会和她一起参加那个演示。

水烟凉，欢迎来到 DevOps 聊天室。

李:谢谢你，米奇。

阿什莉:你能来真是太棒了。感谢加入我们。你能介绍一下你自己吗，告诉大家一些关于你的事情，你在 Pinterest 做的开发工作，以及你过去为了成为一名软件工程师做了些什么？

李:是的，当然。大家好，我是李，我在 Pinterest infraorganization 工作，我们的团队致力于为所有内部工程师提供持续交付平台。在我加入 Pinterest 之前，我在微软和亚马逊都工作过，也是一名软件工程师，我发现我对 infrasite 有非常浓厚的兴趣，事实证明，持续交付对于软件工程师来说是一个非常重要的特性。所以，这就是我来这里的原因。

阿什利:非常有趣。你在一些非常大的在线服务公司工作过。我知道 Pinterest 有大约 2.5 亿用户，当然，微软和 AWS 都是非常大的组织，所以听起来你有点习惯于从事一些相当大的基础设施项目。

李:是的，我是。*【笑声】*

**阿什利:**好，好！很棒的经历。那么，给我们讲讲你的演讲吧。我想也许从你来到 Pinterest 开始，也许是关于他们在实现持续交付的过程中的位置，以及你在这个过程中的位置。是你在开始还是他们已经开始了？

李:是啊。我算是加入了一个已经开始的项目，但我仍然在 Pinterest 上为 Spinnaker 的整个生产做准备。我也负责 Spinnaker 的设计评审。所以，我算是加入了已经为 Pinterest 选择 Spinnaker 的团队，但我是继续交付这个项目的主要人员。

阿什利:哦，所以你选择了一个已经在进行中的项目，然后把它作为其中的一个线索？

李:是啊。

阿什莉:非常好。所以，当你说——所以，你做一个 Spinnaker 的评论。是你的内部使用和实现上的改变，还是你也把东西贡献给开源？诸如此类的事情吗？

李:目前，我们只透露我们如何在内部使用它，我们只为 Pinterest 做一些定制。我们还没有为上游做出贡献，但我认为从长远来看，我们愿意为上游做出贡献。

阿什莉:是的。嗯，你知道，只是用你的音量，我敢肯定，也是一种回报的方式。这肯定要用到 Spinnaker 和其他很多相关的工具。

那么，请告诉我们，当他们已经实施了 CI/CD 连续交付时，您是如何接手的，并且您在某种程度上推进了它，还是他们仍在实施 CI/CD 连续交付的过程中？

**李:**我是在他们还在实施 CI/CD 平台的过程中发现的。

阿什利:嗯。

李:但他们已经决定使用 Spinnaker，但我们仍然需要做 Pinterest 的具体定制以及如何在 Pinterest 上做好生产准备，这类工作。

阿什利:啊，太好了。所以，听起来你和 Spinnaker 有很大的关系，甚至当你加入准备生产的时候。你为什么不谈论一些事情呢——我知道你会在你的 Spinnaker 峰会上谈论这个。您需要对 Spinnaker 做些什么来使它为您所处的环境做好生产准备？

李:所以，我认为有几个关键的环节。第一个是，我们必须确保 Spinnaker 的身份验证和授权如预期的那样工作，因为这是最重要的事情——就像，我们必须确保用户可以在他们之前检查我们的操作系统流程——

阿什利:你的操作系统，嗯。

李:是啊。第二个关键部分是监控，包括指标和警报。因此，基本上，我们公开了所有的 Spinnaker 服务指标，并为这些警报创建了一个仪表板，当 Spinnaker 停机或类似情况发生时，我们可以通过它得到一些问题。我认为，对我们来说，这是生产准备最重要的两件事。

Ashley: 当你自动化持续交付、持续集成时，这是非常重要的。它是自动化的，但你必须知道它是否正常工作？

李:是啊。

Ashley: 事情进展顺利吗？有问题吗？或者你是否达到了预期的标准？

李:是啊。

Ashley: 我知道你在描述你的谈话时提到了什么样的衡量标准是重要的。你能说一点你学到的一些度量标准吗，在你实施它的时候和现在你已经在生产中使用它的时候，这些度量标准是非常重要的。

**李:**当然，这些指标非常重要，例如延迟和 P90，以及所有 Spinnaker 组件的 SLA 相关指标。我认为，尤其是门户服务，即 Spinnaker API 网关，它就像是 Spinnaker 其余组件的入口点，网关的指标极其重要。

阿什利:这是 Spinnaker 的集成组件，对吗？

李:是啊。

阿什莉:一切都在和它说话。差不多就是这样——我不知道它是否是一个中枢，但它肯定是所有 API 结合在一起的地方。

李:嗯嗯。

**Ashley:** 我确信如果你对此有问题，那么你会知道*【笑声】*系统中可能会发生很多故障。

李:是啊。

**Ashley:** 你有没有看，有没有衡量你每小时、每天做多少件产品，或者你有没有交付多少件产品？这些指标是通过 Spinnaker 获取的还是在其他地方获取的？

**Li:** 这不是我们在 Spinnaker 中获取的指标，但我们确实从管道执行历史中进行了测量。

阿什利:嗯。

**李:**因此，目前我们正在使用 Spinnaker 为 Pinterest 中的两个主要服务进行连续交付。我们每天为这两个主要系统完成大约 15 次部署，每次部署包含大约 10 次提交，我们认为这一管道极大地提高了我们的工作效率，因为以前我们必须进行手动部署。

阿什利:嗯。

李:是啊。

**Ashley:** 那么，您是否也有——我知道这可能不在 Spinnaker 的范围之内，但是您是否也有大部分或所有的自动化测试，或者在最终部署之前是否还有一些手动测试步骤？

李:你是说测试服务本身，还是测试 Spinnaker 服务？

Ashley: 测试更多的软件应用部分。

李:我明白了。是的，所以，目前，我们在 Jenkins 使用一个单独的阶段来运行集成测试工作。这就是我们如何进行测试的步骤。它已经有点自动化了，就像，我们不需要与人交互来触发构建或者运行测试。我们不需要那个。这只是 Spinnaker 管道中的一个阶段。是的，我们在詹金斯做翻译测试。

阿什利:嗯，很好。好的，很好。我们对你的工作流程和工具管道有所了解。听起来好像自动化程度很高。

李:嗯嗯。

**Ashley:** 回到以这种规模实施的话题，你们是一个非常大的组织，每天都要进行大量的部署。我知道 Spinnaker 有一些东西——嗯，你有一个叫 Hermes 的平台。这是您自己的中央工作流引擎，还是 Spinnaker 的一部分？

李:哦，原来爱马仕是我们未来的 CI/CD 平台。所以，我们正处于发展阶段。Spinnaker 将与 Hermes 集成，现在我们将使用 Spinnaker 作为后端工作流引擎。

阿什莉:嗯，好的。

李:是啊。

**Ashley:** 所以，那真的是你的——那是 Pinterest 自己的中央工作流引擎，你正在将 Spinnaker 集成到其中作为该功能的一部分？

李:是啊是啊。

阿什利:管道——工具管道，如果你愿意的话。好吧。

李:是的，它就像是 Pinterest 的一个 CI/CD 平台，我们将来也会开源 Hermes。

阿什利:哦！嗯，这是个好消息。我很期待。

李:是啊。*【笑声】*

阿什利:你知道那会在什么时候发生吗，或者是在更远的将来，还不知道？

李:我不确定确切的时间表，但明年年初或今年年底的某个时候。

阿什莉:好的。嗯，那不太远。太好了。我们将期待并感谢您作为开源做出的贡献。那么，再谈谈你从加入 Pinterest 和 Spinnaker 的实施过程中学到了什么，也许你必须做些什么，你学到了什么？这里有一个很好的方法，这是我犯的一个错误，我通过采取不同的方法纠正了它——从中吸取了哪些教训？

**李:**嗯，我认为我的经验是，因为我们将 Spinnaker 服务部署到 Kubernetes 平台，而我在加入 Pinterest 之前从未使用过 Kubernetes 平台，所以这是我在这里学到的最重要的经验，比如，如何在 Kubernetes 平台上设置所有的 Spinnaker 组件。

阿什利:嗯，很好。所以，学习如何做到这一点是很重要的。你在做这件事上有没有学到什么特别的经验，或者只是学习如何去做？

**李:**我认为一个具体的教训是 Kubernetes 平台决定轮换集群并进行一些平台测试的一些特殊情况。在 Spinnaker 服务方面，我们必须很好地处理这种情况，而不是让双方都失望，或者获得一些愉快的客户用户体验。这是我从那里学到的一课。

阿什莉:好的。我想你在你的表演笔记或者你的演讲描述中也提到过，你也做了一些金丝雀分析作为其中的一部分？

李:嗯嗯。

阿什莉:我想这对你来说是件新鲜事，或者你以前做过吗？

**李:**是的，这也是一个新事物，但我们有一个单独的团队，即配置团队，他们主要实施这一功能。所以，对于 Pinterest，我们支持 OpenTSDB 作为度量，但我认为 Spinnaker canary analysis 只能支持 Prometheus 或 Datadog 这些度量。所以，我认为 ____ 团队将这个 OpenTSDB 集成到了 Spinnaker canary 分析组件中，这样我们就可以在 Spinnaker UI 上提供 Pinterest ____。

阿什利:啊，有意思。

李:是啊。

阿什利:好的，太好了。在 Spinnaker 峰会期间，您计划在您的演讲中谈论哪些其他内容？

**李:**我想我们如何使用 Spinnaker，我们如何在 Pinterest 定制 Spinnaker，以及我们在这里采用 Spinnaker 时学到的经验教训。我想这些是我将要谈论的主要话题。

阿什利:嗯。太好了。嗯，我知道当 Pinterest 决定将 Spinnaker 用于这个项目或工具集的一部分时，你并不在那里。但是根据你所看到的和你所学到的，你认为 Spinnaker 实现了他们选择它的目标吗？

李:肯定。是的，我们很喜欢三角帆。*【笑声】*

阿什利:你还记得其中的一些目标吗？我们是否想达到每天一定数量的部署，或者他们是否想实现其他目标，看看你们做得怎么样？

李:我明白了。因此，我们没有目标的具体数字，但是 Spinnaker 无疑帮助我们使用 pipeline 进行部署。如果没有 Spinnaker，我们必须逐个执行每个阶段的手工收集部署，效率不是很高。目前，我们可以使用 Spinnaker 以一致且可重复的方式管理部署。我们非常喜欢 pipeline，它可以提供一系列部署阶段。我们不需要太多的手动交互，是的，我认为，我们采用 Spinnaker 的目标是，我们需要管道功能，我认为它对我们很有用。此外，金丝雀分析报告对我们也非常有用。

阿什利:是的，我知道很多人对使用它感到非常兴奋。

李:是啊。

**Ashley:** 你提到你集成了 OpenTSDB 作为你观察的一部分——我不能说出来*【笑声】*——可观察性堆栈，好了，拿出来了。现在，我想你也有一个部署系统，Pinterest 用它来部署到 AWS 中，对吗？

李:是啊。我们有一个部署系统，也是开源的，名为 Teletron，我们用了四年时间来部署到 AWS VM。但是这个部署系统没有提供好的管道，所以这就是为什么我们集成了 Spinnaker 来提供好的管道特性。

阿什利:优秀。嗯，你确实做了很多工作。接下来是什么？既然您已经将 Spinnaker 部署到您的 CI/CD 管道中，那么您正在考虑或正在进行的下一组项目是什么？

李:我认为下一个项目是，我们的团队将在 Pinterest 的主要 CI/CD 平台上实现 Hermes。Spinnaker 负责后端工作流引擎，我们也负责迁移，就像从 AWS 和 VM 到 Kubernetes 的大多数服务一样。是的，这是我们将要做的两个主要项目。

阿什利:啊。当然，搬到 Kubernetes，我相信这是一个相当大的项目，一个相当大的项目。

李:是啊是啊。*【笑声】*

阿什莉:嗯，很好。非常感谢你今天加入我们的播客。这非常有趣，我认为你的演讲非常有说服力和有趣。我期待着听到更多关于它的信息，并有其他人有机会参加。

李:是啊，谢谢你邀请我，米奇。我很高兴在峰会上使用 Spinnaker 介绍 Pinterest，也很高兴在那里谈论更多。

阿什莉:绝对是。好吧，谢谢你的发言。那么，你已经听到了另一个 DevOps 聊天播客。我要感谢今天的嘉宾水烟凉·李，他是 Pinterest 的软件工程师。同样，她在 Spinnaker 峰会期间的讲话是在 11 月 16 日下午 1:30，这是根据网站上当前的议程，您可以在那里查看 Spinnaker 峰会网站的更新，她的讲话也是关于我们如何为 Pinterest 的大型 monolith 服务、API 和 web 引入 CI/CD，以提高开发速度、质量和可靠性。正如你们刚刚听到的，水烟凉将与你们分享许多信息。

所以，谢谢你加入我们，水烟凉，当然，也谢谢你，听众，今天加入我们。我是米奇·阿什利，来自 DevOps.com，你已经听到了另一个 DevOps 聊天播客。在外面要小心。

— [米切尔·阿什利](https://devops.com/author/mitchellashley/)