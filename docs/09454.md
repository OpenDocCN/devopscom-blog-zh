# 部署微服务的 5 种测试策略

> 原文:[https://devo PS . com/5-测试-策略-部署-微服务/](https://devops.com/5-testing-strategies-for-deploying-microservices/)

经过严格的开发和生产前测试，您的[微服务](https://devops.com/?s=microservices)将发挥应有的性能。然而，微服务需要针对实际的最终用户活动进行持续测试，以使应用适应不断变化的偏好和请求。本文将涵盖五种部署策略，在发布新特性或对基于微服务的应用程序进行更改时，这些策略将对开发人员和 DevOps 团队有所帮助。

## 总是在生产中测试

对于构建健壮的微服务基础设施来说，登台环境是必要的，但还不够。虽然是指示性的，但它不能替代不断发展的用户流量和行为。当真正的用户在生产过程中与软件交互时，服务可能不会高效地执行。

用户是不可预测的。他们可能会提出你在拟定沟通途径时没有考虑到的要求。或者您的微服务架构可能无法支持实际的生产流量。当与真正的最终用户一起测试时，您可以确定您的软件的性能，并可以改进它或添加新的功能。

与真实用户一起工作的缺点是他们会受到任何错误的影响。但是，通过特定的部署策略，您可以识别问题并最大限度地减少它们对这些用户的影响。

根据您的目标，您可以在部署阶段实施[以下测试策略](https://harness.io/blog/continuous-verification/blue-green-canary-deployment-strategies/)。它们可以单独执行，也可以以各种组合的方式执行，因为每种方法对部署的贡献各不相同。

## 蓝绿色部署

蓝绿色部署使用两种截然不同但完全相同的生产环境。例如，您在蓝色环境中部署了应用程序的非活动版本。同时，最终用户可获得的最新版本在绿色环境中运行。接下来，您将代码添加到蓝色环境中。

在这个阶段，您将在蓝色环境中测试服务，以确保它们运行顺畅。您可以通过使用基本的冒烟测试来自动化这一过程。当微服务通过这些测试时，您可以指示负载平衡器逐渐将用户流量重定向到这个新环境。

如果新功能没有问题，路由器会将所有流量从绿色环境移至蓝色环境，但如果出现任何错误，可以立即恢复流量。

由于这两种环境的相同性质以及它们之间的相互依赖，几乎没有停机时间。最终用户的体验在很大程度上不受影响，开发人员可以快速修复任何错误。

旧环境充当备份，使得在不停机的情况下执行回滚成为可能。在发布最新版本后，您可以决定终止旧的实例，但是只有在您确信新的环境将继续运行而不会出错之后。您还可以克隆蓝色和绿色环境，以便将来在其他功能部署中重复该过程。

## 金丝雀部署

Canary 部署类似于蓝绿色测试，因为它可以防范与发布相关的风险。

“金丝雀部署”一词源于一种古老的采矿方法，即在矿井中放置笼中鸟来探测有害气体的存在。如果存在的话，这些气体会在影响矿工之前杀死金丝雀，从而提供一个预警，让矿工立即撤离矿井。

金丝雀部署的工作原理类似。canary 部署不是创建两个独立的环境，而是在同一个微服务或基础设施中运行。开发人员推出新的服务或应用程序版本，只对一小部分最终用户进行更改。

您可以在使用新服务时快速检测错误或漏洞。这种影响是暂时的，也是最小的，因为实验只在一部分用户身上进行，大部分用户都没有受到影响。一旦它们开始工作并通过验证，您就可以扩大变更的规模。

对于那些运行 canary 部署的人来说，最大的挑战是需要运行相同微服务的多个版本，以便它们可以一次部署给几个用户。实现多个版本还意味着您需要跟踪哪些用户使用哪些版本来运行准确的业务指标和分析。随着在同一个应用程序中部署多个 canary，这种监控会变得越来越复杂。

## 功能标志

特性标志或特性切换是写在条件代码中的变化或特性。在应用程序运行和使用时，开发人员可以根据他们的测试需求打开或关闭该特性。

代码已经部署，有两个代码路径:一个包含实现特性的代码，另一个不包含。开发者只需要选择两条路径中的一条。当开关打开时，代码块作为流程的一部分执行。当关闭时，跳过该代码，并且不实现该特性。其余的源代码继续照常运行，与特性标志的条件无关，不会干扰最终用户的体验。

集成后，功能标志允许您为一组选定的用户打开功能。与 canary 部署中的随机选择不同，特性切换通常在特定情况下使用。例如，开发人员不会创建两个独立的应用程序来实现免费和付费订阅层。相反，操作功能标志允许您使特定功能仅对订阅用户可用。

特性标志在测试期间特别有吸引力，因为开发人员可以使用它们在整个应用程序中运行小实验，而无需放弃控制权。能够远程切换开关也使得回滚更加容易。这种风险可以忽略不计，因为应用程序是自给自足的，它可以在没有该功能的情况下继续运行。

功能标志通过排列和组合的方式生成复杂的用户到服务的路径。对于特定用户，很难确定他们在使用服务时采取的确切路线。功能标志使这变得复杂，因为它允许每个用户有不同的体验，最终使应用程序难以调试。这些开关很容易以最小的风险开始使用，但是它们的维护会很快变得复杂。最好仅在需要时使用它们，并与其他部署策略一起使用。

## 交通阴影

通过流量阴影或镜像，路由器将传入流量复制到已经释放的服务，并将副本交给另一个服务。用户和现有服务之间的请求和响应机制保持不变。另一方面，具有流量副本的第二个服务包含需要测试的新特性。因此，它不会干扰现有的过程。相反，该副本用于测试其功能。

它最大的好处是，它允许新版本接收与它试图替换的服务当前接收的流量相同的流量。不需要创建测试数据或担心复制规模。这种准确性几乎没有风险，因为对现有的服务没有有形的影响。开发人员可以在这个生产环境上运行所有相关的测试，比如错误和性能指标的测试。新版本的响应不会发送给用户，也可以与产品服务的响应进行比较。两个版本彼此独立运行，具有不同的最终目标。这可以实时发生，或者可以保存一份副本并重放以供将来测试。

流量阴影可以与其他部署技术一起使用，如蓝绿色或金丝雀部署。在成功地跟踪生产环境之后，可以使用 canary 部署来逐步推出变更，以便在正式发布之前获得最大的信心。

但是，隐藏可能会产生意想不到的后果，所以在将这种策略部署到具有第三方依赖性的服务时，应该小心谨慎。

## A/B 测试

与蓝绿色和金丝雀部署不同，A/B 测试侧重于用户对新功能的感知和体验。它衡量最终用户是否以及如何与这些功能交互，它们是否容易被注意到和使用，并衡量应用程序的整体功能。它为开发团队提供了业务级别的洞察力，以改进他们的应用程序，因为这些特性最终是使用代码实现的。

A/B 测试将用户分成访问不同功能的组。例如，组 A 看到的用户界面不同于组 B，尽管这两个组中的成员都发出相同的访问应用程序的请求。流量被路由到单独的构件或公共构件上的不同配置。这是通过考虑用户的操作系统和用户代理等方面来实现的。它必须在代表最终用户的样本上运行。测试还需要显示统计上显著的结果才有效。

该测试可以与 blue-green 或 canary 部署相结合，因为它们处理该策略测试的实际特性部署。在将显示的版本与组进行比较后，可以将表现更好的版本推送给所有用户。

## 构建您的部署策略

列出的每种策略可以单独使用，也可以结合使用，最适合您的目标、工作流程和微服务要求。它们允许您识别并减少任何可能只在软件发布的最后阶段出现的漏洞的影响。实现它们可能是一个有点复杂的过程，尤其是对于较大的架构和依赖关系。但是通过实现这些策略中的任何一个，你的团队将会发布你的应用程序的最好版本。