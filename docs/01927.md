# TDD、单元测试和大型机

> 原文:[https://devops.com/tdd-unit-testing-and-the-mainframe/](https://devops.com/tdd-unit-testing-and-the-mainframe/)

单元测试就像锻炼:公司知道这对你有好处，你应该做，但是如果他们有选择的话，他们宁愿避免努力，只得到好处。

我希望我能说不是这样。毕竟，使单元测试成为公司软件开发过程中的标准实践，可能是企业为显著提高代码质量所能做的第一件事，也是最好的事。更进一步，采用测试驱动开发(TDD)的最佳实践不仅可以从长远来看加快发布速度，还可以降低代码维护的成本。例如，如果你想知道一段代码应该做什么，你需要做的就是回顾单元测试。这减少了对大量支持文档的需求。

这几乎是显而易见的。然而，仍然有很多人认为 TDD 先写测试会减慢开发过程。这种想法是，如果开发人员打算在编写代码之前为代码编写测试，那么只要节省时间，无论如何都要编写代码，然后只为代码的关键部分编写测试。

这可能是对 TDD 过程的有力反驳，除了两件事。首先，你能说出你的代码库中不应该被测试的部分吗？第二，正如我们这些身处实地的人所发现的，当发布时间临近，开始偷工减料的时候——他们确实被偷工减料了——很多时候首先要做的就是单元测试。不止一个开发经理在面临最后期限和人员不足的开发团队时说过“我们会在 QA 中发现它”的话。可悲的是，当在按时发布一般的代码和延迟发布以创建优秀的代码之间做出选择时，我的经验是，在没有将单元测试纳入可接受的代码覆盖率阈值的公司中，一般的代码每次都会胜出。那些痛饮 TDD Kool-Aid 的人不必做出这样的选择。测试已经写好了。

的确，世界上所有的单元测试都不会让设计糟糕的代码变得更好。但是，如果工程是合理的，单元测试是可行的。尽管如此，公司还是抵制，甚至是那些用单元测试作为一种生活方式出现的语言编程的公司。有很多企业在开发 Java、C#、Python 等。，他们希望从单元测试中获益，但又不想为此付出代价。当涉及到大型机社区时，阻力会像二战中在法国地下组织中发现的那样强烈。

为什么？嗯，当涉及到大型机开发时，单元测试比在 x86 世界中更难实现。还有语言兼容性的问题。仍然有大量的 COBOL 支持世界上仍然驻留在大型机上的 80%的数据。单元测试作为一种生活方式，在计算机历史上是最近才出现的。对于 Java，C/C++，有很多测试库。NET，Python。但是直到最近，还没有任何针对 COBOL 的单元测试框架。此外，在传统的大型机编程中，您可能会遇到许多开发人员处理同一个代码体的情况。测试隔离可能很难。

最后，还有文化问题。记住，使单元测试和 TDD 工作的事情是设计和执行测试是开发人员的责任。将测试推给开发人员是一种与传统大型机的敏感性相冲突的观念。在过去的传统大型机商店中，开发人员编写代码并进行 QA 测试。这是一个工作了很多年的过程，这些年意味着你可以每六个月发布一次代码。今天，如果不是每天，也是每周进行代码修订。尽管如此，开发/QA 部门仍然存在于由大型机驱动的老公司中。

但那是过去，现在是现在。我很高兴地告诉大家，这是大型机软件开发领域的新一天。普遍采用 TDD，特别是单元测试，作为大型机软件开发中的一种生活方式，不仅是可能的，而且就像我上面描述的那样，这几乎是一件不需要动脑筋的事情。工具和流程都在那里。让我们来看看。

## 使用 IBM Z 开放单元测试对大型机代码进行单元测试

为大型机编写单元测试经历了一段艰难的历史。如果您在过去的十年中开始了您的软件开发职业生涯，那么您已经享受到了 TDD 和 CI/CD 作为一种标准的商业方式的好处。Jenkins、JUnit、Selenium 之类的工具一直都在。但是在大型机世界中，对许多人来说，这都是新事物。

因此，对于许多大型机开发人员来说，编写单元测试的概念(更不用说将单元测试集成到 CI/CD 过程中)意味着进入一个陌生的新世界。在工具出现之前的世界里，编写任何测试，更不用说单元测试了，都意味着在某种临时搭建的测试环境中花费数天时间做单调乏味、费力的工作。或者，在某些情况下，开发人员可能根本不负责测试代码。更确切地说，开发人员编写代码，并通过任何必要的手段让代码工作到他或她满意的程度。然后他或她将代码交给 QA 部门进行测试。那些测试过程是什么，外人可能知道，但在很多情况下他们并不知道。因此，开发过程充其量变成了团队之间缓慢而艰难的测试结果和补救措施的交换，而这些团队对其他团队的过程和优先级了解有限。

好消息是那些了解内情的人开始明白有更好的方法。更好的方法包括三件事。首先，让开发人员负责测试他或她编写的代码。第二，消除开发和 QA 之间的文化障碍，在很多情况下，组织障碍。第三，将工具放在测试活动的最前沿。

换句话说，新的想法是理解测试必须在软件开发周期中尽早完成(因此，[向左移动](https://en.wikipedia.org/wiki/Shift-left_testing))，每个人都对软件的质量负责，并且工具的采用在 TDD 过程中是至关重要的。

建筑业很久以前就抓住了这个概念。一辆由称职的操作员驾驶的推土机比一大群拿着铲子的人更适合运土。软件开发也是如此。给单个开发人员一个工具来创建和应用测试到他或她的代码，比让一大群其他员工坐在文本编辑器前为他们的代码编写一次性的单元测试并手工应用它们要好。

这就把我们带到了 IBM 单元测试。

## IBM Z 开放单元测试

[IBM Z Open Unit Test](https://www.ibm.com/us-en/marketplace/z-open-unit-test) 是一个工具，旨在快速高效地在大型机上编写和执行单元测试。此外，IBM Z 开放单元测试有助于在 Jenkins 这样的工具下将单元测试直接集成到公司的 CI/CD 流程中。

这些工具支持批处理和 CICS COBOL 程序的自动化单元测试。此外，IBM Z Open Unit Test 为 CICS COBOL 程序提供了记录和回放功能，如图 1 所示。这个工具允许开发人员轻松地记录对 CICS 的外部调用，并导入记录的数据以便在回放时进行修改。在执行时记录、修改和回放测试数据的能力意味着开发人员可以将他们的自动化单元测试作为构建的一部分(或者作为批处理作业)来运行。没有必要部署到 CICS，因为它现在已经被剔除了。

IBM Z 开放单元测试与 TDD 方法一致，因为该工具允许开发人员在一个易于使用的界面中记录、查看和修改作为断言的输入和预期输出。这可以在对程序进行更改之前完成，开发人员可以了解流入和流出的是什么类型的数据。

![](../Images/4c926960b14636289d2408327d750f95.png)

Figure 1: IBM Z Open Unit Test has data recording and playback capabilities for Batch and CICS COBOL programs.

如上所述，IBM Z 开放单元测试可以从 IDE 中运行，或者作为企业 CI/CD 流程的一部分来执行。此外，该产品支持测试调试和导入以主流格式(如 JUnit 和 SonarQube)编写的测试。这些都是好的和重要的特征。但是真正的亮点是对代码覆盖的支持。

## 为什么代码覆盖率很重要，即使对于大型机测试也是如此

就测试管理而言，代码覆盖率是房间里的大象，尤其是在单元测试方面。测试驱动开发的一个关键原则是每一行代码都要经过测试。然而，这是梦想而不是实践。我去过不少声称支持 TDD 的公司，但是当被问及他们是否测试了每一行代码，也就是 100%的代码覆盖率时，答案通常是“我们正在实现它”

许多公司对他们的开发人员正在进行任何单元测试感到高兴。在这样的公司中，要求一个开发人员达到 100%的覆盖率就像要求他或她去月球并在午餐时返回一样。

一些稍微成熟一点的公司，把覆盖标准定在了 80%。这意味着只要每 10 行代码中有 8 行被单元测试接触到，事情就很好。或者他们是？如果未测试的两行代码是 if-then 语句中一个很短的 else 子句，吃掉内存，阻塞 I/O，怎么办？这是你想在测试中保持不变的两行代码吗？记住这一点:通常并不是经过测试的代码造成了破坏，而是未经测试的代码。

因此，100%代码覆盖率的任务至关重要。

大型机开发已经落后于确保 100%代码覆盖率的要求。这主要是由于遗留软件开发实践的文化和当时工具的不成熟。好消息是文化和工具都在发展。

回到 IBM Z Open Unit Test，该工具不仅提供了测试覆盖报告，这对于提供达到 100%覆盖所必需的度量标准是至关重要的，而且还提供了支持负面测试的特性。

否定测试也称为不愉快路径测试。这是单元测试的一个重要但经常被忽视的方面。仅仅是让一段代码在正确的条件下工作就已经够难的了。要让代码经受所有可能发生的坏情况(不愉快的路径)并确保它仍然工作，需要做大量的工作。因此，当关键时刻到来时，它总是会到来，通常开发人员会放弃消极的、不愉快的测试。这不是恶意的。这是关于满足最后期限。

幸运的是，这种动态是业内已知的问题。IBM Z 开放单元测试通过提供一个自动生成否定测试的特性来解决这个问题。这是一件大事。事实上，如果这是该工具所做的全部工作，那么它将是大型机上 TDD 实践的福音。编写阴性测试是一项乏味、费力的活动。使用像 IBM 单元测试这样的工具不仅节省时间，而且有助于实现最终目标:100%的代码覆盖率。

## 把所有的放在一起

单元测试是 TDD 实践的重要部分。虽然 TDD 已经在基于 x86 的分布式计算中占据了主导地位，但是在大型机计算中却出现了滞后。

大型机计算再次变得非常酷，如果没有其他原因，它目前控制着世界上 80%的数据，并且在许多方面是云之前的云。在过去，由于缺乏工具来支持这一学科，TDD 很难在大型机世界中实现。幸运的是，有了 IBM Z 开放单元测试这样的现代工具，在大型机开发社区中可以很容易地享受到 TDD 的好处。

鲍勃·雷瑟曼