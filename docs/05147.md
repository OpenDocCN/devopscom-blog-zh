# DevOps 聊天:Canary 使用 Istio 和 Autodesk 部署

> 原文：<https://devops.com/devops-chat-canary-deploys-using-istio-with-autodesk/>

Spinnaker Summit 2019 预览:金丝雀部署为我们提供了一个窗口，让我们了解新代码如何在有限的基础上在生产中部署和执行。该技术有望帮助我们了解部署的积极或消极影响，而不会将更广泛的微服务、应用功能等置于风险之中。

你如何安排交通路线？如何应用虚拟服务清单？有没有一种快速的方法来执行冒烟测试以发现服务器错误？当比较新旧代码的度量时，如何知道哪些结果是好的或坏的？关于如何部署和使用加那利有很多需要了解和学习的。

我们的 DevOps 聊天嘉宾 Omar Al-Hayderi 是 Autodesk 的工程经理兼首席工程师，他将在 2019 年 Spinnaker 峰会上发表题为“Canary deployments with Istio:Lessons Learned”的演讲。他的演讲是在太平洋时间 11 月 17 日周日下午 1:30。

像往常一样，下面是流媒体音频，然后是我们的谈话记录。

[https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/701685979&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true](https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/701685979&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true)

## 副本

米奇·阿什利:大家好。我是 DevOps.com 的米奇·阿什利，您正在收听的是另一个 DevOps 聊天播客。今天，我和奥马尔·阿尔·海迪里在一起。他是工程经理，曾任 Autodesk 首席工程师。奥马尔将在圣地亚哥举行的 2019 年 Spinnaker 峰会上发表演讲。他的演讲是关于金丝雀和 Istio 的部署。它发生在 11 月 17 日星期日下午 1:30

奥马尔，欢迎来到 DevOps 聊天播客。

奥马尔·阿尔·海迪里:谢谢你邀请我，米奇。

阿什莉:你能来真是太好了。我很高兴听到你的演讲。但是首先，告诉我们一点关于你自己，介绍你自己，以及你在 Autodesk 做什么。我想我们了解 Autodesk，也许你在 Autodesk 的哪个部门工作。

是的，是的。所以，事实上我最近经历了很多变化。我当时在一家名为 PlanGrid 的初创公司工作，四年前，我们还是一家小型建筑软件公司，从那以后我们成长了很多。我在那家公司开始是一名后端多面手。你知道，该公司实际上有 25 名工程师，自收购以来已经成长了很多。我们以大约 400 名员工的价格被收购。

在那段时间里，我很自然地成为了一名 DevOps 基础设施工程师，是的，这是我一生中最美好的四年。在那里真的学到了很多。收购后，我成为基础设施团队的首席工程师。然后我们经历了一次重组，我成了后端平台团队的工程经理。现在，这个团队专门围绕我们的开发运维及基础架构云构建了许多工具。

阿什利:嗯，太好了。嗯，这是您在 Autodesk 的绝佳体验。听起来你在做一些很棒的事情。你是如何决定在 Spinnaker 峰会上用 Istio 谈论金丝雀的？这是你选择在 Autodesk 引入并启动的东西吗？你加入了一个已经在使用它的团队？你来这里想谈谈这件事的背景是什么？

艾尔·海迪里:是的。所以，我有点，你知道，在 Spinnaker 的早期阶段，我尝试了一下，我真的被这个工具迷住了。我喜欢使用各种各样的功能，并且喜欢摆弄它。在 PlanGrid，实际上，在我们被收购之前，我们每年都做黑客周，我们可以从我们定期安排的计划中脱离出来，做我们喜欢的事情，享受乐趣。

Spinnaker 最近出现的一个想法是部署金丝雀。所以，我用它做了实验，但从未成功过，一年后，到了下一个黑客周，Kayenta，Spinnaker Canary 组件，更加完善和用户友好。所以，我设法让它起飞了。

我们在 PlanGrid 有一个整体 API。因此，我们遇到的一个大问题是，我们每周发布一次，发布后，东西会坏掉，人们会收到传呼，我们必须回滚，所以。

**阿什利:** *【笑声】*恶性循环。

Al-Hayderi: 我相信每个人都很熟悉这个普通的故事。

阿什利:嗯。

Al-Hayderi: 所以，我真的很想找到一种方法来解决这个问题，而 Canary 似乎是一个很好的方法。所以，在黑客周之后，我差不多一直在做这个项目，我开始向公司的其他人做演示。因为金丝雀是一种新的概念，很多人都不熟悉。你知道，我开始活跃在 Spinnaker Slack 渠道中，事实证明，一名前 PlanGrid 员工搬到了网飞，在那里成为 Spinnaker 开源软件的领导者。

阿什利:啊，有意思。

" T0 "是啊。

**阿什利:**世界真小。

艾尔·海迪里:是的。*【笑声】*他注意到我谈论了很多，他提出了他们将在 11 月举办大三角帆峰会的观点，并问我是否想谈谈。实际上我从未在会议上做过演讲。

阿什莉:哦，太好了。

Al-Hayderi: 是的，我在内部做了很多演讲。所以，这是我非常兴奋的事情，是的，我抓住了它。

阿什利:这对你的职业生涯也是一件大好事，听起来那些内部谈话已经为你做好了准备。

" T0 "是啊。

阿什利:那么，你是如何决定的，这是如何做的概述吗？是否会是“这是需要观察的指标”，并且从中得出的价值是这两者的组合？告诉我们一点关于你在这方面的情况——你在演讲中的观点。

艾尔·海迪里:是的。所以，说实话，我年轻的时候，公开演讲从来都不是我的强项。我得到的一些很好的建议是，当你对一群人演讲时，你要像讲故事一样讲。

阿什利:嗯。

**Al-Hayderi:** 所以，从那以后，我真的开始专注于讲故事，甚至是我在内部做的这些技术演讲。

所以，我在这里试图讲述的故事是我们如何利用 Istio 最终解决了一些运行金丝雀的深层技术问题。

阿什利:嗯。

**Al-Hayderi:** 一旦我们开始了，就像成长的烦恼，你知道，我们遇到的第一个障碍和问题。我希望人们能够更好地了解如何在您的基础设施中实际运行这一功能，并避免一些常见的陷阱。

阿什利:嗯。太好了。好吧，给我们讲一点这个故事。让我们开始走这条路。

Al-Hayderi: 总共。所以，我做的第一件事就是，我走进去了解金丝雀到底是什么。它的基本要点是，你想把少量的流量暴露给新事物。你想分析新旧之间的差异和某种度量标准。然后，您需要决定这种新技术是否适合大多数流量。

阿什利:嗯。

Al-Hayderi: 所以，这里面有很多东西。任何在生产规模上使用过 Spinnaker 的人都知道，管理所有这些管道定义是非常麻烦的，如果您试图最终更改某些东西，尤其是更改生产管道，这可能非常危险。

所以，我们了解到的很多事情，你知道，我们是如何测试的，甚至只是在我们的 R&D 开发阶段环境中测试金丝雀进程和那里的问题，即使我们对管道的工作方式有信心，也很难获得关于如何实际调整金丝雀的信号。当我说调整时，我的意思是，当您比较新旧指标时，您如何知道它是否不好，或者您如何知道向前发展是否是一个好的决策？阈值是什么，您关注什么指标？我们的许多迭代都集中在这一点上。

**阿什利:**有意思。现在，我很好奇，您是否正在解决使用 Canary 来了解服务网格或服务本身的问题，或者您是否也试图了解类似 Istio 和它作为 sidecar 代理的作用，以及它是如何协调流量负载平衡的？是一个还是另一个，或者两者都是，或者你想解决问题的哪一部分？

Al-Hayderi: 对。所以，实际上，我们有点受阻，因为我们无法路由来自互联网的小粒度流量。目前我们实际上只使用 Istio 的 API 网关特性。

阿什莉:哦，好吧，好吧。

**Al-Hayderi:** 是的，现在有一些拦截器，至少在我们的 Istio 版本中，我们正在通过 SSL 连接 Redis。所以，有边车或应用程序箱是不允许的。因此，当我们做金丝雀时，我们只是在欺骗终端用户或让流量进入我们的整体。

阿什莉:好的。

" T0 "是啊。

**阿什利:**有意思。那么，给我们讲讲这个故事。你是如何着手实施它的——你从中学到了什么？

**Al-Hayderi:** 所以，我的意思是，首先，我们有一种雪花 y 管道，可以部署我们自己的小服务，改变流量并比较指标。所以，我想第一部分是我们如何路由流量，我们实际上做的是，在一个单一的管道中，我们将部署容器到一个新的超级组，我们将使用 Kubernetes 的 V1 提供商。

阿什利:嗯。

Al-Hayderi: 然后我们实际上使用了 Kubernetes 的 V2 提供商来应用虚拟服务清单。虚拟服务只是一种基于一些规则来路由入口流量的方式。因此，如果主机头与此匹配，并且路径包含此正则表达式，则将它路由到此服务。

您还可以做的是，当您基于某个 ____ 路径前缀匹配一个规则时，它会基于权重被路由到几个服务。所以，我们首先试验了如何获得少量的流量，但足够有意义的流量来获得足够好的数据样本。

因此，在开始时，我们做的很多事情就像负载测试一样，“好吧，金丝雀部署的 5%的流量够吗？10 个怎么样？”等等，等等。我们还研究了一些关于 Canaries 的常见最佳实践，以及它们如何推荐运行基线部署。因此，我们实际要做的是部署两个新部署。因此，一个在小型服务器上安装新代码，另一个在全新部署的小型服务器上安装旧代码。这样，你就可以从实验中去掉很多变量，比如长时间运行的过程，等等。

所以，我们到了那里，得到了正确的交通路线。现在，我们要做的下一部分是度量，对吗？我们如何分析两次部署之间的差异？在这一点上，Kayenta 只支持 Datadog，至少在我们使用的度量提供者中是这样。

阿什莉:好的。

Al-Hayderi: 所以，我们真正想做的，你知道，回到让金丝雀离开的要点上来，就是停止那些完全被破坏的部署，对吗？所以，这是一种便宜又简单的测试方法。所以，我们只是在寻找服务器错误。

因此，当我们尝试时，问题是，Istio 提供的服务器错误指标将只发送服务器错误发生时的指标。因此，在两次部署之间，如果在一次部署中只出现了两个服务器错误，这将被视为失败。它没有提供汇总指标的选项，所以我们无法检查错误率。所以，那真的没用。

实际上，在我的演讲中，我进入了一种——这是一个很大很大的问题，当我们第一次把它投入生产时，金丝雀会无缘无故地失败，对吗？金丝雀运行了一个小时，你知道，我们的发布工程师坐在那里等了一个小时，然后不得不再次触发它，只是因为，你知道，金丝雀部署中发生了一个服务器错误。

阿什利:嗯，这听起来像是你学到的一个教训或你想出的一个概念是，不要撒大网。从更高的、更大的、最基本的问题开始，类似于某种概念。从那里开始，获得那些——修复、改进质量，这样你就可以更好地工作，也许可以把网收紧一点，过滤掉一些导致问题的更具体的东西。这听起来像是你学会的方法吗？

就是这样，实际上，我建议你第一次分发金丝雀的时候，不要让它真的失败，或者如果金丝雀不成功就收回部署。

阿什利:嗯，好的。

**Al-Hayderi:** 我们实际上最终做的是实际运行一个月，收集数据，查看哪些指标有效，哪些指标无效，并将金丝雀报告与我们实际看到的生产中的问题对应起来。这样，我们就能获得更多关于使用哪些指标的信息。我们最终采用了平均延迟和 95 P 延迟，一旦达到这一水平，我们就开始实际中止和回滚部署，然后我们开始获得该工具的巨大价值。

阿什利:嗯。是的，这实际上非常类似于质量流程，对吗？你不能一下子解决所有问题。你开始，你确定优先顺序，你过滤，你完成工作——你知道，一步一步地改进它，而不是只是扔一只金丝雀出去看看会发生什么，听起来你会得到结果，但你不知道什么或为什么，对吗？

是的，没错。

阿什利:听起来，你必须深入研究，更加深思熟虑。

" T0 "是啊。

阿什利:很好。还有别的吗？你还想在这个话题中谈些什么其他的大事情吗？

**Al-Hayderi:** 所以，我们学到的另一件重要的事情是，即使在这之后，你知道，我们相信我们的金丝雀在应该失败的时候失败了，在应该通过的时候通过了。我们遇到的问题是，当金丝雀失败时，人们真的不知道该做什么。

阿什利:嗯。

Al-Hayderi: 因为，你知道，当一次部署失败时，我们有大量的数据，而且我们有很多可观察性。金丝雀得到的流量少了很多，仅仅通过查看 Spinnaker UI 金丝雀报告很难确切知道什么失败了。

阿什利:嗯。

**Al-Hayderi:** 所以，你知道，我们在 APM 上投入了更多——我们使用了 New Relic，并将我们的金丝雀放入其中，这样我们就可以实际看到事务数据以及它与基准指标之间的差异，从而了解哪个端点出现了问题，或者有新的数据库核心利用了这一点——这对我们也有很大帮助。

阿什利:嗯。有意思。嗯，听起来好像您在使用—以系统的方式思考这个问题，不仅仅是 Canaries 和 Spinnaker，您还提到了 Datadog、New Relic 以及您在环境中使用的许多工具，所有这些都必须结合在一起才能解决问题，对吗？不仅仅是一件事。

" T0 "是啊。

阿什莉:嗯，很好。我祝你在谈话中一切顺利。参加这次演讲的人，他们会是软件开发人员、工程师、架构师，还是专注于 DevOps 团队的运营人员？谁更倾向于对此感兴趣？

Al-Hayderi: 我会说更多的 DevOps 操作人员。在公司中使用 Spinnaker 管道定义的人将从中获得最大的价值。但是，你知道，当我还是一个开发者的时候，我听到了一个关于金丝雀的演讲，这多少激发了我做这个的想法。所以，我的意思是，任何对弹性和释放自信感兴趣的人都会从这个演讲中获益。

阿什利:好的，很好。非常好。谢谢你上播客，奥马尔。

非常感谢你，米奇。

**Ashley:**Omar Al-Hayderi 是 Autodesk 的工程经理，以前是首席工程师，很高兴您能加入我们。他将在圣地亚哥举行的 2019 年 Spinnaker 峰会上发表演讲。日期是 11 月 17 日到 19 日，奥马尔的演讲是在 17 日周日下午 1:30

所以，感谢你们所有人加入我们，收听这一集的 DevOps 聊天播客。我是 DevOps.com 的米奇·阿什利。您已经听到了另一个 DevOps 聊天。在外面要小心。

— [米切尔·阿什利](https://devops.com/author/mitchellashley/)