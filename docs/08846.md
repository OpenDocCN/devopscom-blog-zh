# 大规模管理 GraphQL

> 原文:[https://devops.com/managing-graphql-at-scale/](https://devops.com/managing-graphql-at-scale/)

GraphQL 是由脸书发明的查询语言，作为一种方便地以编程方式访问数据的方法，它吸引了很多人的兴趣。GraphQL 使用统一的数据模式来构建内部服务，使产品工程师能够轻松地从许多微服务中获取他们想要的内容，以填充他们正在创建的用户界面(ui)。通过将公司数据统一到一个图表中，GraphQL 结合了 SQL 的优点和 API 访问的普遍性。

然而，当您试图在大型企业和合作伙伴生态系统中扩展 GraphQL 时，它确实会带来一些挑战。例如，由于 GraphQL 通过单个端点传递所有请求，因此安全性必须小心地对所有底层基础设施的访问进行分段，以避免数据过度暴露。阿波罗的联合创始人兼首席技术官马特·德贝加利斯(Matt DeBergalis)也指出了在大规模采用图表时围绕可变性和性能的潜在问题。

随着 GraphQL 在大型组织中的使用越来越多，开发团队将不得不克服这些障碍——特别是如果公司打算将公共 API 产品化，并在公司范围内重用同一个图形。我最近会见了 DeBergalis，了解大规模管理 GraphQL 的最新情况。根据 DeBergalis 的说法，我们仍然处于图表革命的早期。此外，未来 GraphQL 的成熟将需要更多基于规则的声明式架构、效率改进和适应能力，以实现图形模式的敏捷迭代。

## GraphQL 的采用情况

那么，是什么推动了 GraphQL 的崛起呢？德贝加利斯指出了三个关键因素:

1.  **许许多多微服务**。近年来，微服务出现了[式的爆发。这些模块化服务很难争论，而且在整个软件生态系统中经常不一致地公开。](https://devops.com/digital-customer-experiences-the-future-is-modular/)
2.  **全渠道平台的崛起**。产品工程师现在必须在不同的设备之间移植相同的数据，无论是在浏览器中还是在 Peloton 屏幕上。
3.  **用户希望获得丰富的数据体验**。人们对 T2 的期望空前高涨。例如，现在预计电子商务商店将包括产品推荐、自动填充关键字搜索、按地理位置定价和许多更高级的功能。

DeBergalis 解释说，处理所有这些因素会产生一个“复杂性瓶颈”。

GraphQL 响应了这种复杂性，帮助统一后端，使产品开发人员能够准确地获取他们的客户端应用程序所需的内容。DeBergalis 补充说，GraphQL 的采用非常迅速，特别是在产品工程团队中。GaphQL 与 JavaScript、React 和 Relay 等熟悉的语言和框架配合得很好。这也与以前的趋势有所不同，需求更多地由数据库人员推动；“提问的人是真正的领导者，”他说。

有了正确的技术堆栈，开发人员可以在底层核心 API 和他们正在构建的 UI 之间添加一个图形层，创建一个具有自文档化模式的通用 API。“对于开发者来说，GraphQL 的神奇之处在于抛弃了所有这些锅炉代码，”DeBargalis 说。他说，GraphQL 充当“明天的基础”，帮助交付未来的业务需求。

关于 API 的架构风格，根据 Postman 的 2021 年 API 状态报告，94%的人仍然使用 REST，31%的人使用 GraphQL。虽然这个比例现在看起来很小，但 GraphQL 在大公司中的采用正在稳步增长，如 [PayPal](https://medium.com/paypal-tech/graphql-at-paypal-an-adoption-story-b7e01175f2b7) 、[网飞](https://netflixtechblog.com/beyond-rest-1b76f7c20ef6)、Shopify、GitHub 和 Airbnb。

## 缩放图表时的三个问题

使用 GraphQL 就像使用手机一样。你不会想每次打不同的号码都用不同的电话吧？您希望从同一台设备上访问您的所有联系人。类似地，GraphQL 的优势在于添加的功能越多。

“由于网络效应，当我们发布更多的内容时，图表变得更加有趣，”德贝加利斯说。"我们发现 GraphQL 在规模上最有意思和价值."那么，GraphQL 在规模上的一些不可避免的后果是什么呢？DeBergalis 概述了三个主要的架构问题。

### 表演

性能下降是开发人员在考虑 GraphQL 时经常提到的一个缺点。GraphQL 没有内置的缓存特性，并且[负载查询](https://medium.com/@wtr/graphql-performance-explained-cb4b43412fb4)可能会引入额外的延迟。DeBargalis 说，减轻有关吞吐量和可靠性的低级问题可能需要来自社区的额外工具。这也是为什么 Apollo 团队已经开始在[拥抱 Rust 的部分原因，新的尝试](https://rustrepo.com/repo/apollographql-router-rust-graphics)让 GraphQL 路由的基础设施超高效。

### 可变性

企业在扩展 GraphQL 时可能遇到的第二个问题是为这种无所不包的结构提供敏捷性。“GraphQL 做得很好的公司一直在改变它——他们把它当成一种产品来对待，”DeBergalis 说。这种敏捷性与传统的为长寿而构建的 REST API 方法是不一致的，这使得这种方法非常不愿意破坏变更。

现实情况是，当一个公司采用一个单一的图时，它可能每天都在推动数百个模式变化。不同的内部团队可能会维护他们自己的那部分图表，对其进行不同的定义。此外，DeBergalis 指出，随着时间的推移，维护角色可能会从一个团队转移到另一个团队。“如果你试图瀑布式地展示你的库存模型应该是什么样子，你将一事无成，”他说。

平衡变化和稳定性可能需要对 GraphQL 采取双管齐下的方法。您希望用实验性的特性不断地迭代图，但是也依赖于某些功能来保持对客户端集成的向后兼容性。要让双方都满意，可能需要一个快速迭代的变更管理策略，以及企业级服务水平协议(SLA)来保持一个坚实的基础，在此基础上构建更持久的数据模型。

DeBergalis 还描述了[可观察性](https://devops.com/could-full-stack-observability-help-lessen-its-burden/)对于获得图形环境的清晰图像是多么重要。这是 GraphQL 的一个亮点——因为客户请求的正是他们所需要的，所以您永远不会怀疑哪些方法已经被获取，但没有在生产中实现，而 REST API 管理可能会发生这种情况。根据 DeBargalis 的说法，使用 KPI 跟踪细粒度的 GraphQL 使用情况有助于指导数据模型应该如何随时间发展。

### 批准

最后，围绕 GraphQL 的最大问题可能是为用户和设备分配适当的访问权限。由于单个统一端点可以连接到后台的大量数据，因此大型 GraphQL 实现将需要一个策略，以确定如何分部分实现一个统一的图形。

如果没有适当的访问控制，GraphQL 可能会不恰当地暴露个人身份信息(PII)。例如，一家金融科技公司可能有一条规则，要求客户服务代表只有在客户在过去几天提交了支持票据的情况下才能查看客户的交易历史。或者考虑数据保管——在欧盟工作的企业必须遵守关于数据可以和不可以存在的法规。

保护 GraphQL 需要一个声明性的设置，将授权控制和上下文集成到 GraphQL 查询中。为了实现这一点，DeBergalis 提倡一种命令-控制风格。首先，围绕数据和问题陈述构建模式。接下来，您逐个字段地集成规则，将敏感的接触点标记为 PII。

通过将规则嵌入到查询中，您可以对周围的环境有一个更坚实的理解。DeBergalis 说:“在图的层次上，授权实际上要好得多。"这是具有语义理解的层."

## GraphQL 可伸缩性的未来

“一旦你有了一个图表，你就会想把它用在任何事情上，”德贝加利斯说。GraphQL 的遗产是 JavaScript，产品世界的语言。而且，图表方法为产品工程师提供了极好的体验。GraphQL 纯粹的可用性和生产力优势预示着在未来几年中的巨大应用潜力。

正如我们已经讨论过的，在整个企业中扩展 GraphQL 可能需要性能改进、模式适应性途径、处理查询授权的策略以及更强的业务度量责任。虽然 GraphQL 在一个工程师小组中肯定有现有的势头，但有很多机会引入更多的培训和教育课程来传播更大的意识。

此外，对于那些来自传统 REST API 思维模式的人来说，GraphQL 是一种新的范式，需要一些信息来将图形端点公开为产品化的 API。这样做可能会涉及到标记更大图表的选择部分，以向合作伙伴公开。“从内部 GraphQL 用例开始确实很好，但围绕 GraphQL 的产品化即将到来，”DeBergalis 说。

统一图的价值如此强大，对图形环境的自下而上的渴望如此强烈，以至于 GraphQL 的采用越来越多。“在这个阶段，重点是扩张，”德贝加利斯说。“我们如何将此推广到更多的团队？”

“我们知道每家公司都会有一张图表——不是很多小公司，”德伯加利斯说。“每家公司都需要一张图表。”当那一天到来的时候，架构上的挑战将会是把图表分解成碎片。“这是下一个大的前沿。”