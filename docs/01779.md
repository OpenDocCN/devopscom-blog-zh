# 敏捷基础设施:因为你的基础设施也值得测试

> 原文:[https://devo PS . com/agile-infra structure-infra structure-worths-tests/](https://devops.com/agile-infrastructure-infrastructure-deserves-tests/)

***编者按:**这篇文章更新于 2018 年 8 月 4 日，以反映文章结尾更新的幻灯片演示。*

基础设施即代码是一个真正强大的概念，其重要性可以用 Chef 首席技术官 Adam Jacob 在[Web Operations:Keeping the Data On Time](http://shop.oreilly.com/product/0636920000136.do):*中的话来描述:“只需一个源代码存储库、一个应用程序数据备份和裸机资源，就能实现业务的重建。”*因此，将基础设施视为代码被认为是在连续交付和开发运维中分别减少周期时间和最大化流程的关键原则，这并不是没有意义的。即使当您阅读本文时，您的计划没有那么大胆，难道您不同意随后在基础设施级别上对您自动化的东西进行验证——在投入生产之前很久——将是非常强大的吗？

所以，请耐心等待一段时间，请不要简单地选择一个已建立的基础设施自动化工具(如 Chef 或 Puppet)，让每个人都接受 Ruby 培训，然后盲目地开始“自动化所有的事情”，就一头扎进自动化。如果你是这样做的，那么你很可能做错了。你做错了。企业中的自动化。作者艾伦·夏普-保罗建议，在进行任何自动化之前，你首先必须准确理解需求，以及如何验证它们，以衡量成功并随着时间的推移保持自动化的质量:

*   配置文件准备好了吗？它们包含正确的设置吗？
*   这个港口开放吗？那个港口关闭了吗？

## 为什么选择敏捷基础设施？

老实说，你和我都不会指望任何人仅仅通过选择一种任意的编程语言和一个漂亮的 IDE 就能开发出可靠的软件，对吗？同样，可靠生产环境的(自动化)供应也需要同样有条理的方法。幸运的是，基础设施即代码使我们能够将基础设施的供应以及自动化部署和配置视为一门[敏捷工程学科](http://www.extremeprogramming.org/)。尽管[敏捷基础设施](http://www.infoq.com/presentations/agile-infrastructure)的概念并不是全新的，但是直到最近，随着 [Ansible](https://www.ansible.com/) 、 [Chef](https://www.chef.io/) 、 [Puppet](https://puppetlabs.com/) 、 [Docker](https://www.docker.com/) 、[vagger](https://www.vagrantup.com/)和 [Serverspec](http://serverspec.org/) 等工具在[测试厨房](http://kitchen.ci/)下的整合，针对实时基础设施的测试才变得容易起来(详见下文)。以下是将敏捷软件开发实践应用到基础设施层面的一些关键含义:

### 开发人员和运营人员的协调

敏捷软件开发团队由客户需求驱动，目标是在短时间内定期产生结果。使 IT 运营和基础设施部门能够在小的迭代中工作，并快速对变更做出反应，这允许他们与软件开发保持一致，并有效地被软件开发所驱动。这些共同努力的结果将是在每一次迭代结束时，*工作和可部署的软件*。

### 快速失败:反馈循环

将基础设施测试作为连续交付构建管道的一部分来执行(在部署应用程序和执行长期运行的测试之前),建立了另一个重要的反馈循环，使您能够“快速失败”并让正确的人参与进来。潜在的原则很简单:通过两次表达你的意图——一次在代码中，一次在测试中——只要这些假设不匹配，你就会知道你已经发现了一个错误。

### 回归安全性

信不信由你:无论你是使用 Ansible、Chef、Puppet 还是其他任何软件——你都是在运行代码！他们各自的问题列表中充满了各种严重程度的未解决问题，并定期出现新问题。为您的基础设施建立一个足够的测试安全网，可以让您在 bug 悄悄进入时(从任一侧)快速识别它们，并保护您免受不必要的退化。毕竟，基础设施中的 bug 可能很难追踪，并且可能比应用程序中的 bug 更严重。

### 重构

当您有测试时，代码重构变得轻而易举，当您破坏了您的基础设施的期望状态时，测试会立即提醒您(并且您想要的只是使您的代码更简单和更易维护)。当您想要从公共中心(如 [Ansible Galaxy](https://galaxy.ansible.com) 、 [Chef 超市](https://supermarket.chef.io)或 [Puppet Forge](https://forge.puppetlabs.com) )上提供的第三方组件重组您的现有基础设施时，尤其是当您正在从您现有的自动化堆栈中进行迁移时，这是非常宝贵的。

## 测试驱动开发的红色、绿色、重构循环

测试驱动开发(TDD) 是一个流行的软件开发过程，它包括编写代码，简而言之，重复开发周期，目标是实施良好的设计并增强信心。虽然它肯定不是银弹，并且在过去已经被[有争议地讨论过](http://martinfowler.com/articles/is-tdd-dead/)，但是[红绿重构周期](http://blog.cleancoder.com/uncle-bob/2014/12/17/TheCyclesOfTDD.html)，它是 TDD 的核心，我想在这里快速总结一下它的原则，希望能给你一些关于如何逐步构建你的基础设施的启发:

1.  **红色**:了解需求和想要实现的状态。然后思考如何在测试中捕捉这种状态。实现测试，然后运行您的整个测试套件，看看添加的测试是否失败——如果没有，那就真的有问题了。
2.  绿色的:实现足够的功能以通过测试。现在不要太在意可读性、简单性和设计——让它工作就好。再次运行测试，观察所有测试是否通过。如果没有，要么修复您的测试或您的实现，要么后退一步(恢复到代码中已知有效的点)并以较小的增量重新开始。
3.  **重构**:现在你的测试通过了，改进你的实现，通过再次运行你的测试，确保你没有破坏任何东西。一旦你完成了重构，重新开始这个循环。

请记住，循环的每一次重复都是指一个小的增量。就基础设施而言，这种增量可以是用户的安装、软件包或配置设置的放置。当您到达中断的地方时，您可以很容易地恢复到代码中已知有效的地方。正如 Keith Morris 在[infra structure as Code-Automation Is Not how](http://kief.com/infrastructure-as-code-versus-automation.html)中所述，利用此类实践确实会使基础架构自动化和基础架构 as Code 有所不同。

## 测试厨房、Terraform、AWS 和 awspec

现在，如何到达那里？ [Test Kitchen](http://kitchen.ci/) 是一个易于扩展的测试工具，允许您在各种云提供商、虚拟化提供商和操作系统上测试用 Ansible、Chef、Puppet(和其他)编写的代码，并在各种测试框架中进行测试。

在接下来的演示中，我会给出一些实际操作的例子，让您快速了解如何使用带有 awspec 的 Test Kitchen 作为框架来测试 AWS 上的 Terraform 部署:

[//speakerdeck.com/player/e56622a9a41e4dc8920655bd56e99640](//speakerdeck.com/player/e56622a9a41e4dc8920655bd56e99640)