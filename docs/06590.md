# 性能问题:超越基础设施

> 原文:[https://devo PS . com/performance-issues-looking-beyond-the-infra structure/](https://devops.com/performance-issues-looking-beyond-the-infrastructure/)

***在当今的大多数情况下，解决性能问题需要架构改变或代码重构***

假设您是一名软件可靠性工程师，您的服务水平目标清楚地展示在 Grafana 仪表板上。突然，一个警告出现了:你的第 99 百分位的延迟已经达到极限了！

快速浏览一下相关的指标就可以发现问题的症结所在:流量峰值已经超过了当前的系统吞吐量。这显然是容量不足造成的问题，向集群添加一些额外的实例应该可以解决这个问题，对吗？毕竟，更多的机器意味着更多的产能。当图表稳定下来，警报消失时，你保持冷静。没有理由担心；你很久以前就已经自动化了缩放过程。

但是这个故事可能会导致一个非常不同的，更糟糕的情况。如今，容量很容易获得，尤其是在提供简化扩展流程的云环境中。但是，配置和扩展的便利性也会导致基础架构成本上升。

在许多情况下，由于应用程序瓶颈或资源管理效率低下，处理性能问题或[提高性能](https://devops.com/how-to-minimize-latency-and-its-impact-on-ux/)不一定仅仅通过添加更多机器来实现。套用一个聪明的叔叔的话:更强的计算能力(增加更多的机器)并不会带来更好的性能。不幸的是，在今天的大多数情况下，解决性能问题需要架构改变或代码重构。

## 优化软件

由于增加节点数量对提高性能没有什么帮助，所以让我们来探索一下可以加速的方面。该堆栈由硬件、操作系统(OS)、库和应用程序以及其他组件组成。在硬件层面进行改进并不总是可行的，尤其是在云中运行时。

与其在你的云账单上花费更多，不如考虑检查用户空间代码有多快。应用程序开发人员已经有很多工作要做，所以他们能优化的也就那么多了。虽然有可能投入 R&D 的精力和时间来用一个性能更好的库替换一个性能差的库，或者偶尔进行以性能为中心的重写，以期解决这个问题，但这两种方法都可能行不通。

当摆弄硬件不是一个选项，并且开发人员无法提供帮助时，另一个选项是尝试在操作系统级别解决问题。

## 回忆之旅

计算的历史不仅仅是更小的晶体管和更快的时钟。回到大型机时代，机器一次运行一个程序，这个程序被编码在穿孔卡上，由计算机操作员插入。

后来，商人们开始寻找一种让计算机更高效的方法，因为在程序切换期间，计算机一直处于闲置状态。这导致了操作系统的产生，操作系统是一个执行其他程序并管理它们之间的资源分配的程序。操作系统是为键盘后面运行同步任务的用户设计的；因此，它们被设计成通过优化内部资源管理来实现高交互性和公平性，从而提供这种并行性的假象。

今天，拥有一个通用虚拟 Linux 机器舰队并不罕见，这些机器主要专注于运行一个特定的应用程序，一个微服务。但是底下的 OS 变化不大。它仍然表现得好像应该执行多个程序并在它们之间共享资源，这在这种情况下不一定是最有效的，也不能为应用程序提供最佳性能。

## 优化操作系统

有许多潜在的性能改进可以直接在操作系统级别进行测试和应用。调整 sys 控件会对许多子组件(如网络)的性能产生重大影响。

I/O 调度程序也值得研究。例如，对于数据库，默认的 CFQ(完全公平排队)可能会产生不如截止时间调度程序的结果。另一方面，无操作调度器允许您避免在云环境中两次调度 I/O 操作。毕竟，虚拟机的管理程序通常已经在管理硬件了。

然而，不管你的方法是什么，建议在类似生产的环境中(或者甚至是生产本身，如果你对混沌工程感兴趣的话)进行持续细致的测量。性能调优是一个非常高级的领域，需要专门的系统知识。

## 高级操作系统调整

有些操作系统特性不太容易进行性能调整。例如，Linux 进程调度器利用了完全公平调度器(CFS ),这在大多数情况下是完全合理的。然而，它有时会产生一个明显的[性能差距，用标准的分析工具是不容易发现的](https://blog.acolyer.org/2016/04/26/the-linux-scheduler-a-decade-of-wasted-cores/)。即使您发现了它，您也不能简单地更改其中一个配置文件中的参数；相反，内核补丁和重建是必需的。

假设您对算法非常满意，但是您只是想说明一些线程比其他线程更重要。默认情况下，您不能这样做，因为 niceness 设置只在流程级别有效。

I/O 绑定的应用程序也很复杂。即使使用原始套接字和 epoll，也没有运行时机制来为队列中的套接字提供选择逻辑甚至优先级。内核没有办法知道请求的性能预算。

## 性能优化的其他方法

在理想情况下，您的应用将由专门为每个微服务定制的操作系统组成，并利用一切机会来提高性能并与应用协同工作。在这样一个理想的世界中，操作系统中的内部资源管理机制将根据特定于应用程序的实用程序功能进行定制，以推动性能优化，进而降低基础架构成本。

不幸的是，我们还没有到那一步，而且这种解决方案目前只适用于那些能够雇得起几十个人全职做这件事的公司巨头。用威廉·吉布森的话来说，“未来已经到来——只是分布不均匀。”

那么留给那些预算有限的人的是什么呢？一种新的实时持续优化方法，使组织能够利用人工智能驱动的基础设施优化，这些优化专门适合运行的工作负载。使用应用驱动的调度和优先化算法，可以识别竞争资源、瓶颈和优先化机会，并实时解决它们。