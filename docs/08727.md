# 蓝绿部署成功的 5 个步骤

> 原文:[https://devo PS . com/5-steps-to-success-with-blue-green-deployment/](https://devops.com/5-steps-to-succeed-with-blue-green-deployment/)

通过允许团队同时维护两个生产就绪环境，[蓝绿色部署](https://docs.cloudfoundry.org/devguide/deploy-apps/blue-green.html#:~:text=Blue%2Dgreen%20deployment%20is%20a,live%20and%20Green%20is%20idle.)技术可以显著提高可靠性。但是蓝绿色部署也很难执行和管理。让我们来解开蓝绿部署如何工作，为什么它很重要，以及蓝绿部署成功要遵循哪些最佳实践。

## 蓝绿色部署，已定义

蓝绿色部署是一种软件部署技术，在这种技术中，团队维护两个相同但不同的环境，这两个环境能够托管生产应用程序。一个环境是“活的”,并积极地为用户服务，而另一个环境处于备用状态。

当需要部署应用程序的新版本时，可以将其部署到保留环境中。然后测试并验证它，以确保它满足性能和可靠性要求。

如果是这样，您需要重新配置您的 DNS 或负载平衡器，以便将用户流量定向到这个环境，它将成为新的生产环境。同时，保留以前的生产环境。

## 蓝绿部署的优势

蓝绿色部署技术可以从几个方面提高可靠性:

*   **环境对等**:因为测试应用程序的保留环境变成了实际生产环境，蓝绿色部署确保了测试和生产之间的对等。反过来，它降低了配置差异可能导致生产中不可预见的问题的风险。
*   **失败的部署**:如果部署失败，不会影响您的用户，因为您部署到了保留环境中。您可以修复该问题，同时您的应用程序的面向用户的稳定版本继续在其他环境中运行。T3】
*   **冗余环境**:尽管蓝绿色部署不是一种数据保护或灾难恢复技术，但如果您的一个环境因数据中心故障等事件而被破坏，那么拥有两个可用的生产就绪环境是非常有用的。在这种情况下，您可以通过使用另一个环境快速恢复操作(当然，前提是它托管在一个单独的数据中心)。

## 如何使用蓝绿色部署:步骤和最佳实践

虽然蓝绿色部署是提高可靠性的好方法，但它确实带来了一些挑战。以下最佳实践可以帮助您处理这些问题。

### 使用可扩展的基础设施

蓝绿色部署的一个明显的潜在缺点是，由于您必须维护两个相同的环境，因此它实际上会使您托管应用程序所需的资源量翻倍。这可以让你的托管费翻倍。

降低蓝绿部署的成本影响的一种方法是创建可以快速扩展的环境，而无需更改其核心配置。您可以使用基于云的虚拟机(VM)和自动伸缩，或者通过容器和可以伸缩它们的编排引擎(如 Kubernetes)来实现这一点。

使用这种方法，您可以设置两个实际上完全相同的环境，只是生产环境包含的虚拟机或容器实例多于保留环境。虽然您可能会认为这不是一个蓝绿色的部署，因为环境并不完全相同，但语义上的负面影响比不在您不需要的基础架构上浪费大量资金的好处更重要。

### 混沌工程

通常，混沌工程需要对生产系统进行实验，以测试其可靠性。混沌工程提供了许多好处，但它也带来了明显的风险，即在生产中产生影响最终用户的问题。

蓝绿部署允许您通过在保留环境中练习[混沌工程](https://devops.com/?s=chaos+engineering)来规避这种风险。当然，因为您没有真正的用户，在这些设置下执行混沌工程可能不允许您测试生产应用程序的每个方面。但是您仍然可以通过在 reserve 环境中自己发出请求来测试许多配置变量——完全不用担心给实际用户带来麻烦。

### 管理数据库状态

在环境之间切换时保持数据库同步是蓝绿色部署的最大挑战之一。数据库状态中即使很小的差异也会导致很大的可靠性问题。

解决这个问题的最简单方法是在切换之前关闭数据库，并执行测试以确保两个环境中的数据库在重新启用之前是相同的。当然，这种方法可能会影响应用程序的功能，因为如果关闭数据库，应用程序可能无法正常工作。

另一个解决方案是在两个环境之间同步数据库。这个*应该*确保数据库状态保持一致，即使您从一个生产环境切换到另一个。但这也意味着数据库的问题会影响这两种环境。

底线是:在蓝绿色部署中，没有简单的方法来管理数据库状态。您应该评估可用的不同选项，并考虑哪一个最符合您的需求。如果您可以忍受一点停机时间，请在切换期间停止并重新启动数据库。如果你需要完全的连续性，使用同步，但一定要管理好相关的风险。

### 更改负载平衡器，而不是 DNS

有两种主要的方法来管理流量被定向到哪里，以及哪个是生产环境:当您想要切换时，您可以更改您的 DNS 配置。这很容易做到——您只需将 yourapp.com 的映射从一个 IP 地址更改为另一个，具体取决于哪个环境是活动环境。

您还可以使用负载平衡器来管理流量。负载平衡器配置比简单地更改 DNS 条目更复杂，但它也支持更复杂和更精细的控制。

一般来说，通过负载平衡器管理蓝绿色部署交换机是最佳实践，因为它们提供了额外的控制。

### 为意外做准备

虽然蓝绿部署可以降低影响用户的中断风险，但这不是灵丹妙药。您还必须确保拥有检测和修复两种环境中的问题所需的可靠性管理工具。

蓝绿部署是一种强大的可靠性工程技术。但是，为了充分利用它，您必须优化处理需求的方式，如基础设施管理、流量路由和数据库状态。