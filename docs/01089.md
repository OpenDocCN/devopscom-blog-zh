# 要持续播客:分期服务器必须死亡

> 原文:[https://devo PS . com/continuous-podcast-staging-servers-must-die/](https://devops.com/continuous-podcast-staging-servers-must-die/)

欢迎来到 [To Be Continuous](http://blog.heavybit.com/blog/to-be-continuous-14) ，这是一个关于持续交付和软件开发的节目，由 Paul Biggar、[circle ci](https://circleci.com/)的创始人和[launch darky](https://launchdarkly.com/)的 CEO Edith har baugh 主持。在这一集里，[伊迪丝](https://twitter.com/edith_h)和[保罗](https://twitter.com/paulbiggar)讨论了伊迪丝的博客[帖子，她在帖子里断言，你应该关闭你的临时服务器，这样持续交付才能继续。](http://readwrite.com/2016/01/22/staging-servers)

[本期播客](http://blog.heavybit.com/blog/to-be-continuous-14)由 [Heavybit](http://heavybit.com/) 为您带来，这是一个帮助专注于开发者的公司将其产品推向市场的项目。

[soundcloud url=”https://api.soundcloud.com/tracks/248544923?secret_token=s-fUn5T” params=”auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&visual=false” width=”100%” height=”166″ iframe=”true” /]

保罗:所以今天我们要谈谈伊迪丝写的[帖子](http://readwrite.com/2016/01/22/staging-servers)。这个帖子是关于[死亡的临时服务器](http://readwrite.com/2016/01/22/staging-servers)。你能给我们介绍一下这个帖子是什么吗，因为我想我们会谈论很多。

**伊迪丝:**肯定保罗，乐意之至。对了，你自己看了吗？

保罗:我承认，我可能略读了一下，比读的多一点。

伊迪丝:是的，所以我来给你总结一下。然后我们再谈。然后你应该去读它，然后我们再讨论它。

所以这篇文章是我在我的公司[launch ly](https://launchdarkly.com/)看到的结果的延伸。我在上面看到的一个评论是，我喜欢这个评论，因为他们用第三人称谈论我。他们说，“哈博有偏见。”

保罗:对，我会这么说。

伊迪丝:但是顺便说一句，她说得有道理。所以我先声明，是的，我很有偏见。我的公司做了一个管理功能标志的平台。所以我的偏见是，我已经看到了我们的客户在做什么。

这就是我写这篇文章的原因，因为这是我看到我们的客户使用功能标记的方式的一种全国性扩展。

**Paul:** 那么，你的客户使用你的产品是错误的吗，还是你所说的正在发生的事情？

Edith: 因此，最基本的特征标记非常简单。这只是一个如果-那么语句。你不需要 LaunchDarkly 或任何类型的系统来管理它，你只需要在你的代码中放一个条件。之后发生的是你变得更加老练。你想有某种仪表板，你可以看到不同的功能标志是可见的，并超越他们。不仅仅是业务方面，甚至是各个开发人员之间。

你想有一个中心的地方，你可以管理。这是我们的第一个版本，你可以管理特性标志。

> 在我们的路线图中，客户要求的下一件事是支持环境。他们希望能够在一个地方显示开发、QA、生产准备的功能标志，并具有可见性。

保罗:你这么说我有点糊涂了，因为环境肯定只是一面旗帜吧？

伊迪丝:是的，继续。

**Paul:** 似乎你可以说，有另一个标志是一个字符串，就像 staging 或 production 或 Dev 或其他什么。你标记的特征。

伊迪丝:这基本上就是 LaunchDarkly 正在做的事情，所以对我们来说，我们只是有了另一面旗帜。

所以每个环境都有一个 API 密匙。

保罗:原谅我在这方面的无知，为什么不使用现有的旗帜呢？

意味着环境必须是一个独立的顶级或一级功能的现有功能标志基础结构中缺少了什么？

伊迪丝:所以现在我们开始有点 meta 了。人们喜欢使用 LaunchDarkly 的原因是因为他们可以获得所有功能标志的统一视图。

这样，他们不仅可以让这些文件在每台机器的 fig 文件中浮动，还可以汇总不同环境中打开和关闭的标志。除此之外，还有在不同环境中管理标志的能力。

**Paul:** 明白了，所以他们想要一个只适用于他们环境的视图？

伊迪丝:好吧，看看每个环境中什么是打开的，什么是关闭的。所以基本上他们遵循一个软件生命周期，你让开发人员在开发箱上工作，推动 QA，推动 staging，然后推动 productions。

当特性从一个转移到另一个时，是有人在推广这些特性，还是有 API 调用在推广这些特性？

伊迪丝:目前主要是人类。我可以预见它只是一个 API。除此之外，人们的下一个要求是，一旦有更多的人加入 LaunchDarkly，我们将使用更多的功能标志，他们希望能够在不同的环境中锁定不同的标志。

保罗:一级防范禁闭就像人们不能换旗子一样？

Edith: 所以他们希望 QA 拥有权利，QA 改变一些标志，但不是在生产中。

保罗:我明白了，好的。

Edith: 然后，接下来的自然步骤就可以了，如果你在系统中有一个可以控制任何步骤的功能标志，那么谁会看到权限呢？

谁能看到什么？为什么你真的有一个单独的 QA 阶段和生产箱？为什么不干脆把这些都折叠起来，用一个特性标志本身来管理可见性呢？

保罗:当然可以。这很有道理。

> 所有的特性标志都提供了原语，您可以在其上构建他们想要的东西。

伊迪丝:我在文章中提出的观点是

> 人们使用 QA 和阶段环境的减法来试图封装一个变更。这是最初的意图，在当时是非常好的，因为替代方案只是将所有东西都推向生产，让所有东西都坏掉。

但是如果你真的在做—

**Paul:** 如果你的功能标志做得很好，那么拥有一个临时服务器的概念就没什么意义了。

因为您不是将一个特性推送到临时服务器，而是将一个特性推送到生产环境中，然后缓慢地将它推广给人们，实际上在临时服务器中拥有它并没有多大意义。这是重点吗？

伊迪丝:是的，这就是这篇文章的标题，[杀死登台服务器](http://readwrite.com/2016/01/22/staging-servers)。

保罗:这可能是停下来阅读[文章](http://readwrite.com/2016/01/22/staging-servers)的好时机。

伊迪丝:好的，我会很感激的。谢谢你，保罗。

**Paul:** 我们将会有一个看似 10 秒钟的休息时间，但实际上是 5 分钟的休息时间，我在读这篇文章。我建议你现在按下暂停键，自己阅读这篇文章。

伊迪丝:欢迎回来，保罗一直在疯狂地写白板。我现在很想听听他的想法。

保罗:是的，这是一篇好文章，我非常喜欢。首先想到的是名字的概念。

因此，拥有多种环境的想法尤其奇怪。想象一下，你有…服务租赁架构，有 6 台机器或类似的东西，或者有 20 台机器或类似的东西。你不能创造一个新的实例，这个想法有点奇怪。

伊迪丝:是的。

**Paul:** 所以人们在历史上所做的事情，这可以追溯到事物在机器上运行的时候，或者特定的端口，或者无论什么，是所有事物都有一个名字。它有 DNS 名称或有一个临时名称。

如果您查看 rails、配置文件，会发现有一个生产名称、一个阶段名称、一个开发名称，所有这些都有不同的环境变量。但是有名字其实没什么意义。因为一个名字意味着其中有一个。

伊迪丝:好吧，这又回来了，你是不是要放弃整个宠物对抗牲畜的事情？

保罗:是的，我要参加宠物和牛的比赛。如果你正在给你的宠物命名，那么你不能突然得到六只，你不能突然杀死它们。但你真正想要的是牛。

所以一个临时服务器不是，我的意思是一个临时服务器是一个宠物。这是一个非常非常重要的宠物，每个人都喜欢，每个人都和它玩，因此它有点困惑。这个类比是这样的—

伊迪丝:我不确定你是否同意我的观点，所以。我们会继续，如果你不同意，那很好，但如果你同意，我也会很高兴。

保罗:如果这个类比成立，那么你的意思是我们杀死了珍爱的家庭宠物。

伊迪丝:嗯，你知道，有时候……啊，我甚至不能去那里。

保罗:这个类比是站不住脚的，但是我们可以说，如果这只宠物在农场呆上一段时间是最好的。

伊迪丝去散步了。

保罗:对。所以很明显，生产是一个需要名字的实际事物，它是一个独特的环境。但是没有什么是真正独特的环境。

伊迪丝:是的，快进一下，我想我收到了很多关于这篇文章的反馈，我很喜欢。这也是我写这篇文章的原因，作为反馈。我认为在某些情况下，你确实不想直接从开发者进入生产。

我认为有很多情况下，你希望有其他地方来测试它们。

保罗:我同意这一点，是的。

伊迪丝:我认为很多情况下，我们从这一步到这一步，再到这一步，强行进入生产阶段，实际上是非常有害的，如果你只是更快地推掉，或许跳过其中一些步骤，你就会直接得到你想要的反馈。

**Paul:** 我们在 CircleCI 所做的，最初我们有一个准备环境。如果我们想测试一些不容易编写单元测试的东西，或者类似的东西，我们偶尔会使用 staging 环境。通常对我们来说，这是关于 LXC 的事情，或者关于启动亚马逊盒子的事情。

你不经常做的事情，或者有一个费用，或者有一个奇怪的架构，你不能只在软件中做，在软件中实践。所以我认为有这个必要。偶尔你会遇到测试不够好的情况，所以你需要把它放在某个地方，让人们尽他们所知来验证它是否真的能工作。

您可以将它放入您的中，我本来想说您可以在上运行它，但在这种情况下，暂存服务器的要点是，它不太容易放入虚拟机或其他设备中。您看到的另一种使用情形是，您不希望在实时生产数据库上运行内容，并且您不能很快获得副本。所以你会看到像 Haroku 这样的人试图制造避免这种需求的产品。

所以有了 Haroku …你可以复制一个数据库，你可以有一个数据库的视图或只读视图，这是以某种方式在右边的副本。因此，您不需要单独的暂存环境、单独的拷贝或单独的暂存数据库或其他任何东西。

> 但是，如果一切都经过了良好的测试，如果一切都在软件中工作，那么就真的不需要登台环境。对我来说，暂存环境在某个地方有点像黄旗。它不应该真的存在，但有时你可能需要它。

Edith: 实际上我现在想写一篇后续文章，关于临时服务器已死，临时服务器万岁。因为我确实认为，在一些使用案例中，您不希望推进到 prod。然而我确实认为人们——

**Paul:** 有哪些情况是你不想催促的？

**Edith:** 我从我们的顾问 [Sean Burns](https://twitter.com/SeanMBurns?ref_src=twsrc%5Egoogle%7Ctwcamp%5Eserp%7Ctwgr%5Eauthor) 那里了解到，如果你正在测试一个真正深刻的基础设施变化，例如切换一些批处理。

保罗:嗯，不，我一点也不相信。

伊迪丝:好的。

保罗:因此，如果你正在测试一项真正深刻的基础设施变革，有两种方法可以做到。基础设施的深刻变化。其中一个是说，“我们要把这些机器放在这里，我们要把这些机器放在这里。”这就是季度发布周期。我们在冒很大的风险，所有人都在甲板上，不管怎样。

> 你想发布这类东西的方式是你想把它放在代码库中。你需要一个 if 语句，一个特征标志，来控制有多少数据是单向的，你复制数据，或者让 1%的数据通过。

伊迪丝:我认为关键是复制或有一些故障保险。我的意思是，这样做的最大风险是数据丢失，这很糟糕。如果你对如何做这件事漫不经心—

保罗:嗯，我不认为数据丢失是最糟糕的事情，最糟糕的事情是你整个该死的服务瘫痪。

伊迪丝:嗯，最糟糕的事情是你的整个服务中断了，你丢失了某人的一箱数据。

我认为人们实际上更能容忍五分钟的失误，而不是你失去他们的很多分析。所以他的观点是，我们不能丢失人们的数据。

**Paul:** 因此，在我看来，创建一个全新的基础设施是很可笑的，你需要在一夜之间或立即进行一些改变，或者等待停机时间的改变。如果数据都是实时的，你负担不起，我们将切换，看看它是否工作。不管它测试得多好，就像它是可笑的。

伊迪丝:是的，所以，现在我要回到我的文章上来。我是说，这就是我想说的。

> 人们认为他们通过进行所有这些测试来降低风险。

保罗:是的，事实上他们增加了风险。

伊迪丝:是的，你会认为你是—

保罗:嗯，持续交付的要点是，通过一件事和另一件事之间的严格交叉，你增加了风险，即使你认为你在降低风险。

Edith: 是的，Ket Beck 写了一篇非常好的文章，关于可逆性。所以他现在在脸书，但是他说在脸书的一切都是可逆的。

保罗:有意思。

伊迪丝:这实际上让你的风险小了很多，因为你会说，好吧，我们做这些有风险的改变—

保罗:但是它们是可逆的，所以是对的。

伊迪丝:是啊，对越割接。正如我在文章瀑布部署中所说的。

保罗:我的意思是，我认为这是一个很好的思考方式。它与一个众所周知的坏名字联系在一起。

伊迪丝:这是故意的—

保罗:嗯，不错的选择。因此，敏捷部署是无缝实现的部署，您可以来回更改需求和其他任何内容。

Edith: 这是 Sean 的第一个例子，如果这是一个非常冒险的改变呢？他有一些自己职业生涯中的好例子。

保罗:他有什么我会认同的例子吗？

伊迪丝:事先没有听到他们，我不知道你会同意还是不同意。人们提到的另一件事是，这对人们来说似乎非常危险。这似乎增加了风险，因为我认为他们习惯于将暂存服务器视为安全港。

**Paul:** 我认为使用临时服务器有一些语义问题。您通常希望拥有一个完整的环境副本，以便进行测试。那是一个中转服务器，还是你在那里输入 docker，你知道新的环境。

然后，您在这个全新的基础设施上运行您的测试，这个基础设施以前从未被任何东西接触过？

伊迪丝:是的，我在文章中提出的批评是，我认为人们经常这样做。而且他们在那里花了很多精力测试，但这些都是人造的测试件。

感谢您收听由 Heavybit 为您带来的这一集《未完待续》。

你可以在这里找到本期播客的完整片段。想了解更多关于连续播放的内容和收听其他重量级播客，[将此链接](https://feeds.soundcloud.com/users/soundcloud:users:123515298/sounds.rss)复制到你最喜欢的播客播放器中。我们将很快推出针对特定节目的 RSS 和 iTunes 订阅选项。你也可以在推特上关注 [@continuouscast](https://twitter.com/continuouscast) 的连续报道。

感谢您收听由 Heavybit 为您带来的这一集《未完待续》。

你可以在这里找到本期播客的完整片段。想了解更多关于连续播放的内容和收听其他重量级播客，[将此链接](https://feeds.soundcloud.com/users/soundcloud:users:123515298/sounds.rss)复制到你最喜欢的播客播放器中。我们将很快推出针对特定节目的 RSS 和 iTunes 订阅选项。你也可以在推特上关注 [@continuouscast](https://twitter.com/continuouscast) 的连续报道。