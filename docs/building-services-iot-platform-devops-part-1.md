# 使用 DevOps 构建服务和物联网平台，第 1 部分

> 原文：<https://devops.com/building-services-iot-platform-devops-part-1/>

随着物联网(IoT)的发展，预计未来三年将连接超过 500 亿个设备(物)，在一个更加互联的世界中构建智能系统面临着许多挑战。特别是在为物联网构建软件方面，除了硬件和网络连接挑战之外，在开发、测试、发布、管理基础设施、监控基础设施和设备(事物)以及安全性方面也存在许多挑战。

本文重点讨论物联网平台中的关键组件，以及如何选择合适的 DevOps 工具集来构建这些组件，并为物联网平台创建 DevOps 管道。

## 使用 DevOps 构建您自己的服务和物联网平台

物联网解决方案的主要组件包括设备注册和身份、数据接收、命令和控制、热数据分析和冷数据分析的规则和操作、数据存储、警报和报告。

**设备注册和身份:**设备/edge 需要相互连接，并连接到云网关以发送/接收数据，为此，设备必须在网关处进行唯一标识和注册，以便只有经过认证和授权的设备/用户才能与云通信。每个物联网平台供应商都有自己的设备注册方式和用于存储设备元数据的身份方法，如 AWS Things Shadow 和 AWS Gateway Rules Engine，Device twin 和 Azure IOT hub in Azure，GE Predix 等。

**数据接收:**设备与云/现场网关通信，网关进一步将数据(设备信息和遥测信息，如来自传感器的温度数据)接收到云中。可以使用 Azure/AWS/GE predix 等的 PAAS 服务的多个选项。对于这个组件。

**命令和控制:**这些组件使设备采取某个动作，并从云端向某个设备发送消息，云端可以用 PaaS 服务构建，如 AWS Kinesis、Lambda 函数、Azure 函数、Azure Logic Apps 等。或者开源技术。

**规则和操作:**这些组件使用为处理热数据(需要在指定的时间间隔内查询和分析数据)和冷数据(可以存储数据以供延迟查询和进一步分析)而定义的规则，对特定的设备到云数据进行操作。这些组件也可以使用现有的 PaaS 服务或使用开源工具来构建，如 Apache Storm、Map Reduce、Hive、Data Lake 等。用于数据流和分析。

**数据存储**:您需要存储多种类型的数据，包括设备元数据、指定设备集的遥测数据、热数据和冷原始数据，这些数据需要根据需求进行存储和扩展。

**警报/通知:**需要将分析的数据可视化，以获得更有用的业务指标和结果，这些指标和结果可以集成到外部系统或其他业务应用程序中，以采取预防和预测措施。定制的控制面板和数据监控工具需要集成到解决方案中，以实现监控、警报和通知。

随着物联网开发复杂性的增加，需要监控大量设备和分析大量数据，以及管理复杂的基础设施，DevOps 对于物联网开发生命周期至关重要。

## **为物联网平台选择合适的 DevOps 工具**

为物联网平台选择正确的 DevOps 工具有助于克服在创建/向大规模设备推送应用和固件更新以及按需监控和基础设施配置方面的挑战。

随着 PaaS 服务用于物联网开发，开发关键物联网组件所需的代码更少，但配置和基于规则的开发更多。

此外，开发设备软件和应用程序开发的团队可能是分布式的，但发布需要具有完整的可追溯性和可审计性。您需要管理可扩展的基础设施来支持物联网平台。

下面给出了在大多数物联网开发中使用的一些 DevOps 工具，以帮助 DevOps 团队无缝地开发、构建和发布物联网平台。

*   **版本控制:** Git，用于分布式团队和维护设备开发、应用开发和基础设施自动化开发的存储库。其他的工具是 SVN 或 TFVC 的清晰案例。
*   **持续集成**:詹金斯、VSTS (Visual Studio Team Services)和 Bamboo 为应用程序、设备软件和基础架构脚本创建构建、单元测试和代码质量分析工作，支持大量工具插件，并使用不同的构建工具，如 gradle、maven、msbuild 等。，并支持多种技术堆栈。
*   **基础设施供应和自动化** : Ansible、ARM (Azure Resource Manager)和 AWS 云形成模板，用于自动化多个云供应商中的基础设施，并使用 Terraform 或 Spinnaker 等工具来自动化跨混合云的基础设施供应，并维护通用的基础设施蓝图，从而实现跨云的基础设施工作负载的移植/迁移。
*   **基础设施测试**:当 PaaS 服务用于开发物联网平台中的某些组件时，测试这些 PaaS 组件有点不同——从开发/测试团队的角度来看，PaaS 服务的代码更少，但配置和端点更多。测试这些组件将涉及端点测试、规则是否正确创建、数据如何在不同组件之间流动以及可靠的基础设施验证。这些基础设施测试脚本可以使用 Python/groovy 或 vagger 来编写，以模拟环境和测试，或者使用测试框架，如 PowerShell 脚本的 Pester。您可以扩展您的测试解决方案，以利用由不同的 PaaS 服务公开的 REST API/CLI 命令，这些测试脚本也可以使用模拟的测试数据测试 PaaS 服务，并生成测试结果报告。
*   **持续部署:** VSTS 发布经理，Jenkins，Capistrano，CA Nolio 等。可用于创建部署工作流，以部署设备固件更新、可在多种环境下单独发布的应用程序更新、门控检查和简化的部署流程，并支持反馈。
*   **测试自动化:**测试自动化使用 Selenium，Jmeter，Veracode，EMMA，CA Lisa，Inspec 等安全测试工具，机器人框架，性能测试工具。IiT 中的测试很复杂，因为它需要对多个互连的设备进行端到端测试。除了您自己的设备开发之外，大多数其他设备开发可能都不在您的控制之下，因此要测试端到端功能，您需要有健壮的测试用例以及模拟的测试设备和测试环境。这就是容器可以帮助测试自动化的地方——作为 Docker 容器的模拟设备可以在一个测试环境中运行，当其他相关组件/设备正在开发或不可用时，测试人员可以使用服务虚拟化工具，如 IBM Rational Test virtual ization Server、CA Service Virtualization、Parasoft virtual ization 或 HP Service Virtualization 来测试他们的端到端功能。
*   **安全性和代码质量分析以及安全性测试**是物联网开发的关键。随着越来越多的设备互联，数据泄露/数据隐私的风险很高；因此，在开发阶段作为 CI 管道的一部分，安全性测试的左移是不可避免的。Veracode、EMMA 和 Inspec 等工具可用于运行安全分析，并识别安全漏洞和合规性问题。可以基于技术栈使用 junit、xunit、nunit 或 mstest 等单元测试工具。SonarQube、coverity、cobertura、Fxcop 等代码质量分析工具广泛应用于物联网应用组件开发中的代码质量分析。
*   **容器化和容器编排:**您可以将您的应用程序部署为 Docker 容器，这种容器在物理/托管基础架构中占用的空间更少，并且只与所需的应用程序框架、库和依赖项一起运行。这些容器/容器集群由容器编排工具管理，如 Kubernetes、Docker Swarm、AWS 容器服务、Azure 容器服务等。如上所述，模拟测试设备可以在 docker 容器中运行，这使得可以跨任何云运输/移动容器，并在几分钟内准备好测试环境。
*   **监控:**物联网中的监控包括对设备的监控；基础设施虚拟机/集群；遥测数据；构建、测试和发布；和计费等。可以在包括 AWS Cloudwatch、Azure Application Insights&log Analytics、Stream Analytics、New Relic、Prometheus(开源)、Nagios、Coscale、SysDig、Dynatrace 和 GE Predix Monitoring 在内的监控工具中配置和查看集群使用情况、CPU 使用情况、网络可用性、响应时间、连接的设备数量以及更新/未更新的设备等指标。可以根据不同云或内部的目标平台、技术堆栈和其他因素来选择工具。
*   **云和云管理:**包括 AWS、GE Predix、Azure 和 GCP 在内的云提供商通过入门套件、物联网设备 SDK、协议、网关定制等为物联网平台提供开箱即用的功能和支持。云管理工具，如 Right Scale 云管理平台、OneOps 等。，可用于管理基础设施工作负载；引入中央治理、访问控制和安全性；监控计费和优化；管理安全性和标准；以及物联网平台开发的简化和编排。

根据技术堆栈、DevOps 要求和业务需求，需要选择正确的工具来简化物联网平台开发，并在参与物联网开发的不同团队之间提供反馈，并在安全性、治理和工具方面引入标准化，以衡量和更好地管理物联网平台。

**发布、推广固件/应用程序更新**

与应用发布相比，物联网平台固件更新的推出更具挑战性；对于设备更新，我们必须处理网络延迟、设备连接问题、安全问题、不同的设备集、不同的部署通道、无线部署以及不同制造商使用的不同协议集。

当有新的附加设备或支持传统设备时，会涉及额外的复杂性，这需要将集成的端到端测试作为部署管道的一部分，以从以用户为中心的方法测试设备和应用。

在物联网开发中，固件更新、服务器端代码、移动应用和向多个端点交付的多种设备有多种开发和部署渠道。因此，物联网组件的发布节奏各不相同，因为应用程序代码更新可以每月发布一次，而设备固件更新可以每三到六个月进行一次，因此，必须遵循明确定义的流程来定期集成代码。

持续测试涉及基础设施测试、性能测试、最终用户测试和功能测试，所有这些都必须与发布管道集成，其中部署可以发生在模拟的测试环境中，作为代码环境(具有运行应用程序所需的所有运行时依赖项的环境，如 Docker 容器)，而不仅仅是作为代码的基础设施。

开发运维团队需要跟踪版本并监控所有这些部署，确保环境稳定，通过设备固件更新追溯版本并跟踪缺陷。DevOps 团队应该从多个管道中提取不同组件的发布包，并准备主构建和定制构建，以便将组件集成和部署在一起。

以下是物联网平台开发 CI/CD 管道的主要步骤。

1.  将代码签入版本控制:将应用程序开发、设备/固件开发、PaaS 服务配置、基础自动化脚本和模板的代码签入版本控制，指向定义的存储库。
2.  持续集成:在诸如詹金斯/VSTS/竹这样的 CI 服务器中创建的构建作业执行构建编译、单元测试、代码质量分析、自动化审查、环境配置准备、运行安全测试分析、创建部署包或内置容器映像，以便进行部署。
3.  触发部署:构建代理生成固件更新和应用程序更新的包，并通知发布代理触发部署。
4.  部署工作流可以调用服务/工作者作业，该作业又可以连接到云网关服务，以通知固件更新。
5.  云网关获取固件更新并向设备通知设备更新。这些设备将获取更新，安装更新，并进一步发送遥测数据。
6.  云中的多个测试环境可以集成到发布管道中，以模拟固件更新。
7.  在应用程序推出的情况下，在功能测试/回归测试之后，将有 canary 版本逐步推出到不同地区的不同环境中。
8.  测试:安全测试、针对特定设备的固件更新、更新期间设备的性能、设备身份和内存使用等。，需要在物联网部署期间解决。一旦应用程序被部署到测试环境中，就会进行功能/回归测试并生成测试报告。
9.  监控指标，如内存使用、设备性能、网络流量、延迟、连接的设备、可靠性等。，因为这些对于决定如何在不影响设备性能的情况下实施远程更新和监控至关重要，并且这些指标必须作为发布管道执行的一部分通知开发/QA/DevOps 团队。
10.  按需环境配置脚本/模板必须与部署管道集成，以配置测试环境，根据扩展指标添加更多设备。

在开发之初提前建立 CI CD 管道，并遵循成熟的 DevOps 实践，如安全测试、基础设施测试、容器化、监控、云和 DevOps 治理以及反馈驱动的开发，是帮助解决构建自己的服务和物联网解决方案的挑战的关键。

## 关于作者/ Lavanya Subbarayalu

Lavanya Subbarayalu 是 HCL Technologies 技术办公室的高级建筑师。她在 IOT、Azure、devo PS consulting&Microsoft technologies 等领域拥有专业知识。她在 DevOps COE 工作，从事 DevOps 解决方案和咨询工具的设计和开发。在 [LinkedIn](https://www.linkedin.com/in/lavanya-subbarayalu-85b05677/) 上与她联系。