# 安全的 Kubernetes 架构:成功的六大要素

> 原文:[https://devo PS . com/secure-kubernetes-architecture-six-factors-essential-to-success/](https://devops.com/secure-kubernetes-architecture-six-factors-essential-to-success/)

Kubernetes 已经成为企业的首选容器编排工具。

看看这些数据【来源:[企业家的项目](https://enterprisersproject.com/article/2020/6/kubernetes-statistics-2020):

*   84%的公司在生产中使用容器。
*   其中，78%使用 Kubernetes 来管理他们的容器。
*   69%的公司发现了由于 Kubernetes 环境配置不当而导致的安全漏洞。

您的 Kubernetes 架构就像一个大房子，里面住着集装箱“租户”。你需要小心建造它，确保它是一个安全快乐的居住地。

在规划(或审核)您的 Kubernetes 架构时，这里有六个重要因素。

## 奠定基础:底层平台和控制平面配置

房子的地基是关键的第一步。地基不牢，久而久之就会出现裂缝。

同样，安装 Kubernetes 的地方也是你的首选。有几种选择，各有利弊。

Kubernetes 是一个云原生工具。因此，将其安装在云上是有意义的。有两种云部署选项:基础设施即服务(IAAS)或平台即服务(PAAS)。

IAAS 安装包括在云中创建一系列虚拟机(例如，使用 Amazon EC2)并在这些机器上安装 Kubernetes。您将负责 Kubernetes 安装的更新和配置。

另一方面，所有主要的云提供商都提供托管 Kubernetes 服务。这种部署模型允许您使用 Kubernetes，而不必处理基础设施。

尽管 Kubernetes 是为云设计的，但您不必将它安装在云中。本地安装是一种选择，许多公司选择使用他们的虚拟化基础设施来托管 Kubernetes。

你可以在下面找到每个选择的利与弊的快速总结。
‍

![](../Images/b54a0207743fb44177241d87c40371d5.png)

你的决定取决于三个因素:

*   您团队的技能组合
*   您对控制和灵活性的需求
*   贵公司的目标

## 控制平面配置

Kubernetes 控制平面由运行在主节点上的服务组成。集群存储、调度程序、控制器管理器和 API 服务器共同创建控制平面。

好好规划你的控制平面安全。如果攻击者获得了对您的控制平面的访问权，他们将能够控制您的整个 Kubernetes 集群。使用 SSH 或 VPN / VPC 连接并使用控制面板。

如果您使用的是云提供商的托管服务，请保护您的 API 密钥和凭据。不要将它们存储在源代码控制系统中。丢失 API 密钥会导致完全接管您的云基础设施，而不仅仅是您的 Kubernetes 安装。

## 寻找好的租户:集装箱安全和组成分析

错误的房客会毁掉你的房子。同样，危险的集装箱会降低你的 Kubernetes 环境。

确保你从外面带进来的任何容器都经过审查并正确配置。只使用可信的注册中心，如 Docker Hub 或 Quay.io。

最后，在使用之前扫描你的容器。您可以使用开源容器扫描器来查找漏洞和恶意软件。您可以将大多数扫描仪集成到您的 CI/CD 管道中。

## 明智地规划您的房间:Kubernetes 集群分区

你家的每个房间都有不同的名字和用途。你不会在卧室里放炉子，也不会在厨房里放床。你给房客提供私人房间，同时允许他们共享公共区域，比如厨房。

在 Kubernetes 中，名称空间允许您在逻辑上将同一个集群中的各种应用程序分开。如果集群是您的房子，那么每个名称空间就是其中一个单独的房间。

为集群中的每个应用程序命名空间。这种做法有三个好处:

*   从逻辑上分离应用程序和环境(开发、试运行、生产)
*   支持强大的基于角色的访问控制(RBAC)
*   允许网络分区，以提高群集内的安全性

## 库伯内特 RBAC 初级读本

你可以查看 Kubernetes 文档，了解 Kubernetes 对 RBAC 的全面解释。但是对于那些现在没有时间阅读的人来说，这里有一个快速入门。

Kubernetes 有角色和集群角色。它们包含代表一组权限的规则。没有“拒绝”规则，所以你必须知道什么访问是必要的。

每个角色都有特定的命名空间。另一方面，ClusterRoles 没有名称空间。在 Kubernetes 中，一个对象只能有命名空间或没有命名空间；不可能两者兼得。因此，有必要拥有两个资源，每个场景一个。

使用角色创建与特定应用程序相关的权限。使用 ClusterRoles 访问群集范围的资源或多个命名空间使用的资源。

RoleBinding 和 ClusterRoleBinding 是向特定用户分配权限的行为。RoleBinding 授予单个命名空间内的权限，而 ClusterRoleBinding 授予群集范围内的访问权限。

例如，将“pod-reader”角色分配给“default”命名空间中的用户“jane ”,允许“jane”读取“default”命名空间中的 pod。

角色定义了一组权限。然后，用户、组或服务帐户(统称为“主体”)被分配角色，以授予对群集中特定资源的访问权限。

在将任何应用程序部署到集群之前，定义适合业务需求的网络分区和访问控制。

## 注意你的线路:舱间通讯

劣质电线不仅仅是不方便。它会导致破坏性的火灾，甚至摧毁整个房子。

类似地，糟糕的 pod 间通信会使您的 Kubernetes 集群停止工作。

Kubernetes 环境是一个小型网络生态系统。与您在任何公司网络中发现的一样，相同的网络拓扑、协议和策略控制着点对点通信。

对 Kubernetes 网络的全面讨论超出了本文的范围。你可以使用 Kubernetes 网络文档来了解它。但是这里有一些快速提示。

您可以使用[服务拓扑](https://kubernetes.io/docs/concepts/services-networking/service-topology/)来定义流量如何流入和流出特定服务。例如，服务可以指定应该将流量路由到与客户端相同的节点上的端点。

服务拓扑在公共云中很有用。您可以使用它将服务的流量保持在特定的可用性区域，以减少延迟。

另一个有用的网络工具是[网络策略](https://kubernetes.io/docs/concepts/services-networking/network-policies/)。这些应用程序级别的构造指定了允许 pod 如何与其他实体进行通信。当您想要使用 IP 地址或端口控制网络流量时，此功能特别有用。

最后，您需要一个健壮的身份验证和授权策略。我们建议使用[服务网格](https://enterprisersproject.com/article/2019/6/service-mesh-plain-english)来简化负载平衡、服务发现、加密和认证。例如，服务网格包括对 OAuth 的支持，这使得服务授权更容易管理。

## 保护前门:入口架构

建造一个安全的家，然后不锁前门是没有意义的。您也不希望对您的 Kubernetes 集群这样做。

在 Kubernetes 中，Ingress 将集群外部的 HTTP 和 HTTPS 路由暴露给集群内部的服务。入口是您环境的“前门”

![](../Images/e4f34ccf4d6c049307e14a5381b8b1d4.png)[source: [Kubernetes docs](https://kubernetes.io/docs/concepts/services-networking/ingress/)]

仔细考虑在您的入口架构中使用哪个服务器。NGINX 是一个久经考验的真正的 web 服务器，拥有保护您的服务所必需的所有安全特性。NGINX 现在为云原生 Kubernetes 环境提供了一个[入口控制器。](https://www.nginx.com/products/nginx-ingress-controller)

不过，[你可能想给特使一个眼神](https://www.envoyproxy.io/)。它是 Lyft 专门为云原生应用程序构建的开源边缘和服务代理。它解决了微服务架构中常见的可观察性和网络调试问题。特使还可以充当服务网。

作为集群的“前门”，入口服务器的选择也会影响安全性。在客户端访问您的服务之前，您可以使用它来终止来自客户端的 TLS 连接。确保包含一个密钥管理策略，包括一个[密钥管理服务](https://kubernetes.io/docs/tasks/administer-cluster/kms-provider/)或另一个安全的保险库。

请记住，对于您的 Kubernetes 集群，要像对待网络基础设施的任何其他部分一样，遵循相同的安全实践。注意 [OWASP 十大](https://owasp.org/www-project-top-ten/)和 [OWASP API 十大](https://owasp.org/www-project-api-security/)漏洞以及基于逻辑的威胁。

(提示:通过学习您的微服务应用程序的业务逻辑，可跟踪监视常见的和基于逻辑的漏洞。[在这里自己看看](https://www.traceable.ai/request-demo)。

最后，如果你为这些客户服务，确保你的入口与移动和物联网设备配合良好。

## 安装安全摄像头:保护和监控微服务通信

视频门铃和安全摄像头变得越来越普遍。房主想知道他们的房子里和周围发生了什么。

Kubernetes 集群中的安全和监控同样重要。确保微服务通信受到保护，并且知道服务之间正在发送什么请求。

考虑所有微服务之间的点对点加密。并确保 REST 和 gRPC 协议的实时 API 监控。

随着支持零信任原则的新技术的出现，零信任原则并没有变得更加流行。零信任是一种默认情况下不信任任何流量的操作模式，无论是在网络内部还是外部。

在 Kubernetes 中，实现这个模型意味着验证每个试图连接到您的服务的请求、客户机或对象。除非用户或服务帐户已经证明他们有权限执行操作，否则集群中不会发生任何事情。

零信任对于云原生安全性至关重要。在任何时候，数十或数百个服务都在试图执行操作和共享信息。零信任确保每个请求都得到验证，并且没有漏洞，因为假设内部流量是自动安全的。

## 保护你的房子

微服务和云原生架构的世界为当今的企业开启了无数机遇。但是新技术也伴随着新的危险；恶意行为者窃取敏感信息的新机会。

我们已经讨论了保护您的 Kubernetes 架构的六个基本因素:

1.选择底层平台和控制计划配置
2。检查和保护在您的环境中运行的容器
3。实现集群分区和访问控制
4。定义 pod 间通信
5。选择你的入口建筑(保护你的“前门”)
6。保护和监控您的微服务通信

考虑到这些因素，你的下一步应该是什么？

如果您已经安装了 Kubernetes，那么可以将这些因素作为小型审计。回顾一下你当前的政策，看看它们在这六个方面有多匹配。

如果你计划你的第一次 Kubernetes 安装，使用这些因素作为指导，以确保你覆盖所有的基地。与实施者会面，确保您对所有这些因素都有一个计划。

那么你的 Kubernetes 环境将成为你的微服务的快乐家园。