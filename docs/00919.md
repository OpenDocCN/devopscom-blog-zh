# 基础设施版本化

> 原文:[https://devops.com/version-your-infrastructure/](https://devops.com/version-your-infrastructure/)

[基础设施是代码](https://devops.com/2014/05/05/meet-infrastructure-code/)，和任何代码一样，你需要对它进行版本化。注意它是如何工作的:如果它是基础设施，那么它是系统的基本部分；没有它什么都不会起作用，这使得它很有价值。如此重要，以至于在全栈部署中，它是应用程序的一部分。如果是代码，那么它应该在版本控制之下。

但是作为代码的基础设施并不意味着一些你随便扔在一起处理一次性任务的批处理文件。开发和发布周期充斥着这种供应的日子已经一去不复返了。在 DevOps 中，编排脚本很复杂，你需要认真对待维护。

## **版本控制？谁需要版本控制？**

首先，我们来看看未版本化的 DevOps:

临时测试环境。 一名实习生在雪花测试机上安装了最新的二进制文件(做了一些手动配置调整)，然后测试是否修复了最后报告的一组错误。配置调整可能会也可能不会保存在某个临时文件中。也许您的测试不再那么原始，但是如果没有系统来控制您的测试环境的配置，并且没有方法来保持对每个构建的测试结果的严格跟踪，或者甚至对主测试用例文档的跟踪，那么您的测试仍然是临时的。

如果您对测试环境配置保持严格的手动控制，并将主测试用例和测试结果存储在一个标准的网络位置，您会做得更好。但是，除非给定构建的测试环境和测试用例可以在未来的某个时间点精确地重现，否则您的测试就没有完全版本化。

仅版本化的应用程序代码。makefile、编译器指令和批处理文件是各个开发人员存储它们的地方，它们被组织、命名、备份、随意覆盖或删除是基于每个开发人员认为此刻重要的事情。您可以为早期的构建重新编译源代码，但是随着时间的推移，您实际上可能无法复制急剧减少的构建。

有了完整的版本控制，精确复制构建所需的所有文件将被存储在一起。对于库和开源资源，构建中使用的版本将被记录。

**凭直觉部署。** 在未版本化的 DevOps 中，您有脚本来覆盖您的部署的一部分，但是您经常得不到承认，工件仍然是必须到处移动的手动文件。如果您确实更新了您的脚本，您不会严格跟踪更新，所以您最终会获取您希望的主部署脚本的最新版本，运行它，然后尝试找出您仍然需要进行哪些手动调整。许多关键步骤都不是照本宣科的；它们是手动的，一点也不明显。它们可能被记录在一些文本文件中，或者它们可能只作为神秘的知识而存在，只为一群特定的提升者所知，并且容易出现人为的错误。

在完全版本控制下，部署过程的每一步都是脚本化的，并且这些脚本处于正式的版本控制之下。如果脚本中的某些内容需要更改，它会存储为新版本。数据和工件可能会经常改变或者随着每次构建而改变(程序版本号、日期、更新的文件名等)。)应该从适当的位置(源代码、清单、XML 数据表等)提取。)而不是硬编码到脚本中。这意味着脚本版本变化可能代表实质性的变化，而不是瞬时数据的变化。

## **完整版本开发操作系统**

因此，将所有这些放在一起，你应该从一个完全版本化的 DevOps 基础设施中期待什么？

首先，一切都是照本宣科的。 “一切”是指“从编译应用源代码到部署和日常运营的一切”所有这些都是由脚本控制的，并且所有的脚本都是文本格式的(不仅仅是二进制的)。许多关键的 DevOps 工具大量使用脚本，当然，在你使用这些工具的程度上，你的大部分主要过程应该是脚本化的。这可能会留下各种中间步骤和支持流程。也有基于脚本的工具来涵盖所有这些任务，如果您对版本化基础设施很认真，您将需要将这些操作置于脚本控制之下。

如果一项任务只包含几个大家都知道的简单手动步骤，你为什么要这样做？即使团队中的每个人现在都知道这些步骤，也不能保证以后需要重新创建您的构建和发布过程的人会知道这些步骤。事实上，任何花了很多时间在开发、QA 或运营方面工作的人都可以讲述一些关于那些在一组指令中缺失的“人人都知道”的关键步骤的故事。

所以你编写了所有东西，包括简单、明显的步骤。当您可以通过运行脚本(或者更好的是一个主脚本)在部署后立即精确可靠地重新创建构建、部署和基础设施状态时，您将知道您已经编写了所有的脚本。

一旦编写好脚本，您需要将脚本存储在一个标准的版本控制存储库中。 你所使用的存储库取决于你(或者你的组织)，但是它应该具备完整版本控制所需的所有特性，因为你要把每一个脚本，不管它的功能看起来多么微不足道，都当作是一段重要的源代码。目标是能够像获取应用程序源代码一样获取所有的基础设施代码。

在不远的将来，诸如“我应该对我的基础设施进行版本控制吗？”将不再有意义，因为版本控制将内置于您用来管理基础设施的工具中，很难想象没有基础设施版本控制的人是如何生活的。然而，在那之前，我们都需要采取一些额外的步骤来将 DevOps 基础设施置于版本控制之下。