# 构建卓越的云安全护栏

> 原文:[https://devo PS . com/building-great-cloud-security-guardrails/](https://devops.com/building-great-cloud-security-guardrails/)

安全护栏是一种不可思议的方式，可以让我们的云部署更加安全，同时又不会降低速度。采取这种结构化的方法将减少摩擦，同时增加保护。

大约九年前，当我第一次动手从事云计算(AWS)工作时，我很快就意识到了云可以有多快多敏捷的力量和风险。有时候，作为一个乐观主义者，我认为这种能力是对我们安全能力的重大提升。当然，我可能会不小心启动暴露于互联网的服务器，但作为交换，我获得了传统基础设施中闻所未闻的集中控制和可见性。

最强大的新功能之一是利用云 API 和自动化来构建自动化安全*护栏*的能力，而不必花费大量美元来购买一个大盒子，它实际上像承诺的那样交付，但也增加了巨大的摩擦并减慢了速度。Guardrails 是不断监视您的部署、发现与期望基线的偏差，甚至可以自动修复问题的自动化工具。然而，如果设计不当，即使是云原生护栏也会有问题。我自己已经构建了相当多的云安全程序，并且与许多组织合作构建了他们的云安全程序，这里是我在这个过程中学到的一些经验和一些代码来展示它是如何工作的。

## 建造令人敬畏的护栏

我的第一个护栏在结构和功能上有点大杂烩。实际上，有很多方法可以解决这些问题。即使在今天，我也会根据我面前的特定挑战采取不同的方法，但我的大多数护栏(包括可操作护栏)都倾向于遵循一个一致的模式:

*   **定义问题:**我喜欢从定义我们想要的业务成果开始，然后转移到技术问题上。我过去常常从一个狭窄的技术问题开始解决，但发现这并不总是能让我得到正确的结果。例如，问题是我们希望阻止所有面向互联网的端口 22 访问，还是我们不希望将面向互联网的管理服务器暴露给开放的互联网，而是希望使用护栏来限制我们已知的公司 IP？这有助于防止护栏成为阻挡物。
*   **设置范围:**多个云账户(或者是你们 Azure/GCP 人的订阅/项目)现在是标准。第一步是确定你想要多宽的护栏，这也将确定一些技术规格。例如，如果您希望它应用于 Amazon Web Services 中的多个帐户，这会影响您从哪里运行它以及如何管理所需的 IAM 权限。
*   **构建或选择部署模型:**关于在哪里以及如何运行护栏，有很多技术细节。今天的示例将在单个帐户内的 AWS 中运行，但是如果您管理一个更大的企业级部署，您将需要考虑如何以及何时平衡集中式和本地化护栏。通常情况下，我更喜欢无服务器的方法(FaaS 和其他支持 PaaS)，但我也发现运行时间较长的护栏通常也需要容器。多亏了 API 网关，构建可以支持这两者的部署并不坏。
*   **定义过滤器:**您可以用 20 到 40 行代码自动关闭所有面向互联网的安全组，直到您破坏一个生产应用程序，这太棒了。过滤器允许您根据特定环境或项目需求调整护栏。基本过滤器可以处理简单的资源标签，而更复杂的过滤器可以评估包含和排除规则的组合，以获得更大的灵活性。例如，这可以将开发和生产环境与相同的护栏区别对待。
*   **确定触发器:**如今，我们在主要的云平台上拥有丰富的触发器选项。主要类别是基于时间的评估和基于事件的触发器。我倾向于两者都用，基于事件的用于确定性更强的事件(S3 存储桶策略被改变了)，基于时间的扫描用于捕捉我可能完全在事件触发时错过的条件。
*   **执行分析:**这是我们护栏的肉。根据触发器，收集我们需要的信息，结合我们的范围和过滤器，做出决策。例如，如果我们发现端口 22 对互联网开放，如果这是一个开发环境，我们可能会决定更新安全组，以限制已知的公司 IP 地址。如果是在 Prod 中，我们可能会完全删除该规则，除非它是通过经过批准流程的 CloudFormation 模板实现的。
*   **发送通知:**即使你有一个完全自动化的护栏，你也可能想要一个并行的通知。这些可以直接发送到电子邮件/短信/Slack，或者直接发送到票务系统。对于安全护栏，我也建议将其发送到您的 SIEM 或其他安全警报/管理系统。如果你喜欢，你可以把这些变成 chatOps 过程的第一步。
*   **采取行动:**行动是将护栏与过去所有恼人的警报区分开来的东西。基于分析和过滤器，操作可以是完全自动化的补救或请求人工干预。动作也可以根据条件遵循不同的路径，以便为该情况提供最佳选项。关键是，即使有人被叫去做决定，这个决定也应该是一个简单的点击来运行这个动作，这样就不用人工去解决问题了。不幸的是，我们有时仍然需要人类来做决定。另一种选择是向我们的机器人统治者低头。我想这是一种交换。
*   **验证并记录:**不要假设动作实际上做了什么。复查是至关重要的，同样重要的是记录并把结果作为第二次通知发送给票务系统/SIEM/等。我强烈建议向目标系统发送事件打开和关闭通知，即使护栏在几秒钟内就修复了一切。这保持了一致的记录，也允许你做一些漂亮的事情，比如测量你的平均解决时间，比较自动化和人工。

## 运行演示护栏

我最喜欢演示的一个护栏是自动逆转 AWS 中的安全组更改。下面是如何自己设置它并运行我的演示代码来看看它是什么样子的:

*   第一步是确保在实际调优滤波器之前，不要在生产或任何其他地方运行它，否则可能会出问题。如果你有，那不是我的错。在这种情况下，期望的结果是确保我们不会因为指定资源上未经批准的安全组更改而面临网络风险。
*   此护栏的范围是单个本地帐户，具有相应的部署模型。我们将使用 CloudTrail、CloudWatch 规则、Lambda 和 SNS。
*   在构建护栏之前，有三个准备步骤来配置您的帐户:
    *   登录 AWS 控制台并设置通知的目的地。如果你以前没有这样做过，你想使用 SNS(简单通知服务)。为安全警报创建一个主题，并订阅您希望向其发送警报的位置。我建议从简单的电子邮件订阅开始。
    *   确保您打开了 CloudTrail 并传输到 CloudWatch。对于你们这些新手来说，CloudTrail 记录了(几乎)你账户上所有的 API 调用，我们需要这个作为触发器。将日志发送到 CloudWatch 允许我们在 CloudWatch 中基于事件(比如我们将寻找的 API 调用)构建近乎实时的触发器。
    *   创建一个供 Lambda 使用的 IAM 角色。它将需要授权安全组、描述安全组和撤销安全组的权限。为了保存日志，它还需要 PutLogEvents、CreateLogStream 和 CreateLogGroup。这些也在项目存储库中的 JSON 模板中，用于剪切和粘贴。
*   准备好之后，创建一个新的 Lambda 函数(Python 2.7)并加载位于[https://github.com/disruptops/RevertSecurityGroups](https://github.com/disruptops/RevertSecurityGroups)的代码。
*   现在转到 CloudWatch Rules 并创建一个新规则。对于触发器，请使用以下内容:
    *   服务名:CloudTrail
    *   事件类型:通过 CloudTrail 的 AWS API 调用
    *   具体操作:AuthorizeSecurityGroupIngress
*   然后设置两个目标:你的 Lambda 函数和你的 SNS 安全警报主题。这将显示更改并同时向您发送通知。

![](../Images/d68dc7d0b5e3bfc2392f6efcb42120b5.png)

Screenshot of configuring the trigger in CloudWatch

这应该会恢复添加到安全组的任何新的进入规则。如果你玩代码，你也可以把它用于出口规则。这只是演示代码，它会遗漏一些边缘情况。

该代码还包括许多过滤器选项，包括:

*   局限于一个地区或者 VPC。
*   基于标记或特定安全组 ID 进行限制。
*   如果更改来自指定的 IAM 用户，则允许更改，如果更改来自其他人，则取消更改。

它自动采取行动；如果您想首先手动检查，您应该修改代码来发送通知。我们在[https://github.com/disruptops/demos-tools.](https://github.com/disruptops/demos-tools)发布了一些替代示例，其中包括一些保护 S3 的示例，也展示了如何在 Lambda 本身中嵌入通知以获得更大的灵活性。

希望这能给你一些想法来改进你自己的护栏，在快速移动的同时显著提高安全性。

— [富豪](https://devops.com/author/rmogull/)