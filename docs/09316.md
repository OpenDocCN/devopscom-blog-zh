# Libbpf Vs. BCC 促进 bpf 发展

> 原文：<https://devops.com/libbpf-vs-bcc-for-bpf-development/>

如果你对 Linux 开发感兴趣，你可能在过去几年里听说过 BPF。BPF 代表 Berkeley Packet Filter，该技术有大量的用例。BPF 应用可以深入访问操作系统，使您能够更简单轻松地执行高性能负载平衡、DDoS 缓解等任务。

Libbpf 和 BCC-Tools 都是帮助 bpf 开发的工具集。然而，这两者各有优缺点。在本指南中，您将详细了解这两个工具集，并了解何时使用它们。

## 什么是密件抄送？

[BCC](https://www.containiq.com/post/bcc-tools) 代表 BPF 编译器集合，是开发 BPF 应用最古老的方式之一。它帮助您将 BPF 代码以普通字符串的形式嵌入到用户空间程序中。当内核执行用户空间程序时，BCC 调用其嵌入式 Clang/LLVM，获取系统范围的内核头文件，并就地编译程序。

由于 BCC 在主机上编译 BPF 程序，它确保了 BPF 程序所期望的内存布局与目标主机完全相同。

BPF 程序被设计成直接注入内核，因此 BCC 工具似乎是开发 BPF 应用程序的完美解决方案。然而，在现代环境中，它们被证明是庞大的，因为它们严重依赖于 Clang/LLVM 组合，这是资源密集型的。这就需要一种更好、更现代的解决方案来开发 BPF 应用。

## 什么是 Libbpf？

[Libbpf](https://www.containiq.com/post/libbpf) 是市场上最热门的新 bpf 工具之一。它通常与 BPF CO-RE(代表编译一次，到处运行)结合使用。BPF CO-RE 使您能够生成在多个内核版本上运行的二进制文件。

Libbpf 背后的想法是使 bpf 开发尽可能地类似于其他形式的开发。借助 BPF CO-RE，Libbpf 通过将 BPF 程序编译成可以部署到多个部署主机的小二进制文件来实现这一点。Libbpf 完成安装工作，比如加载和验证程序，创建映射，连接到钩子等等。，这使开发人员能够专注于手头更关键的任务，如程序性能和正确性。

Libbpf 旨在通过减少对系统内核头文件以及运行时编译的 Clang/LLVM 库的依赖，消除与 bpf 应用程序开发和部署相关的开销。

## Libbpf 与 BCC:关键要点

现在，您已经了解了这些工具的工作原理，让我们比较一些关键的基准，以了解何时使用它们。

### 依赖性管理

BCC 依赖于需要安装在目标主机上的内核头文件包。虽然在大多数情况下这不是问题，但是如果您在多台机器上工作，那么设置和维护起来会变得很困难。

另一方面，Libbpf 通过依赖 vmheader 文件消除了这个问题。这个文件包括多种内核类型，这有助于您从系统范围的内核头中移除依赖性。

### 编译风格

对于用 BCC 编写的程序，编译发生在运行时。为了实现这一点，这样的程序要求 Clang/LLVM 出现在主机上。这增加了程序的代码量。

此外，Clang/LLVM 库是资源密集型的。完整的库需要在编译时可用并运行，即使是小程序。这可能会破坏主机上完美平衡的 BPF 工作负载。

另一方面，Libbpf 使您能够生成编译一次就可以在任何地方运行的二进制文件。您不需要在目标机器上存在任何系统范围的依赖来运行这样的应用程序。因此，它减少了整个应用程序的大小以及运行时的资源消耗。

### 误差检测

对于用 BCC 工具开发的应用程序，错误只能在运行时检测到，因为那是程序编译的时候。与使用 Libbpf 开发的应用程序相比，这导致了相当缓慢的开发体验。由于 Libbpf 支持在开发的同时进行编译，因此查找和修复 bug 变得更加容易。

## 最后的想法

在本指南中，我们向您介绍了什么是 Libbpf 和 BCC 工具，并基于应用程序开发和交付的一些重要方面对它们进行了比较。

总而言之，Libbpf 在大多数方面似乎是最好的 BCC 工具。BCC 工具提供了快速原型和实验的可能性，但是当涉及到生产部署时，与 Libbpf 相比，BCC 工具是一个相当昂贵的选择。

你可以在这里 了解更多关于为什么密件抄送成为流行的选择以及它最终如何被 Libbpf [所取代的信息。即使你目前正在使用密件抄送工具，你也可以通过几个简单的步骤轻松地将](https://nakryiko.com/posts/bpf-portability-and-co-re/) [迁移到 Libbpf](https://facebookmicrosites.github.io/bpf/blog/2020/02/20/bcc-to-libbpf-howto-guide.html%23why-libbpf-and-bpf-co-re) 。而且，在大多数情况下，为了获得更好的开发体验和应用程序性能，选择 Libbpf 比 BCC 工具更好。