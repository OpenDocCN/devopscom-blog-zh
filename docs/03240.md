# 使用 NPM 注册中心加快 NPM 的发布速度并增强信心

> 原文:[https://devo PS . com/speed-NPM-releases-and-gain-confidence-using-an-NPM-registry/](https://devops.com/speed-npm-releases-and-gain-confidence-using-an-npm-registry/)

在 NPM 开发生命周期中构建应用程序可能非常复杂。让我们回顾一下造成这种复杂性的主要因素:

*   **无穷无尽的变量:**构建应用程序涉及到大量的变量。在 package.json 中不仅有本地安装的依赖项([应该为每个依赖项](https://devcenter.heroku.com/articles/node-best-practices#use-a-smart-npmrc)使用绝对版本)，还有环境变量和全局系统设置。
*   跨越多个构建的不同环境:在构建之间保持相同的环境可能变得不可能，尤其是在大型项目中。即使两个版本使用相同的主机，两个版本之间的本地系统更改也会对发布的包产生巨大的影响。此外，主从式持续集成(CI)过程使这个问题变得更加复杂。
*   **对你的二进制文件缺乏信任:**当你在一个应用程序中引入一个内部包时，你需要确信你正在使用的二进制文件已经过彻底的测试。否则，当他们的项目失败时，这将是你第一个被责备的对象。

在这篇博文中，我将向您展示在 npm 构建过程中应用的最佳实践，通过使用 npm 注册表来确保相同的二进制文件通过 QA 并进入生产存储库。

## 简化您的 NPM 质量保证到发布渠道

![](../Images/bb1e67ea31341dd203488a0fb75cba2c.png)

在创建简化的管道之前，您需要进行以下设置:

*   [推荐用于二进制管理的存储库管理器](https://jfrog.com/artifactory/)。
*   一个自动化的构建服务器，例如 [Jenkins](https://jenkins.io/) 。
*   将试运行和发布环境配置为类似于生产环境的站点主机，在生产环境中，可以根据 QA 团队的要求执行自动加载和质量测试。
*   npm 项目。

### 第一阶段:软件开发

在开发过程中，运行一个自动化的 QA 周期，以确保二进制文件在这个阶段合格。

### 阶段 2:源代码部署

在这一阶段，完成函数并将其合并到您的 Git 分支。这将触发 Jenkins npm 安装来构建软件包。

### 阶段 3: CI 服务器获取依赖关系

当您运行“npm install”命令时，CI 服务器会提取依赖关系。

**注意:**为了简化项目，使用一个**二进制库管理器**来存储项目中使用的准确的二进制依赖项。

### 阶段 4:将二进制文件部署到目标二进制存储库

运行“npm deploy”命令会导致 CI 服务器将生成的二进制文件部署到目标二进制文件存储库管理器存储库。

请注意，在这个阶段，二进制文件未经测试，并被标记为“快照”版本。由于该包未经测试，所以应该将它转移到非生产“快照”或“暂存”存储库中，在那里开发人员可以使用这些包，但要自担风险。

### 阶段 5:对包运行第二轮自动化 QA

我建议在开发阶段之外执行第二轮自动化 QA，以确保软件包通过这个阶段。

如果包通过了上述测试，它就有资格进入登台环境。同一个包从快照模式“升级”到转移模式。在应用程序成功满足预期的基本功能后，可以将其部署到试运行环境中。

### 阶段 6:将包部署到临时环境中

这通常是开发分裂发生的地方。

一个常见的不良做法是在应用程序通过 QA 之后重新构建应用程序，产生一个不同于原始包的新的二进制文件。我建议在升级到后面的构建步骤时使用相同的. tar.gz。

执行任何 QA 脚本，这可能因项目而异。在试运行环境中运行的测试应该密切反映真实的环境。这也可以包括测试和手动测试。

继续移动提取的二进制“暂存”存储库。

### 阶段 7:将包部署到发布库

同样，在这个阶段，使用相同的源代码在不同的环境中重新构建相同的包是不好的做法。

最终将使用这个包的开发人员需要确保它是通过了整轮测试的同一个包。否则，如果他们的应用程序因为使用这个包而失败，你将是受责备的人。

万岁！您的 npm 注册表已启动并正在运行。

npm registry DevOps 管道现在通过在整个过程中使用相同的二进制文件而得到简化。总之，以下是创建 npm 注册表时建议遵循的最佳实践:

*   确保构建的完全相同的二进制文件通过整个过程。
*   指导项目开发人员为存储库提供[有意义的名称。比如:“快照”=未测试。](https://jfrog.com/blog/the-significance-of-names/)
*   不要重新上传已经测试过的二进制文件。测试可以修改底层的二进制文件，并有意想不到的变化。

尝试使用我的定制项目作为示例框架来创建您自己的 npm 注册表:

*   [一个 NPM 项目，提取依赖项并构建一个完整的. tar.gz 包](https://github.com/patbat95008/NPMHelloWorld)
*   [用于构建应用的 Jenkins CI 管道脚本](https://github.com/patbat95008/npmJenkinsPipeline/blob/master/Jenkinsfile-build-publish)
*   [一个 Jenkins CI 脚本，用于将包升级到 QA /暂存库](https://github.com/patbat95008/npmJenkinsPipeline/blob/master/Jenkinsfile-Promote)

帕特里克·拉塞尔