# 云环境的深度扩展艺术，第 1 部分

> 原文：<https://devops.com/deep-art-scaling-cloud-environments-part-1/>

用于扩展应用程序的资源很多，但是每个应用程序都有自己的成功扩展挑战，并且这个问题的解决方案并不方便。这篇由两部分组成的文章主要关注构建可伸缩应用程序、软件即服务(SaaS)应用程序、移动应用程序或基于 WordPress、Drupal 或 Magento 的网站的最佳方法。该方法的范围扩展到自动缩放和手动缩放。

根据我的经验，有两种类型的应用程序:一种使用管理和管理面板来修改代码、布局和功能(WordPress、Joomla、Drupal 等)。)和现代的下一代无状态应用程序，它们遵循 [12 因素应用程序方法](https://12factor.net/)。

但是首先，我们必须决定是使用自动缩放还是手动缩放。这是一开始就要做出的重要决定，因为它改变了开发应用程序的整个方法和复杂性。我们将讨论这两者，但本质上是**自动缩放，**你将需要考虑如何在 web 节点之间保持代码同步，以及如何在自动缩放组中维护不断创建/删除的新 web 节点。(对于无状态应用，这不是问题，因为图像或静态内容可以进入亚马逊 S3、CDN 或独立服务。稍后我会解释一下这些技术。)使用手动缩放将有助于您的工作——您只需要在所有 web 节点上同步您的代码。下面提到的所有方法都适用于手动缩放。

但是另一方面，由于一些常见的原因，管理应用程序的自动伸缩是一件令人头痛的事情:每次前端开发人员在管理中更改某些东西时，代码就会随着 Git 版本控制在多个 web 节点之间不一致。由于这个问题，我不建议对这样的应用程序使用 Git——Git 中的最后一次提交/版本和 admin CMS 中的最后一次更新之间总是存在差异，这使得使用 admin 进行自动伸缩变得更加复杂。

让我们来看看解决这个问题的一些方法。使用 NFS 分布式文件系统可以解决 CMS 应用程序的所有问题，但是众所周知，这种方法会降低性能。

**缩放的重要因素:** 

*   为您的团队、您的经理和开发人员设计一个简单的部署工作流，这就是您在这里的原因，通过定义一个良好的机制将代码部署到您的集群或自动扩展组来提高开发效率。在这里，你可以想到 Webhooks、rsync cronjob、bash scripts、Jenkins、CircleCI、DeployBot、manual pulls 或者 AWS CodeDeploy。

*   隔离和集中所有服务。数据库、缓存会话、针对静态内容集成 s3、实施 CDN、工作服务器、cronjobs、负载平衡器、应用服务器、web 服务器等。，不一而足。

*   在一个负载平衡器或 AWS 自动扩展组后面的许多 web 节点中动态同步实时应用程序中的代码。

*   能够对下一代应用程序或无状态应用程序使用 12 因素方法。你可能已经在使用这种方法，但你并不知道！

*   用一种无状态的方法引导你的应用程序——当你实现一个可伸缩的基础设施时，这将有助于你的所有工作。使用 bash 脚本、docker 文件、vagger 文件、AWS code deploy、git、来自 AWS 和 baked AWS AMI 的用户数据文件等等，有许多方法可以引导您的基础应用程序。

*   在您的环境中使用不可变的服务器。确保您的应用程序和服务器处于预先配置的映像状态。每当在自动扩展机制中创建一个新的服务器/实例时，该实例都应该与生产中的任何其他实例完全相同地克隆，而无需任何进一步的配置。如你所知，AWS、Docker、Google Cloud 和基于云的提供商更容易实现不变性。这确实有助于更快地交付软件并缩短上市时间。

*   对于基于 CMS 的应用程序，暂时不要使用 git，除非你对 CMS 管理员有很好的代码更改控制，并且有很好的纪律来推动 CMS 中每个仪表板/后端的更改。

*   用于自动扩展的负载平衡器，如 AWS ELB、Google Cloud LB、Nginx 或 HAProxy。

## 代码存储的建议实践

从访问者如何动态改变应用程序数据的角度来理解应用程序的工作方式是非常重要的。必须理解会话是如何保存的，是在本地还是在 Redis/Memcached 中。如果数据保存在本地，您需要将这些数据添加到您的同步机制中。另一个存储方面的变化是 WordPress 或 Magento 之类的基于 CMS 的网站的用户图片上传；使用 Wp super cache 或 w3 total cache 等插件可以简化图像上传配置。此外，与 CDN、Amazon s3 或云存储集成的选项进一步拓展了界限。

但是如果你有一个现代化的应用程序，你需要理解并指导你的开发团队如何改变本地图像上传路径到云存储或 CDN。确保您的所有动态数据都保存在 SQL 或 NoSQL 数据库中，并且所有缓存的数据库数据(db 查询、对象、会话、键等。)保存到 redis/memcached，考虑这些因素将有助于您的扩展之旅。

## 为什么不用 NFS 呢？

嗯，我们在互联网上经常听说，实现可伸缩性的最简单方法是集成 NFS。虽然这是寻找和实现修复的最简单的方法，将服务提供商/开发人员的工作减少了近 50 %,但就应用程序性能而言，这是一种真正的牺牲。自动扩展一个响应缓慢的环境违背了设置的整体原因！对于一个应用程序速度只有 1 秒到 2 秒的客户来说，当切换到一个带有 NFS 的可伸缩环境时，应用程序的速度至少会降低 50 %,这是非常令人恼火的。

当您的小型 EC2 实例比使用 NFS 的自动可伸缩环境快得多时，这也非常令人失望。此外，使用 NFS 有一个故障点，除非您在云中有一个很少使用的故障转移。让一个完整的备用环境等待故障是不值得的，最好在您的集群中使用这个环境，并有更多的资源来消耗您的流量，或者更好地使用这个冗余环境来平衡不同区域或数据中心。

## 为什么不用亚马逊 S3 共享代码？

使用亚马逊 S3、谷歌云文件或任何云存储来共享代码怎么样？

实现亚马逊 S3 在节点间共享代码会让你的网站变慢，类似于 NFS。访问 S3 URL 和将 S3 挂载到 Linux 目录没有太大区别，所以不要使用亚马逊 S3 作为文档根或代码库文件夹。将 S3 的使用限制在需要随时获取的静态内容上。是的，有一些网站可以使用亚马逊 S3 的静态网页来生存和体面地工作，但从我的经验来看，我不建议支持一个负责为公司带来收入的应用程序的网站使用它。

敬请关注我们关于云环境扩展的第二部分。

## 关于作者/阿方索·巴尔德斯

![alfonsovaldes](img/bf5c1cc2140e70a5c792b8948237a7db.png) Alfonso Valdes 是 [ClickIT Smart Technologies](https://www.clickittech.com/) 的首席执行官和创始人，这是一家专注于在 Linux 和开源技术中高度灵活的现代云应用程序的架构和实施的 IT 机构。他在可扩展架构、分布式系统和开发云原生应用领域拥有超过 8 年的 IT 经验，曾在多家美国公司工作过，例如:Sprint Nextel、德州仪器和 Nike USA。如今，他鼓励企业加入云计算。在 [LinkedIn](https://mx.linkedin.com/in/alfonso-valdes-75a55714) 上与他联系。